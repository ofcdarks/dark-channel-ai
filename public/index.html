<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darks Vips AI v15.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .sidebar-btn { transition: all 0.2s ease-in-out; }
        .sidebar-btn:hover { background-color: #f1f5f9; color: #334155; }
        .sidebar-btn-active { background-color: #eef2ff; color: #4f46e5; font-weight: 600; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar-container { background-color: #e0e7ff; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-bar-inner { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
        .progress-bar-indeterminate { background-size: 200% 100%; background-image: linear-gradient(to right, #e0e7ff 0%, #c7d2fe 50%, #e0e7ff 100%); animation: move-bg 2s linear infinite; }
        @keyframes move-bg { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        #login-container { display: flex; }
        #register-container, #app-container, #progress-modal { display: none; }
        .prose { max-width: none; }
        .copy-btn.copied { background-color: #10b981; color: white; }
        .app-title {
            background: linear-gradient(45deg, #4f46e5, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 10px rgba(79, 70, 229, 0.2);
        }
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            #app-container { flex-direction: column; }
            #sidebar { 
                position: fixed;
                left: -100%;
                top: 0;
                height: 100%;
                z-index: 40;
                transition: left 0.3s ease-in-out;
                width: 288px; /* w-72 */
            }
            #sidebar.open { left: 0; }
            #main-content { margin-left: 0; }
            #menu-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 30;
            }
        }
    </style>
</head>
<body class="text-slate-800" oncontextmenu="return false;">

    <!-- Telas de Autenticação -->
    <div id="login-container" class="flex items-center justify-center h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <div>
                <h2 class="text-3xl font-extrabold text-center text-slate-900 app-title">Darks Vips AI</h2>
                <p class="mt-2 text-center text-sm text-slate-600">Faça login para continuar</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div id="login-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <input id="login-email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Endereço de e-mail">
                    <input id="login-password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Senha">
                </div>
                <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Entrar</button>
            </form>
            <p class="text-center text-sm">Não tem uma conta? <a href="#" id="show-register" class="font-medium text-indigo-600 hover:text-indigo-500">Registre-se</a></p>
        </div>
    </div>
    <div id="register-container" class="hidden items-center justify-center h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <div>
                <h2 class="text-3xl font-extrabold text-center text-slate-900">Criar Conta</h2>
                <p class="mt-2 text-center text-sm text-slate-600">Junte-se à plataforma</p>
            </div>
            <form id="register-form" class="mt-8 space-y-6">
                <div id="register-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <input id="register-email" type="email" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Seu melhor e-mail">
                    <input id="register-password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Crie uma senha forte">
                </div>
                <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Criar Conta</button>
            </form>
            <p class="text-center text-sm">Já tem uma conta? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">Faça login</a></p>
        </div>
    </div>

    <!-- Modal de Progresso -->
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h3 class="text-lg font-semibold text-slate-800 mb-2">Processando...</h3>
            <p id="progress-phrase" class="text-sm text-slate-600 mb-4">Otimizando para o algoritmo...</p>
            <div class="w-full bg-slate-200 rounded-full h-2.5"><div class="h-2.5 rounded-full progress-bar-indeterminate"></div></div>
        </div>
    </div>

    <!-- Conteúdo da Aplicação -->
    <div id="app-container" class="hidden h-screen bg-slate-50">
        <div id="menu-overlay" class="hidden md:hidden"></div>
        <aside id="sidebar" class="w-72 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                <h1 class="text-2xl font-bold text-slate-900 app-title">Darks Vips AI</h1>
                <button id="close-menu-btn" class="md:hidden text-2xl">&times;</button>
            </div>
            <div class="p-4 text-sm text-slate-500" id="user-email-display"></div>
            <nav id="sidebar-nav" class="p-4 space-y-1 flex-1 overflow-y-auto"></nav>
            <div class="p-4 border-t">
                <button id="logout-btn" class="w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-red-50 hover:text-red-700">
                    <span>🚪</span><span>Sair</span>
                </button>
            </div>
        </aside>
        <div id="main-content" class="flex-1 flex flex-col overflow-hidden">
            <header class="p-4 md:hidden bg-white border-b flex items-center">
                <button id="open-menu-btn" class="text-2xl">☰</button>
                <h2 id="mobile-header-title" class="ml-4 font-semibold text-lg">Dashboard</h2>
            </header>
            <main id="tab-content" class="flex-1 p-6 md:p-10 overflow-y-auto"></main>
        </div>
    </div>

    <script>
    // --- Global State Management ---
    let appState = {
        currentUser: null,
        apiKeys: { gemini: "", openai: "", google_api: "" },
        userChannels: [],
        videoIdeas: []
    };

    // --- Constants ---
    const ELEMENTS = {
        loginContainer: document.getElementById('login-container'),
        registerContainer: document.getElementById('register-container'),
        appContainer: document.getElementById('app-container'),
        loginForm: document.getElementById('login-form'),
        registerForm: document.getElementById('register-form'),
        loginFeedback: document.getElementById('login-feedback'),
        registerFeedback: document.getElementById('register-feedback'),
        showRegister: document.getElementById('show-register'),
        showLogin: document.getElementById('show-login'),
        sidebar: document.getElementById('sidebar'),
        sidebarNav: document.getElementById('sidebar-nav'),
        tabContent: document.getElementById('tab-content'),
        progressModal: document.getElementById('progress-modal'),
        progressPhrase: document.getElementById('progress-phrase'),
        userEmailDisplay: document.getElementById('user-email-display'),
        logoutBtn: document.getElementById('logout-btn'),
        openMenuBtn: document.getElementById('open-menu-btn'),
        closeMenuBtn: document.getElementById('close-menu-btn'),
        menuOverlay: document.getElementById('menu-overlay'),
        mobileHeaderTitle: document.getElementById('mobile-header-title'),
    };

    const PROGRESS_PHRASES = [ "Decodificando o algoritmo...", "Buscando insights virais...", "Consultando os dados de tendência...", "Polindo as palavras-chave...", "Ajustando o potencial de clique..." ];

    // --- API Communication ---
    async function apiRequest(endpoint, method, body = null) {
        const options = { 
            method, 
            headers: { 
                'Content-Type': 'application/json',
                'x-user-id': appState.currentUser?.id
            } 
        };
        if (body) options.body = JSON.stringify(body);
        const response = await fetch(endpoint, options);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Ocorreu um erro.');
        }
        const contentType = response.headers.get("content-type");
        return contentType?.includes("application/json") ? response.json() : null;
    }

    // --- Authentication ---
    function showLoginScreen() {
        ELEMENTS.registerContainer.style.display = 'none';
        ELEMENTS.loginContainer.style.display = 'flex';
    }

    function showRegisterScreen() {
        ELEMENTS.loginContainer.style.display = 'none';
        ELEMENTS.registerContainer.style.display = 'flex';
    }

    async function handleLogin(e) {
        e.preventDefault();
        ELEMENTS.loginFeedback.textContent = '';
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            const user = await apiRequest('/api/login', 'POST', { email, password });
            appState.currentUser = user;
            await initializeApp();
        } catch (error) {
            ELEMENTS.loginFeedback.textContent = error.message;
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        ELEMENTS.registerFeedback.textContent = '';
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        try {
            await apiRequest('/api/register', 'POST', { email, password });
            const user = await apiRequest('/api/login', 'POST', { email, password });
            appState.currentUser = user;
            await initializeApp();
        } catch (error) {
            ELEMENTS.registerFeedback.textContent = error.message;
        }
    }
    
    function handleLogout() {
        appState = { currentUser: null, apiKeys: { gemini: "", openai: "", google_api: "" }, userChannels: [], videoIdeas: [] };
        ELEMENTS.appContainer.style.display = 'none';
        showLoginScreen();
        document.getElementById('login-form').reset();
    }

    // --- App Initialization ---
    async function initializeApp() {
        if (!appState.currentUser) return;
        
        try {
            const settings = await apiRequest(`/api/settings/${appState.currentUser.id}`, 'GET');
            if (settings && Object.keys(settings).length > 0) {
                appState.apiKeys = { ...appState.apiKeys, ...settings };
                appState.userChannels = settings.userChannels || [];
                appState.videoIdeas = settings.videoIdeas || [];
            }
        } catch(error) {
            console.error("Não foi possível carregar as configurações:", error.message);
        }

        ELEMENTS.userEmailDisplay.textContent = appState.currentUser.email;
        ELEMENTS.loginContainer.style.display = 'none';
        ELEMENTS.registerContainer.style.display = 'none';
        ELEMENTS.appContainer.style.display = 'flex';
        
        buildSidebar();
        renderTabContent('dashboard');
    }

    // --- UI Building ---
    function buildSidebar() {
        const navItems = [
            { id: 'dashboard', icon: '📈', label: 'Dashboard' },
            { type: 'divider', label: 'PESQUISA' },
            { id: 'niche-finder', icon: '🔎', label: 'Localizador de Nichos' },
            { id: 'subniche-finder', icon: '💎', label: 'Explorador de Subnichos' },
            { id: 'niche-analysis', icon: '📊', label: 'Análise de Nicho' },
            { id: 'video-optimizer', icon: '🚀', label: 'Analisador de Vídeo' },
            { type: 'divider', label: 'CRIAÇÃO' },
            { id: 'title-structures', icon: '🏗️', label: 'Estruturas de Títulos' },
            { id: 'script-writer', icon: '📜', label: 'Criador de Roteiros' },
            { id: 'visual-storyboard', icon: '🎬', label: 'Storyboard Visual' },
            { id: 'thumbnail-prompts', icon: '🎨', label: 'Prompts de Thumbnail' },
            { type: 'divider', label: 'OTIMIZAÇÃO' },
            { id: 'description-optimizer', icon: '📄', label: 'Otimizador de Descrição' },
            { id: 'tag-generator', icon: '🏷️', label: 'Gerador de Tags' },
            { type: 'divider', label: 'GERENCIAMENTO' },
            { id: 'channel-organizer', icon: '📺', label: 'Organizador de Canais' },
            { id: 'planner', icon: '🗓️', label: 'Planejador de Conteúdo' },
            { id: 'settings', icon: '⚙️', label: 'Configurações' },
        ];

        ELEMENTS.sidebarNav.innerHTML = navItems.map(item => {
            if (item.type === 'divider') {
                return `<div class="pt-2 mt-2 border-t"><span class="px-4 text-xs font-semibold text-slate-400">${item.label}</span></div>`;
            }
            return `<button class="sidebar-btn ${item.id === 'dashboard' ? 'sidebar-btn-active' : ''} w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg" data-tab="${item.id}"><span>${item.icon}</span><span>${item.label}</span></button>`;
        }).join('');
    }
    
    // --- Utility Functions ---
    const showProgressModal = () => { ELEMENTS.progressModal.style.display = 'flex'; ELEMENTS.progressPhrase.textContent = PROGRESS_PHRASES[Math.floor(Math.random() * PROGRESS_PHRASES.length)]; };
    const hideProgressModal = () => { ELEMENTS.progressModal.style.display = 'none'; };
    const getScoreColor = (score) => score >= 80 ? 'bg-green-500' : score >= 50 ? 'bg-yellow-500' : 'bg-red-500';
    const getScoreTextColor = (score) => score >= 80 ? 'text-green-500' : score >= 50 ? 'text-yellow-500' : 'text-red-500';
    const createCopyButton = (text) => `<button class="copy-btn text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded hover:bg-slate-300" data-copy-text="${encodeURIComponent(text)}">Copiar</button>`;
    
    const renderScoreCard = (title, mainScore, subScores, suggestion, isNovel = false) => {
        const intMainScore = Math.round(Math.min(100, mainScore || 0));
        const novelBadge = isNovel ? '<span class="inline-flex items-center rounded-md bg-purple-100 px-2 py-1 text-xs font-medium text-purple-700">✨ Inédita</span>' : '';
        const subScoresHtml = Object.entries(subScores).map(([key, value]) => {
            const cappedValue = Math.min(100, Math.round(value || 0));
            return `
            <div class="mb-2">
                <div class="flex justify-between items-center text-sm mb-1"><span class="text-slate-600">${key}</span><span class="font-semibold text-slate-700">${cappedValue}/100</span></div>
                <div class="progress-bar-container"><div class="progress-bar-inner ${getScoreColor(cappedValue)}" style="width: ${cappedValue}%;"></div></div>
            </div>`;
        }).join('');
        return `<div class="bg-white p-4 rounded-lg border w-full md:w-72 flex-shrink-0">
                    <h4 class="font-semibold text-slate-800 mb-2">${title}</h4>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-baseline gap-1">
                            <span class="text-3xl font-bold ${getScoreTextColor(intMainScore)}">${intMainScore}</span>
                            <span class="text-slate-500 text-sm">/ 100</span>
                        </div>
                        ${novelBadge}
                    </div>
                    ${subScoresHtml}
                    ${suggestion ? `<p class="text-xs text-slate-500 mt-4"><strong class="text-slate-600">A Virada de Chave:</strong> ${suggestion}</p>` : ''}
                </div>`;
    };

    // --- Gemini API Call ---
    async function callGenerativeAPI(prompt, schema = null, retries = 3, delay = 1000) {
        const geminiKey = appState.apiKeys.gemini || "";
        if (!geminiKey) {
            throw new Error("Chave da API Gemini não encontrada. Por favor, adicione-a nas Configurações.");
        }
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiKey}`;
        let payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        
        if (schema) {
            payload.generationConfig = { 
                response_mime_type: "application/json",
                response_schema: schema
            };
        }

        showProgressModal();
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000); // Increased timeout to 60s
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });
            clearTimeout(timeoutId);

            if (!response.ok) {
                const errorBody = await response.json();
                if (retries > 0 && response.status === 429) {
                    await new Promise(res => setTimeout(res, delay));
                    return callGenerativeAPI(prompt, schema, retries - 1, delay * 2);
                }
                throw new Error(`Erro na API: ${response.status} - ${errorBody.error?.message || 'Verifique sua chave de API.'}`);
            }
            const result = await response.json();
            
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                const text = result.candidates[0].content.parts[0].text;
                return schema ? JSON.parse(text) : { text };
            }

            if (result.candidates?.[0]?.finishReason === 'SAFETY') throw new Error("A resposta foi bloqueada por políticas de segurança.");
            throw new Error("Resposta da API inválida ou vazia.");
        } catch (error) {
            console.error("Erro detalhado na API:", error);
            if (error.name === 'AbortError') throw new Error("A requisição da API excedeu o tempo limite.");
            throw error;
        } finally {
            hideProgressModal();
        }
    }
    
    // --- Tools and Handlers ---
    let trendsChartInstance = null;
    const tools = {
        "dashboard": { title: "Dashboard de Performance", desc: "Selecione um canal para ver as métricas e obter insights da IA.", content: `<div id="dashboard-container"></div>` },
        "niche-finder": { 
            title: "Localizador de Nichos", 
            desc: "Encontre nichos e tendências de mercado com estimativas de RPM.", 
            content: `<div class="bg-white p-6 rounded-xl shadow-sm border">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="niche-keyword" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Palavra-chave (opcional)">
                            <select id="niche-country" class="w-full px-4 py-3 bg-slate-100 border rounded-lg">
                                <option value="BR">Brasil</option><option value="US">EUA</option><option value="PT">Portugal</option><option value="ES">Espanha</option><option value="DE">Alemanha</option><option value="FR">França</option><option value="GB">Reino Unido</option><option value="JP">Japão</option>
                            </select>
                        </div>
                        <button id="generate-niches" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🔎 Encontrar Nichos</button>
                        <div id="output" class="mt-6"></div>
                        <button id="generate-more-niches" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button>
                      </div>` 
        },
        "subniche-finder": { 
            title: "Explorador de Subnichos", 
            desc: "Descubra subnichos inexplorados a partir de um nicho principal.", 
            content: `<div class="bg-white p-6 rounded-xl shadow-sm border">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="main-niche" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nicho principal (ou deixe em branco)">
                            <select id="subniche-country" class="w-full px-4 py-3 bg-slate-100 border rounded-lg">
                                <option value="BR">Brasil</option><option value="US">EUA</option><option value="PT">Portugal</option><option value="ES">Espanha</option><option value="DE">Alemanha</option><option value="FR">França</option><option value="GB">Reino Unido</option><option value="JP">Japão</option>
                            </select>
                        </div>
                        <button id="find-subniches" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">💎 Explorar Subnichos</button>
                        <div id="output" class="mt-6"></div>
                        <button id="generate-more-subniches" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button>
                      </div>` 
        },
        "niche-analysis": { title: "Análise de Nicho (RPM/Hype)", desc: "Analise o potencial de um nicho específico.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="analysis-niche" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nicho a ser analisado"><select id="analysis-country" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="BR">Brasil</option><option value="US">EUA</option><option value="PT">Portugal</option><option value="ES">Espanha</option><option value="DE">Alemanha</option><option value="FR">França</option></select></div><button id="analyze-niche" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">📊 Analisar Nicho</button><div id="output" class="mt-6"></div></div>` },
        "video-optimizer": { title: "Analisador de Vídeo (URL)", desc: "Otimize títulos, descrições e tags a partir de uma URL do YouTube.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="url" id="video-url" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="https://www.youtube.com/watch?v=..."><button id="analyze-video" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🚀 Otimizar Vídeo</button><div id="output" class="mt-6"></div></div>` },
        "title-structures": { title: "Estruturas de Títulos Virais", desc: "Gere estruturas de títulos com alto potencial de clique.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="structure-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Tópico. Ex: Produtividade"><select id="structure-lang" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="pt-BR">Português</option><option value="en-US">Inglês</option><option value="es-ES">Espanhol</option></select></div><button id="generate-structures" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🏗️ Gerar Estruturas</button><div id="output" class="mt-6 space-y-4"></div><button id="generate-more-structures" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button></div>` },
        "script-writer": { title: "Criador de Roteiros", desc: "Gere roteiros com foco em alta retenção.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="space-y-4"><input type="text" id="script-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Tópico do Vídeo"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="number" id="script-duration" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Duração (minutos)"><input type="number" id="script-parts" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nº de Partes"></div><div class="flex items-center"><input id="script-narration-only" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="script-narration-only" class="ml-2 block text-sm text-gray-900">Apenas Narração (sem diálogos)</label></div><button id="generate-script" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">📜 Gerar Roteiro</button></div><div id="output" class="mt-6"></div></div>` },
        "visual-storyboard": { title: "Storyboard Visual", desc: "Transforme seu roteiro em um guia de cenas e visuais.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><textarea id="storyboard-script" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" rows="8" placeholder="Cole seu roteiro aqui..."></textarea><button id="generate-storyboard" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🎬 Criar Storyboard</button><div id="output" class="mt-6"></div></div>` },
        "thumbnail-prompts": { title: "Prompts de Thumbnail", desc: "Gere prompts otimizados para IAs de imagem.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="space-y-4"><input type="text" id="thumb-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Título do Vídeo"><select id="thumb-platform" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="Midjourney">Midjourney</option><option value="Leonardo.AI">Leonardo.AI</option><option value="DALL-E 3">DALL-E 3</option><option value="Freepik">Freepik</option></select></div><button id="generate-prompts" class="w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🎨 Gerar Prompts</button><div id="output" class="mt-6 space-y-4"></div><button id="generate-more-prompts" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button></div>` },
        "description-optimizer": { title: "Otimizador de Descrição", desc: "Crie descrições com SEO e CTAs eficazes.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="desc-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="Título do Vídeo"><textarea id="desc-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" rows="4" placeholder="Resumo do vídeo e palavras-chave..."></textarea><button id="generate-description" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">📄 Gerar Descrição</button><div id="output" class="mt-6"></div></div>` },
        "tag-generator": { title: "Gerador de Tags", desc: "Gere tags relevantes para maximizar o alcance.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="tag-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Tópico do Vídeo"><select id="tag-lang" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="pt-BR">Português</option><option value="en-US">Inglês</option><option value="es-ES">Espanhol</option></select></div><button id="generate-tags" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🏷️ Gerar Tags</button><div id="output" class="mt-6"></div></div>` },
        "channel-organizer": { title: "Organizador de Canais", desc: "Adicione e gerencie as informações e estratégias dos seus canais.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border mb-6"><h3 class="text-lg font-semibold mb-4">Adicionar Novo Canal</h3><form id="channel-form" class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="org-channel-name" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nome do Canal" required><input type="text" id="org-channel-niche" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nicho Principal" required><select id="org-channel-lang" class="px-4 py-3 bg-slate-100 border rounded-lg"><option value="pt-BR">Português (BR)</option><option value="en-US">Inglês (US)</option><option value="es-ES">Espanhol (ES)</option></select><input type="number" id="org-videos-week" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Vídeos por Semana" required><input type="text" id="org-post-time" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Horário de Postagem. Ex: 18:00"><input type="number" id="org-backlog-qty" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Qtd. de Vídeos no Backlog"><button type="submit" class="md:col-span-2 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Adicionar Canal</button></form></div><div id="organizer-output" class="space-y-4"></div>` },
        "planner": { title: "Planejador de Conteúdo", desc: "Organize suas ideias de vídeo e acompanhe seu progresso.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border mb-6"><h3 class="text-lg font-semibold mb-4">Adicionar Nova Ideia</h3><form id="planner-form" class="space-y-4"><select id="planner-channel-select" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" required><option value="">Selecione um Canal</option></select><input type="text" id="idea-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Título da ideia de vídeo" required><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Adicionar ao Planejamento</button></form></div><div id="planner-output" class="space-y-4"></div>` },
        "settings": { 
            title: "Configurações", 
            desc: "Gerencie suas chaves de API.", 
            content: `<div class="bg-white p-6 rounded-xl shadow-sm border space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold">Chaves de API</h3>
                            <div class="space-y-4 mt-2">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Gemini API Key</label>
                                    <input type="password" id="gemini-key" class="mt-1 block w-full px-3 py-2 border rounded-md">
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-indigo-600 hover:underline">Obter chave do Google AI Studio</a>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">OpenAI API Key (Opcional)</label>
                                    <input type="password" id="openai-key" class="mt-1 block w-full px-3 py-2 border rounded-md">
                                    <a href="https://platform.openai.com/api-keys" target="_blank" class="text-xs text-indigo-600 hover:underline">Obter chave da OpenAI</a>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Google API Key (YouTube Data)</label>
                                    <input type="password" id="google-api-key" class="mt-1 block w-full px-3 py-2 border rounded-md">
                                    <p class="text-xs text-slate-500 mt-1">Usada para buscar dados de canais e vídeos do YouTube.</p>
                                    <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-xs text-indigo-600 hover:underline">Obter chave do Google Cloud (com YouTube Data API v3 ativada)</a>
                                </div>
                            </div>
                        </div>
                        <div class="border-t pt-4">
                            <h4 class="text-md font-semibold">Outras Integrações</h4>
                            <p class="text-sm text-slate-600 mt-2">A integração com o <strong>Google Trends</strong> é feita diretamente e não requer uma chave de API separada.</p>
                        </div>
                        <button id="save-settings" class="w-full bg-indigo-800 text-white font-bold py-3 px-4 rounded-lg mt-6">Salvar Configurações</button>
                        <div id="settings-feedback" class="mt-4 min-h-[20px]"></div>
                      </div>` 
        },
    };
    
    // --- Handlers (Lógica das Ferramentas) ---
    const handlers = {
        'generate-niches': async (output, append = false) => {
            const keyword = document.getElementById('niche-keyword').value || 'tópicos em alta';
            const country = document.getElementById('niche-country').value;
            const prompt = `Como um especialista em YouTube, gere 3 nichos promissores sobre '${keyword}' para o país ${country}. Foque em oportunidades com baixa concorrência. Para cada nicho, forneça uma sugestão estratégica que seja uma "virada de chave" e uma estimativa de RPM em dólares americanos.`;
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        niche_name: { type: "STRING" },
                        description: { type: "STRING" },
                        unexplored_subniches: { type: "ARRAY", items: { type: "STRING" } },
                        rpm_estimate_value: { type: "NUMBER", description: "Estimativa de RPM em dólares, ex: 5.50" },
                        scores: {
                            type: "OBJECT",
                            properties: {
                                Potencial: { type: "NUMBER", description: "Pontuação de potencial (70-95, >90 é raro)." },
                                Concorrência: { type: "NUMBER", description: "Pontuação de concorrência (10-60)." },
                                "Volume de Busca": { type: "NUMBER", description: "Pontuação de volume de busca (60-95)." }
                            }
                        },
                        suggestion: { type: "STRING", description: "A 'virada de chave' para o sucesso no nicho." }
                    }
                }
            };
            const result = await callGenerativeAPI(prompt, schema);
            const html = result.map(item => `<div class="bg-slate-100 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4"><div class="flex-1"><h3 class="font-semibold text-lg mb-2">${item.niche_name} ${createCopyButton(item.niche_name)}</h3><p class="text-sm text-slate-700">${item.description}</p><p class="mt-2 font-semibold text-sm">RPM Estimado: $${(item.rpm_estimate_value || 0).toFixed(2)}</p><p class="mt-2 font-semibold text-sm">Subnichos Inexplorados: ${item.unexplored_subniches.join(', ')}</p></div>${renderScoreCard('Análise de Nicho', item.scores.Potencial, { 'Potencial': item.scores.Potencial, 'Concorrência (menor é melhor)': 100 - item.scores.Concorrência, 'Volume de Busca': item.scores['Volume de Busca'] }, item.suggestion)}</div>`).join('');
            if (append) output.insertAdjacentHTML('beforeend', html); else output.innerHTML = html;
            document.getElementById('generate-more-niches').style.display = 'block';
        },
        'find-subniches': async (output, append = false) => {
            let mainNiche = document.getElementById('main-niche').value.trim();
            const country = document.getElementById('subniche-country').value;
            if (!mainNiche) { mainNiche = "qualquer nicho com alta demanda e baixa concorrência" }
            
            const prompt = `Para o nicho principal de "${mainNiche}", no país ${country}, gere 5 subnichos inexplorados e criativos. Para cada um, forneça uma sugestão que seja uma "virada de chave", pontuações de análise e indique se é uma ideia inédita.`;
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        subniche_name: { type: "STRING" },
                        description: { type: "STRING" },
                        video_ideas: { type: "ARRAY", items: { type: "STRING" } },
                        is_novel: { type: "BOOLEAN", description: "Se o subnicho é uma ideia inédita e original." },
                        scores: {
                            type: "OBJECT",
                            properties: {
                                Potencial: { type: "NUMBER", description: "Pontuação de potencial (70-95, >90 é raro)." },
                                Concorrência: { type: "NUMBER", description: "Pontuação de concorrência (10-60)." },
                                "Originalidade": { type: "NUMBER", description: "Pontuação de originalidade (60-95)." }
                            }
                        },
                        suggestion: { type: "STRING", description: "A 'virada de chave' para o sucesso no subnicho." }
                    }
                }
            };
            const result = await callGenerativeAPI(prompt, schema);
            const html = result.map(item => `<div class="bg-slate-100 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4"><div class="flex-1"><h3 class="font-semibold text-lg mb-2">${item.subniche_name} ${createCopyButton(item.subniche_name)}</h3><p class="text-sm text-slate-700">${item.description}</p><p class="mt-2 font-semibold text-sm">Ideias de Vídeo: ${item.video_ideas.join('; ')}</p></div>${renderScoreCard('Análise do Subnicho', item.scores.Potencial, { 'Potencial': item.scores.Potencial, 'Concorrência (menor é melhor)': 100 - item.scores.Concorrência, 'Originalidade': item.scores.Originalidade }, item.suggestion, item.is_novel)}</div>`).join('');
            if (append) output.insertAdjacentHTML('beforeend', html); else output.innerHTML = html;
            document.getElementById('generate-more-subniches').style.display = 'block';
        },
        'analyze-niche': async (output) => {
            const niche = document.getElementById('analysis-niche').value.trim();
            const country = document.getElementById('analysis-country').value;
            if (!niche) { output.innerHTML = `<p class="text-red-500">Insira um nicho para análise.</p>`; return; }
            
            const prompt = `Analise profundamente o nicho "${niche}" para o YouTube no país ${country}. Forneça uma estimativa de RPM em dólares, uma pontuação de "hype" (potencial de viralização), canais de referência e uma sugestão estratégica que seja uma "virada de chave".`;
            const schema = {
                type: "OBJECT",
                properties: {
                    niche_name: { type: "STRING" },
                    rpm_estimate_value: { type: "NUMBER" },
                    hype_score: { type: "NUMBER", description: "Pontuação de hype (70-95, >90 é raro)." },
                    reference_channels: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, url: { type: "STRING" } } } },
                    suggestion: { type: "STRING", description: "A 'virada de chave' para o sucesso no nicho." }
                }
            };
            
            try {
                const [result, trendsData] = await Promise.all([
                    callGenerativeAPI(prompt, schema),
                    apiRequest(`/api/google-trends/${encodeURIComponent(niche)}/${country}`, 'GET')
                ]);

                const channelsHtml = result.reference_channels.map(ch => `<a href="${ch.url}" target="_blank" class="text-indigo-600 hover:underline">${ch.name}</a>`).join(', ');
                
                const timelineData = trendsData.default.timelineData;
                const labels = timelineData.map(d => new Date(d.time * 1000).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }));
                const values = timelineData.map(d => d.value[0]);
                const avgInterest = Math.round(values.reduce((a, b) => a + b, 0) / values.length);

                output.innerHTML = `
                    <div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg">${result.niche_name}</h3>
                            <p class="text-sm mt-1">RPM Estimado: <strong>$${(result.rpm_estimate_value || 0).toFixed(2)}</strong></p>
                            <p class="text-sm mt-1">Canais de Referência: ${channelsHtml}</p>
                        </div>
                        ${renderScoreCard('Análise de Nicho', result.hype_score, { 'Hype Score': result.hype_score, 'Potencial de RPM': (result.rpm_estimate_value || 0) * 10, 'Busca Média': avgInterest }, result.suggestion)}
                    </div>
                    <div id="trends-chart-container" class="mt-6 bg-white p-4 rounded-lg border">
                        <h4 class="font-semibold text-slate-800 mb-2">Tendência de Interesse (Últimos 12 meses)</h4>
                        <div class="h-64 relative"><canvas id="trends-chart"></canvas></div>
                        <div class="text-xs text-slate-500 mt-2 p-2 bg-slate-50 rounded-md">
                         <strong>Legenda:</strong> O gráfico mostra o interesse de busca relativo (0-100) pelo tópico. <strong>Média de Interesse: ${avgInterest}/100</strong>. Picos podem indicar sazonalidade ou eventos virais. Uma linha estável ou crescente é um bom sinal.
                        </div>
                    </div>`;

                const ctx = document.getElementById('trends-chart').getContext('2d');
                if (trendsChartInstance) trendsChartInstance.destroy();
                trendsChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Interesse em "${niche}"`,
                            data: values,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

            } catch (error) {
                output.innerHTML = `<p class="text-red-500">Erro ao analisar o nicho: ${error.message}</p>`;
            }
        },
        'analyze-video': async (output) => {
            const url = document.getElementById('video-url').value.trim();
            if (!url) { output.innerHTML = `<p class="text-red-500">Insira uma URL válida do YouTube.</p>`; return; }
            const videoIdMatch = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/);
            if (!videoIdMatch) { output.innerHTML = `<p class="text-red-500">URL inválida. Não foi possível extrair o ID do vídeo.</p>`; return; }
            const videoId = videoIdMatch[1];
            
            showProgressModal();
            try {
                const videoData = await apiRequest(`/api/video-details/${videoId}`, 'GET');
                const { title, description, tags } = videoData;

                const prompt = `Como um especialista em SEO para YouTube, analise criticamente os metadados de um vídeo e depois crie versões otimizadas.
                
                DADOS ATUAIS:
                - Título: "${title}"
                - Descrição: "${description}"
                - Tags: "${tags.join(', ')}"

                SUA TAREFA:
                1.  **Análise Crítica:** Avalie cada item (título, descrição, tags) e atribua uma pontuação de 0 a 100 para cada um, explicando brevemente o porquê da nota.
                2.  **Otimização:** Crie 3 novas sugestões de títulos, 1 nova descrição e 1 novo conjunto de tags. Para cada item otimizado, atribua uma nova pontuação (maior que a original) e uma "virada de chave" (a principal melhoria).`;
                
                const schema = {
                    type: "OBJECT",
                    properties: {
                        analysis: {
                            type: "OBJECT",
                            properties: {
                                title: { type: "OBJECT", properties: { score: { type: "NUMBER" }, critique: { type: "STRING" } } },
                                description: { type: "OBJECT", properties: { score: { type: "NUMBER" }, critique: { type: "STRING" } } },
                                tags: { type: "OBJECT", properties: { score: { type: "NUMBER" }, critique: { type: "STRING" } } }
                            }
                        },
                        optimizations: {
                            type: "OBJECT",
                            properties: {
                                titles: {
                                    type: "ARRAY",
                                    items: { type: "OBJECT", properties: { title: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } }
                                },
                                description: { type: "OBJECT", properties: { text: { type: "STRING" }, hashtags: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } },
                                tags: { type: "OBJECT", properties: { tag_list: { type: "ARRAY", items: { type: "STRING" } }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } }
                            }
                        }
                    }
                };
                
                const result = await callGenerativeAPI(prompt, schema);
                const { analysis, optimizations } = result;

                output.innerHTML = `
                    <div class="space-y-8">
                        <!-- TÍTULO -->
                        <div>
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Análise de Título</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-slate-100 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">Título Atual</h4>
                                    <p class="text-sm bg-white p-2 rounded border">${title}</p>
                                    <div class="mt-4">${renderScoreCard('Pontuação Atual', analysis.title.score, { 'SEO & CTR': analysis.title.score }, analysis.title.critique)}</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                    <h4 class="font-semibold mb-2 text-green-800">Sugestões Otimizadas</h4>
                                    ${optimizations.titles.map(t => `
                                        <div class="mb-4">
                                            <div class="flex justify-between items-start gap-2">
                                                <p class="text-sm bg-white p-2 rounded border flex-1">${t.title} ${createCopyButton(t.title)}</p>
                                                <div class="w-32 flex-shrink-0 text-center">
                                                    <p class="font-bold text-lg ${getScoreTextColor(t.score)}">${t.score}</p>
                                                    <p class="text-xs text-slate-500">Potencial</p>
                                                </div>
                                            </div>
                                            <p class="text-xs text-slate-600 mt-1 pl-1"><strong>Virada de Chave:</strong> ${t.suggestion}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- DESCRIÇÃO -->
                        <div>
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Análise de Descrição</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-slate-100 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">Descrição Atual</h4>
                                    <div class="text-sm bg-white p-2 rounded border prose whitespace-pre-wrap max-h-48 overflow-y-auto">${description}</div>
                                    <div class="mt-4">${renderScoreCard('Pontuação Atual', analysis.description.score, { 'SEO & Clareza': analysis.description.score }, analysis.description.critique)}</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                    <h4 class="font-semibold mb-2 text-green-800">Descrição Otimizada ${createCopyButton(optimizations.description.text + '\n\n' + optimizations.description.hashtags)}</h4>
                                    <div class="text-sm bg-white p-2 rounded border prose whitespace-pre-wrap max-h-48 overflow-y-auto">${optimizations.description.text}</div>
                                    <p class="text-sm bg-white p-2 rounded border mt-2 font-semibold">${optimizations.description.hashtags}</p>
                                    <div class="mt-4">${renderScoreCard('Pontuação Otimizada', optimizations.description.score, { 'SEO & Engajamento': optimizations.description.score }, optimizations.description.suggestion)}</div>
                                </div>
                            </div>
                        </div>

                        <!-- TAGS -->
                        <div>
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Análise de Tags</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-slate-100 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">Tags Atuais</h4>
                                    <p class="text-sm bg-white p-2 rounded border">${tags.join(', ')}</p>
                                    <div class="mt-4">${renderScoreCard('Pontuação Atual', analysis.tags.score, { 'Relevância': analysis.tags.score }, analysis.tags.critique)}</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                    <h4 class="font-semibold mb-2 text-green-800">Tags Otimizadas ${createCopyButton(optimizations.tags.tag_list.join(', '))}</h4>
                                    <p class="text-sm bg-white p-2 rounded border">${optimizations.tags.tag_list.join(', ')}</p>
                                    <div class="mt-4">${renderScoreCard('Pontuação Otimizada', optimizations.tags.score, { 'Relevância & Volume': optimizations.tags.score }, optimizations.tags.suggestion)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } finally {
                hideProgressModal();
            }
        },
        'generate-structures': async (output, append = false) => {
            const topic = document.getElementById('structure-topic').value.trim();
            const langSelect = document.getElementById('structure-lang');
            const lang = langSelect.value;
            const country = lang.split('-')[1] || 'BR';
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um tópico.</p>`; return; }
            
            let searchScore = 50; // Default score
            try {
                const trendsData = await apiRequest(`/api/google-trends/${encodeURIComponent(topic)}/${country}`, 'GET');
                const timelineData = trendsData.default.timelineData;
                if (timelineData && timelineData.length > 0) {
                    const avgValue = timelineData.reduce((sum, d) => sum + d.value[0], 0) / timelineData.length;
                    searchScore = Math.round(avgValue);
                }
            } catch (error) {
                console.warn("Não foi possível buscar dados do Google Trends:", error.message);
            }

            const prompt = `Crie 3 estruturas de títulos virais para "${topic}" no idioma ${lang}, com no MÁXIMO 100 caracteres. A nota de 'Busca' para este tópico é ${searchScore}. Apenas retorne títulos com nota acima de 80. Para cada estrutura, forneça uma sugestão que seja uma "virada de chave".`;
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        structure_name: { type: "STRING" },
                        structure: { type: "STRING" },
                        example_title: { type: "STRING", description: "Exemplo de título (máx 100 chars)." },
                        explanation: { type: "STRING" },
                        viral_score: { type: "NUMBER", description: "Pontuação (80-98)." },
                        suggestion: { type: "STRING", description: "A 'virada de chave' para esta estrutura." },
                        is_novel: { type: "BOOLEAN", description: "Se a estrutura é inédita e tem pontuação > 93." }
                    }
                }
            };
            const result = await callGenerativeAPI(prompt, schema);
            const filteredResult = result.filter(item => item.viral_score > 80);
            const html = filteredResult.map(item => `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><h4 class="font-semibold">${item.example_title} ${createCopyButton(item.example_title)}</h4><p class="text-sm text-slate-600"><strong>Estrutura:</strong> ${item.structure_name} - <code>${item.structure}</code></p><p class="text-sm text-slate-600 mt-1">${item.explanation}</p></div><div class="flex-shrink-0">${renderScoreCard('Potencial Viral', item.viral_score, { 'Curiosidade': item.viral_score, 'Clareza': item.viral_score - 5, 'Busca': searchScore }, item.suggestion, item.is_novel && item.viral_score > 93)}</div></div>`).join('');
            if (append) output.insertAdjacentHTML('beforeend', html); else output.innerHTML = html;
            document.getElementById('generate-more-structures').style.display = 'block';
        },
        'generate-script': async (output) => {
            const topic = document.getElementById('script-topic').value.trim();
            const duration = document.getElementById('script-duration').value;
            const parts = document.getElementById('script-parts').value;
            const narrationOnly = document.getElementById('script-narration-only').checked;
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um tópico.</p>`; return; }
            let prompt = `Atue como um roteirista profissional. Crie um roteiro de alta qualidade sobre "${topic}" em português (pt-BR).`;
            if (duration) prompt += ` O roteiro deve ter aproximadamente ${duration} minutos de duração.`;
            if (parts) prompt += ` Divida o roteiro em ${parts} partes distintas, cada parte com cerca de 5 parágrafos.`;
            if (narrationOnly) prompt += ` O roteiro DEVE conter APENAS narração, sem diálogos.`;
            prompt += ` Foque em storytelling e hooks emocionais para alta retenção.`;
            const result = await callGenerativeAPI(prompt);
            output.innerHTML = `<div class="bg-slate-100 p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Roteiro Gerado</h4>${createCopyButton(result.text)}</div><div class="prose h-96 overflow-y-auto whitespace-pre-wrap p-2 bg-white rounded border">${result.text}</div></div>`;
        },
        'generate-storyboard': async (output) => {
            const script = document.getElementById('storyboard-script').value.trim();
            if (!script) { output.innerHTML = `<p class="text-red-500">Cole um roteiro.</p>`; return; }
            const prompt = `Divida o roteiro a seguir em cenas e para cada uma, crie um prompt detalhado para uma IA de vídeo. ROTEIRO: "${script}"`;
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        scene_number: { type: "NUMBER" },
                        script_excerpt: { type: "STRING" },
                        vo3_prompt_sfx: { type: "STRING", description: "Prompt para IA de vídeo." },
                        suggestion: { type: "STRING" }
                    }
                }
            };
            const result = await callGenerativeAPI(prompt, schema);
            output.innerHTML = result.map(scene => `<div class="p-4 rounded-lg mb-2 ${scene.scene_number % 2 === 0 ? 'bg-slate-100' : 'bg-white border'}"><p class="font-semibold text-slate-800">Cena ${scene.scene_number}: <span class="font-normal text-slate-600 italic">"${scene.script_excerpt}"</span></p><div class="mt-2 bg-slate-800 text-white p-3 rounded-md font-mono text-xs relative group">${scene.vo3_prompt_sfx} <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">${createCopyButton(scene.vo3_prompt_sfx)}</div></div><p class="text-xs mt-2 text-slate-500"><strong>Sugestão:</strong> ${scene.suggestion}</p></div>`).join('');
        },
        'generate-prompts': async (output, append = false) => {
            const title = document.getElementById('thumb-title').value.trim();
            const platform = document.getElementById('thumb-platform').value;
            if (!title) { output.innerHTML = `<p class="text-red-500">Insira um título.</p>`; return; }
            const platformConfigs = {
                'Midjourney': 'Foque em composição cinematográfica, use parâmetros como --ar 16:9, --style raw, --chaos 10, e descreva a iluminação (ex: volumetric lighting, dramatic lighting).',
                'Leonardo.AI': 'Use palavras-chave como "photorealistic, cinematic, hyper-detailed, 8k". Descreva a emoção e a paleta de cores. Use "negative prompts" para remover elementos indesejados.',
                'DALL-E 3': 'Seja conversacional e extremamente descritivo. "Crie uma imagem fotorrealista de um astronauta olhando para uma galáxia neon, com um sentimento de admiração. O estilo deve ser cinematográfico e escuro."',
                'Freepik': 'Use termos comerciais e diretos. "Homem surpreso apontando para um gráfico de ações subindo, fundo de escritório, estilo de foto de banco de imagem, cores vibrantes."'
            };
            const prompt = `Gere 2 prompts AVANÇADOS em INGLÊS para a IA '${platform}' para uma thumbnail sobre "${title}". Siga esta diretriz para o prompt: ${platformConfigs[platform]}. Forneça uma sugestão que seja uma "virada de chave".`;
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        prompt: { type: "STRING" },
                        score: { type: "NUMBER", description: "Pontuação (70-95)." },
                        suggestion: { type: "STRING", description: "A 'virada de chave' para este prompt." },
                        ab_test_suggestion: { type: "STRING" }
                    }
                }
            };
            const result = await callGenerativeAPI(prompt, schema);
            const html = result.map(item => `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><div class="font-mono text-sm bg-slate-200 p-2 rounded relative group">${item.prompt}<div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">${createCopyButton(item.prompt)}</div></div><p class="text-xs mt-2 text-slate-600"><strong>Teste A/B:</strong> ${item.ab_test_suggestion}</p></div>${renderScoreCard('Potencial de CTR', item.score, { 'Impacto Visual': item.score + 4, 'Clareza': item.score - 3 }, item.suggestion)}</div>`).join('');
            if (append) output.insertAdjacentHTML('beforeend', html); else output.innerHTML = html;
            document.getElementById('generate-more-prompts').style.display = 'block';
        },
        'generate-description': async (output) => {
            const title = document.getElementById('desc-title').value.trim();
            const topic = document.getElementById('desc-topic').value.trim();
            if (!title || !topic) { output.innerHTML = `<p class="text-red-500">Insira título e tópico.</p>`; return; }
            const prompt = `Crie uma descrição de vídeo para o YouTube, altamente otimizada para SEO sobre o título "${title}" e o tópico "${topic}". Inclua parágrafos, CTAs, e hashtags. Calcule uma pontuação de otimização (0-100) baseada em SEO e engajamento, e forneça uma "virada de chave".`;
            const schema = {
                type: "OBJECT",
                properties: {
                    description: { type: "STRING" },
                    hashtags: { type: "STRING" },
                    score: { type: "NUMBER" },
                    suggestion: { type: "STRING", description: "A 'virada de chave' para esta descrição." }
                }
            };
            const result = await callGenerativeAPI(prompt, schema);
            output.innerHTML = `
                <div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start">
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold">Descrição Otimizada</h4>
                            ${createCopyButton(result.description + '\n\n' + result.hashtags)}
                        </div>
                        <div class="prose whitespace-pre-wrap text-sm">${result.description}</div>
                         <div class="mt-4">
                            <h5 class="font-semibold text-sm flex justify-between items-center">
                                <span>Hashtags</span>
                                ${createCopyButton(result.hashtags)}
                            </h5>
                            <p class="text-sm text-slate-700 p-2 bg-white rounded border mt-1">${result.hashtags}</p>
                        </div>
                    </div>
                    ${renderScoreCard('Otimização', result.score, { 'SEO': result.score, 'Engajamento': result.score > 10 ? result.score - 4 : result.score }, result.suggestion)}
                </div>`;
        },
        'generate-tags': async (output) => {
            const topic = document.getElementById('tag-topic').value.trim();
            const lang = document.getElementById('tag-lang').value;
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um tópico.</p>`; return; }
            const prompt = `Gere 25 tags para o campo de tags do YouTube, sobre "${topic}" no idioma ${lang}. As tags devem ser retornadas como uma única string, separadas por vírgula, com no máximo 500 caracteres. Calcule uma pontuação (0-100) baseada na relevância e volume de busca, e forneça uma "virada de chave".`;
            const schema = {
                type: "OBJECT",
                properties: {
                    tags: { type: "STRING" },
                    score: { type: "NUMBER" },
                    suggestion: { type: "STRING", description: "A 'virada de chave' para estas tags." }
                }
            };
            const result = await callGenerativeAPI(prompt, schema);
            output.innerHTML = `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Tags Geradas</h4>${createCopyButton(result.tags)}</div><p class="text-sm text-slate-700 p-2 bg-white rounded border">${result.tags}</p></div>${renderScoreCard('Qualidade', result.score, { 'Relevância': result.score, 'Volume': result.score > 10 ? result.score - 8 : result.score }, result.suggestion)}</div>`;
        }
    };
    
    // --- Main Render Function ---
    function renderTabContent(tabId) {
        const tool = tools[tabId];
        if (!tool) return;
        ELEMENTS.tabContent.innerHTML = `<div class="fade-in"><h2 class="text-3xl font-bold text-slate-900 mb-2">${tool.title}</h2><p class="text-slate-600 mb-6">${tool.desc}</p>${tool.content}</div>`;
        
        ELEMENTS.mobileHeaderTitle.textContent = tool.title;
        ELEMENTS.sidebar.classList.remove('open');
        ELEMENTS.menuOverlay.style.display = 'none';

        if (tabId === 'settings') initializeSettings();
        if (tabId === 'dashboard') initializeDashboard();
        if (tabId === 'channel-organizer') initializeChannelOrganizer();
        if (tabId === 'planner') initializePlanner();
        if (tabId === 'niche-analysis') {
            const nicheInput = document.getElementById('analysis-niche');
            nicheInput.addEventListener('input', () => {
                const trendsChart = document.getElementById('trends-chart-container');
                if(trendsChart) trendsChart.style.display = 'none';
            });
        }

        const outputEl = document.getElementById('output');
        if (!outputEl) return;

        Object.keys(handlers).forEach(buttonId => {
            const btn = document.getElementById(buttonId);
            if(btn) {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.addEventListener('click', () => handlers[buttonId](outputEl, false));
            }
        });
        
        ['niches', 'subniches', 'structures', 'prompts'].forEach(type => {
            const moreBtn = document.getElementById(`generate-more-${type}`);
            if (moreBtn) {
                moreBtn.addEventListener('click', () => {
                    const handlerKey = type === 'subniches' ? 'find-subniches' : `generate-${type}`;
                    handlers[handlerKey](outputEl, true)
                });
            }
        });
    }

    // --- Specific Initializers ---
    async function initializeSettings() {
        const geminiKeyInput = document.getElementById('gemini-key');
        const openaiKeyInput = document.getElementById('openai-key');
        const googleApiKeyInput = document.getElementById('google-api-key');
        const saveBtn = document.getElementById('save-settings');
        const feedbackEl = document.getElementById('settings-feedback');

        geminiKeyInput.value = appState.apiKeys.gemini || '';
        openaiKeyInput.value = appState.apiKeys.openai || '';
        googleApiKeyInput.value = appState.apiKeys.google_api || '';

        saveBtn.addEventListener('click', async () => {
            const newSettings = {
                gemini: geminiKeyInput.value.trim(),
                openai: openaiKeyInput.value.trim(),
                google_api: googleApiKeyInput.value.trim(),
                userChannels: appState.userChannels,
                videoIdeas: appState.videoIdeas
            };
            feedbackEl.textContent = '';
            try {
                await apiRequest(`/api/settings/${appState.currentUser.id}`, 'POST', { settings: newSettings });
                appState.apiKeys = newSettings;
                feedbackEl.textContent = 'Configurações salvas com sucesso!';
                feedbackEl.className = 'text-green-600 text-sm mt-4';
            } catch (error) {
                feedbackEl.textContent = `Erro ao salvar: ${error.message}`;
                feedbackEl.className = 'text-red-500 text-sm mt-4';
            } finally {
                setTimeout(() => feedbackEl.textContent = '', 3000);
            }
        });
    }
    
    let mainChartInstance = null;
    async function initializeDashboard() {
        const container = document.getElementById('dashboard-container');
        if (appState.userChannels.length === 0) {
            container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg border"><p>Nenhum canal adicionado. Vá para <button class="text-indigo-600 font-semibold" onclick="renderTabContent('channel-organizer')">Organizador de Canais</button> para começar.</p></div>`;
            return;
        }
        
        const options = appState.userChannels.map(ch => `<option value="${ch.id}">${ch.name}</option>`).join('');
        container.innerHTML = `
            <div class="mb-6 flex items-center justify-between">
                <select id="channel-selector" class="p-2 border rounded-md bg-white">${options}</select>
                <div id="dashboard-filters" class="flex gap-2"></div>
            </div>
            <div id="dashboard-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6"></div>
            <div id="recent-videos-container" class="mt-6"></div>
        `;
        
        const selector = document.getElementById('channel-selector');
        selector.addEventListener('change', (e) => renderDashboardData(e.target.value));
        
        renderDashboardData(selector.value);
    }

    async function renderDashboardData(channelId) {
        const contentContainer = document.getElementById('dashboard-content');
        const videosContainer = document.getElementById('recent-videos-container');
        contentContainer.innerHTML = `<div class="lg:col-span-3 text-center p-8"><p>Buscando dados do canal...</p></div>`;
        videosContainer.innerHTML = '';
        
        try {
            const stats = await apiRequest(`/api/youtube-stats/${channelId}`, 'GET');
            
            contentContainer.innerHTML = `
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="font-semibold mb-4">Visualizações e Inscritos (Tendência Simulada)</h3>
                    <div class="h-80 relative"><canvas id="main-chart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="font-semibold mb-4">Métricas Reais</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="bg-slate-50 p-3 rounded-lg"><p class="text-sm text-slate-500">Inscritos</p><p class="text-2xl font-bold text-slate-800">${stats.subscriberCount}</p></div>
                        <div class="bg-slate-50 p-3 rounded-lg"><p class="text-sm text-slate-500">Visualizações Totais</p><p class="text-2xl font-bold text-slate-800">${stats.viewCount}</p></div>
                        <div class="bg-slate-50 p-3 rounded-lg"><p class="text-sm text-slate-500">Vídeos Publicados</p><p class="text-2xl font-bold text-slate-800">${stats.videoCount}</p></div>
                    </div>
                </div>
            `;
            
            const renderChart = (days) => {
                const ctx = document.getElementById('main-chart').getContext('2d');
                if (mainChartInstance) mainChartInstance.destroy();
                
                const gradient = ctx.createLinearGradient(0, 0, 0, 320);
                gradient.addColorStop(0, 'rgba(79, 70, 229, 0.5)');
                gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');

                mainChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { 
                        labels: Array.from({ length: days }, (_, i) => `Dia ${i + 1}`), 
                        datasets: [{ 
                            label: 'Visualizações', 
                            data: Array.from({ length: days }, () => Math.floor(Math.random() * 50000) + 10000), 
                            borderColor: '#4f46e5',
                            backgroundColor: gradient,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#4f46e5',
                            pointHoverRadius: 6,
                            borderWidth: 2,
                            tension: 0.4, 
                            fill: true 
                        }] 
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            };

            const filterContainer = document.getElementById('dashboard-filters');
            filterContainer.innerHTML = [7, 15, 30].map(d => `<button class="filter-btn px-3 py-1 text-sm rounded-md ${d === 30 ? 'bg-indigo-600 text-white' : 'bg-white'}" data-days="${d}">${d} dias</button>`).join('');
            filterContainer.addEventListener('click', e => {
                if(e.target.classList.contains('filter-btn')) {
                    filterContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('bg-indigo-600', 'text-white'));
                    e.target.classList.add('bg-indigo-600', 'text-white');
                    renderChart(parseInt(e.target.dataset.days));
                }
            });

            renderChart(30); // Initial render

            // Fetch and render recent videos
            if (stats.uploadsPlaylistId) {
                const recentVideos = await apiRequest(`/api/youtube-recent-videos/${stats.uploadsPlaylistId}`, 'GET');
                videosContainer.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">Últimos Vídeos</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                        ${recentVideos.map(video => `
                            <div class="bg-white p-4 rounded-lg border shadow-sm">
                                <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank">
                                    <img src="${video.thumbnail}" alt="${video.title}" class="rounded-md mb-2 w-full aspect-video object-cover">
                                    <h4 class="font-semibold text-sm leading-tight truncate">${video.title}</h4>
                                </a>
                                <div class="text-xs text-slate-500 mt-2 flex justify-between">
                                    <span>👁️ ${video.viewCount}</span>
                                    <span>👍 ${video.likeCount}</span>
                                    <span>💬 ${video.commentCount}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
            }

        } catch (error) {
            contentContainer.innerHTML = `<div class="lg:col-span-3 text-center p-8 bg-red-50 rounded-lg"><p class="text-red-600">${error.message}</p><p class="text-sm text-slate-500 mt-2">Verifique se o ID do canal está correto no Organizador de Canais e se sua chave da API do Google está configurada.</p></div>`;
        }
    }

    function initializeChannelOrganizer() {
        const form = document.getElementById('channel-form');
        const output = document.getElementById('organizer-output');
        const renderChannels = () => {
            if (appState.userChannels.length === 0) {
                output.innerHTML = `<p class="text-center text-slate-500 py-8">Nenhum canal adicionado.</p>`;
                return;
            }
            output.innerHTML = appState.userChannels.map((ch, index) => `<div class="bg-white p-4 rounded-lg shadow-sm border"><div class="flex justify-between items-center"><h3 class="text-lg font-semibold">${ch.name}</h3><button class="remove-channel text-red-500 text-2xl" data-index="${index}" title="Remover Canal">&times;</button></div><div class="text-sm text-slate-600 mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2"><p><strong>Nicho:</strong> ${ch.niche}</p><p><strong>Idioma:</strong> ${ch.lang}</p><p><strong>Vídeos/Semana:</strong> ${ch.freq}</p><p><strong>Horário:</strong> ${ch.time}</p><p><strong>Backlog:</strong> ${ch.backlogQty || '0'}</p><p class="col-span-1 sm:col-span-2 break-all"><strong>ID do Canal:</strong> ${ch.id}</p></div></div>`).join('');
        };
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const channelId = prompt("Por favor, insira o ID do Canal do YouTube (ex: UC_x5XG1OV2P6uZZ5FSM9Ttw)");
            if (!channelId) return;
            const newChannel = {
                id: channelId,
                name: document.getElementById('org-channel-name').value,
                niche: document.getElementById('org-channel-niche').value,
                lang: document.getElementById('org-channel-lang').value,
                freq: document.getElementById('org-videos-week').value,
                time: document.getElementById('org-post-time').value,
                backlogQty: document.getElementById('org-backlog-qty').value,
            };
            appState.userChannels.push(newChannel);
            await saveSettings();
            renderChannels();
            form.reset();
        });
        output.addEventListener('click', async (e) => {
            if (e.target.classList.contains('remove-channel')) {
                const index = parseInt(e.target.dataset.index, 10);
                appState.userChannels.splice(index, 1);
                await saveSettings();
                renderChannels();
            }
        });
        renderChannels();
    }

    function initializePlanner() {
        const form = document.getElementById('planner-form');
        const output = document.getElementById('planner-output');
        const channelSelect = document.getElementById('planner-channel-select');
        channelSelect.innerHTML = '<option value="">Selecione um Canal</option>' + appState.userChannels.map(ch => `<option value="${ch.name}">${ch.name}</option>`).join('');
        const renderPlanner = () => {
            if (appState.videoIdeas.length === 0) {
                output.innerHTML = `<p class="text-center text-slate-500 py-8">Nenhuma ideia adicionada.</p>`;
                return;
            }
            output.innerHTML = appState.videoIdeas.map((idea, index) => `<div class="bg-white p-4 rounded-lg shadow-sm border flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4"><div><h4 class="font-semibold">${idea.title}</h4><p class="text-sm text-slate-500">${idea.channel}</p></div><div class="flex items-center gap-2"><select class="status-select bg-slate-100 border-slate-200 rounded-md text-sm p-1" data-index="${index}"><option value="Planejado" ${idea.status === 'Planejado' ? 'selected' : ''}>Planejado</option><option value="Em Produção" ${idea.status === 'Em Produção' ? 'selected' : ''}>Em Produção</option><option value="Publicado" ${idea.status === 'Publicado' ? 'selected' : ''}>Publicado</option></select><button class="delete-idea text-red-500 hover:text-red-700 text-2xl" data-index="${index}" title="Remover Ideia">&times;</button></div></div>`).join('');
        };
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newIdea = {
                title: document.getElementById('idea-title').value,
                channel: channelSelect.value,
                status: 'Planejado'
            };
            appState.videoIdeas.push(newIdea);
            await saveSettings();
            renderPlanner();
            form.reset();
        });
        output.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-idea')) {
                appState.videoIdeas.splice(e.target.dataset.index, 1);
                await saveSettings();
                renderPlanner();
            }
        });
        output.addEventListener('change', async (e) => {
            if (e.target.classList.contains('status-select')) {
                appState.videoIdeas[e.target.dataset.index].status = e.target.value;
                await saveSettings();
            }
        });
        renderPlanner();
    }

    async function saveSettings() {
        if (!appState.currentUser) return;
        const settingsToSave = { 
            gemini: appState.apiKeys.gemini,
            openai: appState.apiKeys.openai,
            google_api: appState.apiKeys.google_api,
            userChannels: appState.userChannels, 
            videoIdeas: appState.videoIdeas 
        };
        await apiRequest(`/api/settings/${appState.currentUser.id}`, 'POST', { settings: settingsToSave });
    }

    // --- Event Listeners ---
    ELEMENTS.loginForm.addEventListener('submit', handleLogin);
    ELEMENTS.registerForm.addEventListener('submit', handleRegister);
    ELEMENTS.showRegister.addEventListener('click', (e) => { e.preventDefault(); showRegisterScreen(); });
    ELEMENTS.showLogin.addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });
    ELEMENTS.logoutBtn.addEventListener('click', handleLogout);
    
    ELEMENTS.sidebarNav.addEventListener('click', (event) => {
        const clickedButton = event.target.closest('.sidebar-btn');
        if (clickedButton) {
            ELEMENTS.sidebarNav.querySelectorAll('.sidebar-btn').forEach(btn => btn.classList.remove('sidebar-btn-active'));
            clickedButton.classList.add('sidebar-btn-active');
            renderTabContent(clickedButton.getAttribute('data-tab'));
        }
    });

    ELEMENTS.tabContent.addEventListener('click', (e) => {
        if (e.target.classList.contains('copy-btn')) {
            const button = e.target;
            const text = decodeURIComponent(button.dataset.copyText);
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                button.textContent = 'Copiado!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'Copiar';
                    button.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Falha ao copiar', err);
            }
            document.body.removeChild(textArea);
        }
    });

    // Mobile Menu Listeners
    ELEMENTS.openMenuBtn.addEventListener('click', () => {
        ELEMENTS.sidebar.classList.add('open');
        ELEMENTS.menuOverlay.style.display = 'block';
    });
    ELEMENTS.closeMenuBtn.addEventListener('click', () => {
        ELEMENTS.sidebar.classList.remove('open');
        ELEMENTS.menuOverlay.style.display = 'none';
    });
    ELEMENTS.menuOverlay.addEventListener('click', () => {
        ELEMENTS.sidebar.classList.remove('open');
        ELEMENTS.menuOverlay.style.display = 'none';
    });

    // Basic Security: Disable Dev Tools
    document.addEventListener('keydown', function (e) {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C'))) {
            e.preventDefault();
        }
    });
    </script>
</body>
</html>
