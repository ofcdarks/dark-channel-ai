<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darks Vips AI v18.0</title>
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🤖</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .sidebar-btn { transition: all 0.2s ease-in-out; }
        .sidebar-btn:hover { background-color: #f1f5f9; color: #334155; }
        .sidebar-btn-active { background-color: #eef2ff; color: #4f46e5; font-weight: 600; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar-container { background-color: #e0e7ff; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-bar-inner { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
        .progress-bar-indeterminate { background-size: 200% 100%; background-image: linear-gradient(to right, #e0e7ff 0%, #c7d2fe 50%, #e0e7ff 100%); animation: move-bg 2s linear infinite; }
        @keyframes move-bg { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        #login-container { display: flex; }
        #register-container, #app-container, #progress-modal, #error-report-modal { display: none; }
        .prose { max-width: none; }
        .copy-btn.copied { background-color: #10b981; color: white; }
        .app-title-text {
            background: linear-gradient(45deg, #4f46e5, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            #app-container { flex-direction: column; }
            #sidebar { 
                position: fixed;
                left: -100%;
                top: 0;
                height: 100%;
                z-index: 40;
                transition: left 0.3s ease-in-out;
                width: 288px; /* w-72 */
            }
            #sidebar.open { left: 0; }
            #main-content { margin-left: 0; padding-bottom: 40px; } /* Space for log bar */
            #log-bar { font-size: 0.75rem; }
            #menu-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 30;
            }
        }
    </style>
</head>
<body class="text-slate-800" oncontextmenu="return false;">

    <!-- Telas de Autenticação -->
    <div id="login-container" class="flex items-center justify-center h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <div>
                <h2 class="text-3xl font-extrabold text-center text-slate-900 app-title-text">Darks Vips AI</h2>
                <p class="mt-2 text-center text-sm text-slate-600">Faça login para continuar</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div id="login-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <input id="login-email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Endereço de e-mail">
                    <input id="login-password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Senha">
                </div>
                <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Entrar</button>
            </form>
            <p class="text-center text-sm">Não tem uma conta? <a href="#" id="show-register" class="font-medium text-indigo-600 hover:text-indigo-500">Registre-se</a></p>
        </div>
    </div>
    <div id="register-container" class="hidden items-center justify-center h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <div>
                <h2 class="text-3xl font-extrabold text-center text-slate-900">Criar Conta</h2>
                <p class="mt-2 text-center text-sm text-slate-600">Junte-se à plataforma</p>
            </div>
            <form id="register-form" class="mt-8 space-y-6">
                <div id="register-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <input id="register-email" type="email" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Seu melhor e-mail">
                    <input id="register-password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Crie uma senha forte">
                </div>
                <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Criar Conta</button>
            </form>
            <p class="text-center text-sm">Já tem uma conta? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">Faça login</a></p>
        </div>
    </div>

    <!-- Modal de Progresso -->
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h3 class="text-lg font-semibold text-slate-800 mb-2">Processando...</h3>
            <p id="progress-phrase" class="text-sm text-slate-600 mb-4">Otimizando para o algoritmo...</p>
            <div class="w-full bg-slate-200 rounded-full h-2.5"><div class="h-2.5 rounded-full progress-bar-indeterminate"></div></div>
        </div>
    </div>
    
    <!-- Conteúdo da Aplicação -->
    <div id="app-container" class="hidden h-screen bg-slate-50">
        <div id="menu-overlay" class="hidden md:hidden"></div>
        <aside id="sidebar" class="w-72 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col">
            <div id="app-logo" class="p-6 border-b flex justify-between items-center">
                <!-- O logo SVG será inserido aqui pelo JS -->
            </div>
            <div class="p-4 text-sm text-slate-500" id="user-email-display"></div>
            <nav id="sidebar-nav" class="p-4 space-y-1 flex-1 overflow-y-auto"></nav>
            <div class="p-4 border-t">
                <button id="logout-btn" class="w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-red-50 hover:text-red-700">
                    <span>🚪</span><span>Sair</span>
                </button>
            </div>
        </aside>
        <div id="main-content" class="flex-1 flex flex-col overflow-hidden">
            <header class="p-4 md:hidden bg-white border-b flex items-center">
                <button id="open-menu-btn" class="text-2xl">☰</button>
                <h2 id="mobile-header-title" class="ml-4 font-semibold text-lg">Dashboard</h2>
            </header>
            <main id="tab-content" class="flex-1 p-6 md:p-10 overflow-y-auto"></main>
            <footer id="log-bar" class="bg-slate-800 text-white p-2 text-xs text-center flex items-center justify-center h-8">
                <span id="log-message">Bem-vindo ao Darks Vips AI!</span>
            </footer>
        </div>
    </div>

    <script>
    // --- Global State Management ---
    let appState = {
        currentUser: null,
        apiKeys: { 
            gemini: ["", "", ""], // Array for 3 keys
            openai: "", 
            google_api: "" 
        },
        userChannels: [],
        videoIdeas: [],
        currentVideoAnalysis: null
    };

    // --- Constants ---
    const ELEMENTS = {
        loginContainer: document.getElementById('login-container'),
        registerContainer: document.getElementById('register-container'),
        appContainer: document.getElementById('app-container'),
        loginForm: document.getElementById('login-form'),
        registerForm: document.getElementById('register-form'),
        loginFeedback: document.getElementById('login-feedback'),
        registerFeedback: document.getElementById('register-feedback'),
        showRegister: document.getElementById('show-register'),
        showLogin: document.getElementById('show-login'),
        sidebar: document.getElementById('sidebar'),
        sidebarNav: document.getElementById('sidebar-nav'),
        tabContent: document.getElementById('tab-content'),
        progressModal: document.getElementById('progress-modal'),
        progressPhrase: document.getElementById('progress-phrase'),
        userEmailDisplay: document.getElementById('user-email-display'),
        logoutBtn: document.getElementById('logout-btn'),
        openMenuBtn: document.getElementById('open-menu-btn'),
        closeMenuBtn: document.getElementById('close-menu-btn'), // Note: This element doesn't exist in the HTML, but the listener does.
        menuOverlay: document.getElementById('menu-overlay'),
        mobileHeaderTitle: document.getElementById('mobile-header-title'),
        logMessage: document.getElementById('log-message'),
    };

    const PROGRESS_PHRASES = [ "Decodificando o algoritmo...", "Buscando insights virais...", "Consultando os dados de tendência...", "Polindo as palavras-chave...", "Ajustando o potencial de clique..." ];

    // --- Utility Functions ---
    const addToLog = (message, isError = false) => {
        const logEl = ELEMENTS.logMessage;
        logEl.textContent = message;
        logEl.parentElement.classList.toggle('bg-red-600', isError);
        logEl.parentElement.classList.toggle('bg-slate-800', !isError);
    };

    const getTrendLevel = (score) => {
        if (score > 65) return 'Alta';
        if (score > 35) return 'Média';
        return 'Baixa';
    };

    // --- API Communication ---
    async function apiRequest(endpoint, method, body = null) {
        const options = { 
            method, 
            headers: { 
                'Content-Type': 'application/json',
                'x-user-id': appState.currentUser?.id
            } 
        };
        if (body) options.body = JSON.stringify(body);
        
        const response = await fetch(endpoint, options);
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Ocorreu um erro na comunicação com o servidor.');
        }
        
        const contentType = response.headers.get("content-type");
        return contentType?.includes("application/json") ? response.json() : null;
    }

    // --- Authentication ---
    function showLoginScreen() {
        ELEMENTS.registerContainer.style.display = 'none';
        ELEMENTS.loginContainer.style.display = 'flex';
    }

    function showRegisterScreen() {
        ELEMENTS.loginContainer.style.display = 'none';
        ELEMENTS.registerContainer.style.display = 'flex';
    }

    async function handleLogin(e) {
        e.preventDefault();
        ELEMENTS.loginFeedback.textContent = '';
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            const user = await apiRequest('/api/login', 'POST', { email, password });
            appState.currentUser = user;
            await initializeApp();
        } catch (error) {
            ELEMENTS.loginFeedback.textContent = error.message;
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        ELEMENTS.registerFeedback.textContent = '';
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        try {
            await apiRequest('/api/register', 'POST', { email, password });
            const user = await apiRequest('/api/login', 'POST', { email, password });
            appState.currentUser = user;
            await initializeApp();
        } catch (error) {
            ELEMENTS.registerFeedback.textContent = error.message;
        }
    }
    
    function handleLogout() {
        appState = { currentUser: null, apiKeys: { gemini: ["","",""], openai: "", google_api: "" }, userChannels: [], videoIdeas: [] };
        ELEMENTS.appContainer.style.display = 'none';
        showLoginScreen();
        document.getElementById('login-form').reset();
    }

    // --- App Initialization ---
    async function initializeApp() {
        if (!appState.currentUser) return;
        
        try {
            const settings = await apiRequest(`/api/settings/${appState.currentUser.id}`, 'GET');
            if (settings && Object.keys(settings).length > 0) {
                appState.apiKeys.gemini = Array.isArray(settings.gemini) && settings.gemini.length === 3 ? settings.gemini : [settings.gemini || "", "", ""];
                appState.apiKeys.openai = settings.openai || "";
                appState.apiKeys.google_api = settings.google_api || "";
                appState.userChannels = settings.userChannels || [];
                appState.videoIdeas = settings.videoIdeas || [];
            }
        } catch(error) {
            console.error("Não foi possível carregar as configurações:", error.message);
            addToLog("Falha ao carregar configurações.", true);
        }
        
        const logoAndFavicon = `<svg width="100%" height="100%" viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#4f46e5;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#818cf8;stop-opacity:1" />
                </linearGradient>
            </defs>
            <style>
                .logo-text { font-family: 'Poppins', sans-serif; font-size: 40px; font-weight: 800; fill: url(#grad1); }
                .ai-text { font-family: 'Poppins', sans-serif; font-size: 40px; font-weight: 600; fill: #374151; }
            </style>
            <text x="0" y="40" class="logo-text">DV</text>
            <text x="65" y="40" class="ai-text">AI</text>
        </svg>`;
        document.getElementById('app-logo').innerHTML = logoAndFavicon;
        document.getElementById('favicon').href = `data:image/svg+xml,${encodeURIComponent(logoAndFavicon)}`;

        ELEMENTS.userEmailDisplay.textContent = appState.currentUser.email;
        ELEMENTS.loginContainer.style.display = 'none';
        ELEMENTS.registerContainer.style.display = 'none';
        ELEMENTS.appContainer.style.display = 'flex';
        
        buildSidebar();
        renderTabContent('dashboard');
    }

    // --- UI Building ---
    function buildSidebar() {
        const navItems = [
            { id: 'dashboard', icon: '📈', label: 'Dashboard' },
            { type: 'divider', label: 'PESQUISA E ESTRATÉGIA' },
            { id: 'niche-finder', icon: '🔎', label: 'Localizador de Nichos' },
            { id: 'subniche-finder', icon: '💎', label: 'Explorador de Subnichos' },
            { id: 'niche-analysis', icon: '📊', label: 'Análise de Nicho' },
            { id: 'video-optimizer', icon: '🚀', label: 'Analisador de Vídeo' },
            { id: 'competitor-analysis', icon: '🕵️', label: 'Análise de Concorrência' },
            { id: 'comment-analyzer', icon: '💬', label: 'Análise de Comentários' },
            { type: 'divider', label: 'CRIAÇÃO E CONTEÚDO' },
            { id: 'title-structures', icon: '🏗️', label: 'Estruturas de Títulos' },
            { id: 'script-writer', icon: '📜', label: 'Criador de Roteiros' },
            { id: 'thumbnail-prompts', icon: '🎨', label: 'Prompts de Thumbnail' },
            { type: 'divider', label: 'OTIMIZAÇÃO E GESTÃO' },
            { id: 'description-optimizer', icon: '📄', label: 'Otimizador de Descrição' },
            { id: 'tag-generator', icon: '🏷️', label: 'Gerador de Tags' },
            { id: 'srt-converter', icon: '🔄', label: 'Conversor de SRT' },
            { id: 'text-divider', icon: '✂️', label: 'Divisor de Texto' },
            { id: 'channel-organizer', icon: '📺', label: 'Organizador de Canais' },
            { id: 'planner', icon: '🗓️', label: 'Planejador de Conteúdo' },
            { id: 'settings', icon: '⚙️', label: 'Configurações' },
        ];

        ELEMENTS.sidebarNav.innerHTML = navItems.map(item => {
            if (item.type === 'divider') {
                return `<div class="pt-2 mt-2 border-t"><span class="px-4 text-xs font-semibold text-slate-400">${item.label}</span></div>`;
            }
            return `<button class="sidebar-btn ${item.id === 'dashboard' ? 'sidebar-btn-active' : ''} w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg" data-tab="${item.id}"><span>${item.icon}</span><span>${item.label}</span></button>`;
        }).join('');
    }
    
    // --- Utility Functions ---
    const showProgressModal = () => { ELEMENTS.progressModal.style.display = 'flex'; ELEMENTS.progressPhrase.textContent = PROGRESS_PHRASES[Math.floor(Math.random() * PROGRESS_PHRASES.length)]; };
    const hideProgressModal = () => { ELEMENTS.progressModal.style.display = 'none'; };
    const getScoreColor = (score) => score >= 80 ? 'bg-green-500' : score >= 50 ? 'bg-yellow-500' : 'bg-red-500';
    const getScoreTextColor = (score) => score >= 80 ? 'text-green-500' : score >= 50 ? 'text-yellow-500' : 'text-red-500';
    const createCopyButton = (text) => `<button class="copy-btn text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded hover:bg-slate-300" data-copy-text="${encodeURIComponent(text)}">Copiar</button>`;
    
    const renderScoreCard = (title, mainScore, subScores, suggestion, isNovel = false) => {
        let intMainScore = Math.round(Math.min(100, mainScore || 0));
        if (intMainScore === 0 && Object.keys(subScores).length > 0) {
            const numericScores = Object.values(subScores).filter(v => typeof v === 'number');
            if (numericScores.length > 0) {
                const avg = numericScores.reduce((a, b) => a + b, 0) / numericScores.length;
                intMainScore = Math.round(Math.min(100, avg));
            }
        }

        const novelBadge = isNovel ? '<span class="inline-flex items-center rounded-md bg-purple-100 px-2 py-1 text-xs font-medium text-purple-700">✨ Inédita</span>' : '';
        const subScoresHtml = Object.entries(subScores).map(([key, value]) => {
            if (typeof value === 'string') {
                return `
                <div class="mb-2">
                    <div class="flex justify-between items-center text-sm mb-1">
                        <span class="text-slate-600">${key}</span>
                        <span class="font-semibold text-slate-700 px-2 py-0.5 rounded-md ${value === 'Alta' ? 'bg-green-100 text-green-800' : value === 'Média' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${value}</span>
                    </div>
                </div>`;
            }
            const cappedValue = Math.min(100, Math.round(value || 0));
            return `
            <div class="mb-2">
                <div class="flex justify-between items-center text-sm mb-1"><span class="text-slate-600">${key}</span><span class="font-semibold text-slate-700">${cappedValue}/100</span></div>
                <div class="progress-bar-container"><div class="progress-bar-inner ${getScoreColor(cappedValue)}" style="width: ${cappedValue}%;"></div></div>
            </div>`;
        }).join('');
        return `<div class="bg-white p-4 rounded-lg border w-full md:w-72 flex-shrink-0">
                    <h4 class="font-semibold text-slate-800 mb-2">${title}</h4>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-baseline gap-1">
                            <span class="text-3xl font-bold ${getScoreTextColor(intMainScore)}">${intMainScore}</span>
                            <span class="text-slate-500 text-sm">/ 100</span>
                        </div>
                        ${novelBadge}
                    </div>
                    ${subScoresHtml}
                    ${suggestion ? `<p class="text-xs text-slate-500 mt-4"><strong class="text-slate-600">A Virada de Chave:</strong> ${suggestion}</p>` : ''}
                </div>`;
    };

    const getLegendForTool = (toolId) => {
        const legends = {
            'subniche-finder': `
                <h4 class="font-semibold text-slate-800 mb-2">💡 Entendendo as Métricas</h4>
                <ul class="space-y-2 text-slate-600">
                    <li><strong>Potencial:</strong> Uma nota geral que combina demanda de busca, potencial de monetização e a longevidade do subnicho. Pontuações acima de 75 são consideradas excelentes oportunidades.</li>
                    <li><strong>Concorrência (menor é melhor):</strong> Esta é uma pontuação invertida. Um valor alto (ex: 90/100) significa que a concorrência é BAIXA, tornando o nicho mais fácil de dominar.</li>
                    <li><strong>Originalidade:</strong> Mede o quão única e criativa é a abordagem do subnicho. Pontuações altas indicam uma maior chance de se destacar da multidão e criar um conteúdo verdadeiramente novo.</li>
                </ul>`,
            'niche-analysis': `
                <h4 class="font-semibold text-slate-800 mb-2">💡 Entendendo as Métricas</h4>
                <ul class="space-y-2 text-slate-600">
                    <li><strong>Hype Score:</strong> Mede o "buzz" e o potencial de viralização de um nicho. Pontuações altas indicam que o tópico está em alta no momento.</li>
                    <li><strong>Potencial de RPM:</strong> Uma estimativa do ganho por mil visualizações (RPM) em dólares. Nichos com RPMs mais altos são mais lucrativos.</li>
                    <li><strong>Demanda de Busca:</strong> Avalia o interesse geral do público no tópico, com base em dados de tendências de busca. 'Alta' é o ideal.</li>
                </ul>`,
             'video-optimizer': `
                <h4 class="font-semibold text-slate-800 mb-2">💡 Entendendo as Métricas</h4>
                <ul class="space-y-2 text-slate-600">
                    <li><strong>Pontuação:</strong> Uma nota de 0 a 100 que avalia a qualidade geral do SEO, clareza para o espectador e o potencial de taxa de cliques (CTR) do título, descrição ou tags.</li>
                    <li><strong>Virada de Chave:</strong> Aponta a principal melhoria estratégica que foi aplicada na sugestão otimizada para impulsionar os resultados.</li>
                </ul>`,
            'default': `
                <h4 class="font-semibold text-slate-800 mb-2">💡 Entendendo as Métricas</h4>
                <p class="text-slate-600">As pontuações de 0 a 100 indicam o potencial de cada item. Valores mais altos sugerem maior probabilidade de sucesso. Analise a "Virada de Chave" para insights estratégicos.</p>`
        };
        const legendHtml = legends[toolId] || legends['default'];
        return `<div class="mt-8 text-sm p-4 bg-indigo-50 rounded-lg border border-indigo-200">${legendHtml}</div>`;
    };

    // --- [ATUALIZADO] AI API Call Abstraction (Seguro e com Log) ---
    async function callAIModel(prompt, schema = null) {
        showProgressModal();
        try {
            addToLog("Comunicando com o servidor para análise de IA...");
            const result = await apiRequest('/api/generate', 'POST', { prompt, schema });
            // Adiciona a fonte da API ao log e retorna apenas os dados
            addToLog(`Análise concluída com sucesso via ${result.apiSource || 'API'}.`);
            return result.data;
        } catch (error) {
            console.error("Erro ao chamar o modelo de IA via backend:", error);
            addToLog(`Erro: ${error.message}`, true);
            throw error; // Re-lança o erro para ser tratado pela função que chamou
        } finally {
            hideProgressModal();
        }
    }
    
    // --- Tools and Handlers ---
    let trendsChartInstance = null;
    const tools = {
        "dashboard": { title: "Dashboard de Performance", desc: "Selecione um canal para ver as métricas e obter insights da IA.", content: `<div id="dashboard-container"></div>` },
        "niche-finder": { 
            title: "Localizador de Nichos", 
            desc: "Encontre nichos e tendências de mercado com estimativas de RPM.", 
            content: `<div class="bg-white p-6 rounded-xl shadow-sm border">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="niche-keyword" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Palavra-chave (opcional)">
                            <select id="niche-country" class="w-full px-4 py-3 bg-slate-100 border rounded-lg">
                                <option value="BR">Brasil</option><option value="US">EUA</option><option value="PT">Portugal</option><option value="ES">Espanha</option><option value="DE">Alemanha</option><option value="FR">França</option><option value="GB">Reino Unido</option><option value="JP">Japão</option>
                            </select>
                        </div>
                        <button id="generate-niches" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🔎 Encontrar Nichos</button>
                        <div id="output" class="mt-6"></div>
                        <button id="generate-more-niches" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button>
                      </div>` 
        },
        "subniche-finder": { 
            title: "Explorador de Subnichos", 
            desc: "Descubra subnichos inexplorados a partir de um nicho principal.", 
            content: `<div class="bg-white p-6 rounded-xl shadow-sm border">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="main-niche" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nicho principal (ou deixe em branco)">
                            <select id="subniche-country" class="w-full px-4 py-3 bg-slate-100 border rounded-lg">
                                <option value="BR">Brasil</option><option value="US">EUA</option><option value="PT">Portugal</option><option value="ES">Espanha</option><option value="DE">Alemanha</option><option value="FR">França</option><option value="GB">Reino Unido</option><option value="JP">Japão</option>
                            </select>
                        </div>
                        <button id="find-subniches" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">💎 Explorar Subnichos</button>
                        <div id="legend-container" class="mt-6"></div>
                        <div id="output" class="mt-6"></div>
                        <button id="generate-more-subniches" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais 3 Sugestões</button>
                      </div>` 
        },
        "niche-analysis": { title: "Análise de Nicho (RPM/Hype)", desc: "Analise o potencial de um nicho específico.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="analysis-niche" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nicho a ser analisado"><select id="analysis-country" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="BR">Brasil</option><option value="US">EUA</option><option value="PT">Portugal</option><option value="ES">Espanha</option><option value="DE">Alemanha</option><option value="FR">França</option></select></div><button id="analyze-niche" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">📊 Analisar Nicho</button><div id="legend-container" class="mt-6"></div><div id="output" class="mt-6"></div></div>` },
        "video-optimizer": { title: "Analisador de Vídeo (URL)", desc: "Otimize títulos, descrições e tags a partir de uma URL do YouTube.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="url" id="video-url" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="https://www.youtube.com/watch?v=..."><button id="analyze-video" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🚀 Otimizar Vídeo</button><div id="legend-container" class="mt-6"></div><div id="output" class="mt-6"></div></div>` },
        "competitor-analysis": { title: "Análise de Concorrência", desc: "Analise a estratégia de canais concorrentes para encontrar oportunidades.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="competitor-channel-id" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="ID do Canal concorrente (Ex: UC_x5XG1OV2P6uZZ5FSM9Ttw)"><button id="analyze-competitor" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🕵️ Analisar Concorrente</button><div id="output" class="mt-6"></div></div>` },
        "comment-analyzer": { title: "Análise de Comentários", desc: "Entenda o sentimento do público e extraia ideias dos comentários de um vídeo.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="url" id="comment-video-url" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="URL do vídeo para analisar os comentários"><button id="analyze-comments" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">💬 Analisar Comentários</button><div id="legend-container" class="mt-6"></div><div id="output" class="mt-6"></div></div>` },
        "title-structures": { title: "Estruturas de Títulos Virais", desc: "Gere estruturas de títulos com alto potencial de clique.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="structure-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Tópico. Ex: Produtividade"><select id="structure-lang" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="pt-BR">Português</option><option value="en-US">Inglês</option><option value="es-ES">Espanhol</option></select></div><button id="generate-structures" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🏗️ Gerar Estruturas</button><div id="legend-container" class="mt-6"></div><div id="output" class="mt-6 space-y-4"></div><button id="generate-more-structures" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button></div>` },
        "script-writer": { title: "Criador de Roteiros", desc: "Gere roteiros com foco em alta retenção.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="space-y-4"><input type="text" id="script-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Tópico do Vídeo"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="number" id="script-duration" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Duração (minutos)"><input type="number" id="script-parts" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nº de Partes"></div><div class="flex items-center"><input id="script-narration-only" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="script-narration-only" class="ml-2 block text-sm text-gray-900">Apenas Narração (sem diálogos)</label></div><button id="generate-script" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">📜 Gerar Roteiro</button></div><div id="output" class="mt-6"></div></div>` },
        "thumbnail-prompts": { title: "Prompts de Thumbnail", desc: "Gere prompts otimizados para IAs de imagem.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="space-y-4"><input type="text" id="thumb-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Título do Vídeo"><select id="thumb-platform" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="Midjourney">Midjourney</option><option value="Leonardo.AI">Leonardo.AI</option><option value="DALL-E 3">DALL-E 3</option><option value="Freepik">Freepik</option></select></div><button id="generate-prompts" class="w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🎨 Gerar Prompts</button><div id="legend-container" class="mt-6"></div><div id="output" class="mt-6 space-y-4"></div><button id="generate-more-prompts" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button></div>` },
        "description-optimizer": { title: "Otimizador de Descrição", desc: "Crie descrições com SEO e CTAs eficazes.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="desc-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="Título do Vídeo"><textarea id="desc-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" rows="4" placeholder="Resumo do vídeo e palavras-chave..."></textarea><button id="generate-description" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">📄 Gerar Descrição</button><div id="legend-container" class="mt-6"></div><div id="output" class="mt-6"></div></div>` },
        "tag-generator": { title: "Gerador de Tags", desc: "Gere tags relevantes para maximizar o alcance.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="tag-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Tópico do Vídeo"><select id="tag-lang" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="pt-BR">Português</option><option value="en-US">Inglês</option><option value="es-ES">Espanhol</option></select></div><button id="generate-tags" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🏷️ Gerar Tags</button><div id="legend-container" class="mt-6"></div><div id="output" class="mt-6"></div></div>` },
        "srt-converter": { title: "Conversor de Texto para SRT", desc: "Cole um texto e converta-o para o formato de legenda .SRT com tempo otimizado.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><textarea id="srt-input-text" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" rows="10" placeholder="Cole o texto completo aqui..."></textarea><button id="convert-to-srt" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🔄 Converter para SRT</button><div id="output" class="mt-6"></div></div>` },
        "text-divider": { 
            title: "Divisor de Texto", 
            desc: "Analise seu roteiro e divida-o em partes menores para facilitar a narração.", 
            content: `<div class="bg-white p-6 rounded-xl shadow-sm border">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                            <div class="bg-slate-100 p-4 rounded-lg text-center"><p class="text-sm text-slate-500">Palavras</p><p id="word-count" class="text-3xl font-bold">0</p></div>
                            <div class="bg-slate-100 p-4 rounded-lg text-center"><p class="text-sm text-slate-500">Caracteres</p><p id="char-count" class="text-3xl font-bold">0</p></div>
                            <div class="bg-slate-100 p-4 rounded-lg text-center"><p class="text-sm text-slate-500">Tempo de Narração</p><p id="time-estimate" class="text-3xl font-bold">00:00</p></div>
                        </div>
                        <textarea id="text-divider-input" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" rows="10" placeholder="Digite ou cole o roteiro completo aqui..."></textarea>
                        <div class="flex flex-wrap items-center justify-center gap-4 mb-4 p-4 bg-slate-50 rounded-lg">
                            <label for="split-chunk-size" class="font-medium">Dividir o roteiro a cada</label>
                            <input type="number" id="split-chunk-size" class="px-4 py-2 bg-white border rounded-lg w-24 text-center" value="150">
                            <select id="split-chunk-type" class="px-4 py-2 bg-white border rounded-lg">
                                <option value="word">palavras</option>
                                <option value="char">caracteres</option>
                            </select>
                            <button id="split-text-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">Dividir Roteiro</button>
                        </div>
                        <div id="output" class="mt-6 space-y-4"></div>
                      </div>` 
        },
        "channel-organizer": { title: "Organizador de Canais", desc: "Adicione e gerencie as informações e estratégias dos seus canais.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border mb-6"><h3 class="text-lg font-semibold mb-4">Adicionar Novo Canal</h3><form id="channel-form" class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="org-channel-name" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nome do Canal" required><input type="text" id="org-channel-niche" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nicho Principal" required><select id="org-channel-lang" class="px-4 py-3 bg-slate-100 border rounded-lg"><option value="pt-BR">Português (BR)</option><option value="en-US">Inglês (US)</option><option value="es-ES">Espanhol (ES)</option></select><input type="number" id="org-videos-week" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Vídeos por Semana" required><input type="text" id="org-post-time" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Horário de Postagem. Ex: 18:00"><input type="number" id="org-backlog-qty" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Qtd. de Vídeos no Backlog"><button type="submit" class="md:col-span-2 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Adicionar Canal</button></form></div><div id="organizer-output" class="space-y-4"></div>` },
        "planner": { title: "Planejador de Conteúdo", desc: "Organize suas ideias de vídeo e acompanhe seu progresso.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border mb-6"><h3 class="text-lg font-semibold mb-4">Adicionar Nova Ideia</h3><form id="planner-form" class="space-y-4"><select id="planner-channel-select" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" required><option value="">Selecione um Canal</option></select><input type="text" id="idea-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Título da ideia de vídeo" required><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Adicionar ao Planejamento</button></form></div><div id="planner-output" class="space-y-4"></div>` },
        "settings": { 
            title: "Configurações", 
            desc: "Gerencie e valide suas chaves de API.", 
            content: `<div class="bg-white p-6 rounded-xl shadow-sm border space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold">Chaves de API</h3>
                            <div class="space-y-4 mt-2">
                                <!-- OpenAI -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">OpenAI API Key (Preferencial)</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="password" id="openai-key" class="block w-full px-3 py-2 border rounded-md">
                                        <button id="validate-openai-key" class="px-4 py-2 text-sm font-medium text-white bg-slate-600 rounded-md hover:bg-slate-700">Validar</button>
                                        <span id="openai-key-status" class="text-2xl"></span>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">Se preenchida e válida, esta chave será usada como principal.</p>
                                </div>
                                <hr/>
                                <!-- Gemini -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Gemini API Key (Principal / Backup)</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="password" id="gemini-key-1" class="block w-full px-3 py-2 border rounded-md">
                                        <button id="validate-gemini-key-1" class="px-4 py-2 text-sm font-medium text-white bg-slate-600 rounded-md hover:bg-slate-700">Validar</button>
                                        <span id="gemini-key-1-status" class="text-2xl"></span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Gemini API Key (Reserva 1)</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="password" id="gemini-key-2" class="block w-full px-3 py-2 border rounded-md">
                                        <button id="validate-gemini-key-2" class="px-4 py-2 text-sm font-medium text-white bg-slate-600 rounded-md hover:bg-slate-700">Validar</button>
                                        <span id="gemini-key-2-status" class="text-2xl"></span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Gemini API Key (Reserva 2)</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="password" id="gemini-key-3" class="block w-full px-3 py-2 border rounded-md">
                                        <button id="validate-gemini-key-3" class="px-4 py-2 text-sm font-medium text-white bg-slate-600 rounded-md hover:bg-slate-700">Validar</button>
                                        <span id="gemini-key-3-status" class="text-2xl"></span>
                                    </div>
                                </div>
                                <hr/>
                                <!-- Google API -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Google API Key (YouTube Data)</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="password" id="google-api-key" class="block w-full px-3 py-2 border rounded-md">
                                        <button id="validate-google-api-key" class="px-4 py-2 text-sm font-medium text-white bg-slate-600 rounded-md hover:bg-slate-700">Validar</button>
                                        <span id="google-api-key-status" class="text-2xl"></span>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">Usada para buscar dados de canais e vídeos do YouTube.</p>
                                </div>
                            </div>
                        </div>
                        <button id="save-settings" class="w-full bg-indigo-800 text-white font-bold py-3 px-4 rounded-lg mt-6">Salvar Configurações</button>
                        <div id="settings-feedback" class="mt-4 min-h-[20px]"></div>
                      </div>` 
        },
    };
    
    // --- Handlers (Lógica das Ferramentas) ---
    const handlers = {
        'generate-niches': async (output, append = false) => {
            const keyword = document.getElementById('niche-keyword').value || 'tópicos em alta';
            const country = document.getElementById('niche-country').value;
            const prompt = `Como um especialista em YouTube, gere 3 nichos promissores sobre '${keyword}' para o país ${country}. Foque em oportunidades com baixa concorrência. Para cada nicho, forneça uma sugestão estratégica que seja uma "virada de chave" e uma estimativa de RPM em dólares americanos.`;
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        niche_name: { type: "STRING" },
                        description: { type: "STRING" },
                        unexplored_subniches: { type: "ARRAY", items: { type: "STRING" } },
                        rpm_estimate_value: { type: "NUMBER", description: "Estimativa de RPM em dólares, ex: 5.50" },
                        scores: {
                            type: "OBJECT",
                            properties: {
                                Potencial: { type: "NUMBER", description: "Pontuação de potencial (70-95, >90 é raro)." },
                                Concorrência: { type: "NUMBER", description: "Pontuação de concorrência (10-60)." },
                                "Volume de Busca": { type: "NUMBER", description: "Pontuação de volume de busca (60-95)." }
                            }
                        },
                        suggestion: { type: "STRING", description: "A 'virada de chave' para o sucesso no nicho." }
                    }
                }
            };
            try {
                const result = await callAIModel(prompt, schema);
                let html = result.map(item => `<div class="bg-slate-100 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4"><div class="flex-1"><h3 class="font-semibold text-lg mb-2">${item.niche_name} ${createCopyButton(item.niche_name)}</h3><p class="text-sm text-slate-700">${item.description}</p><p class="mt-2 font-semibold text-sm">RPM Estimado: $${(item.rpm_estimate_value || 0).toFixed(2)}</p><p class="mt-2 font-semibold text-sm">Subnichos Inexplorados: ${item.unexplored_subniches.join(', ')}</p></div>${renderScoreCard('Análise de Nicho', item.scores.Potencial, { 'Potencial': item.scores.Potencial, 'Concorrência (menor é melhor)': 100 - item.scores.Concorrência, 'Volume de Busca': getTrendLevel(item.scores['Volume de Busca']) }, item.suggestion)}</div>`).join('');
                if (append) {
                    const moreButton = document.getElementById('generate-more-niches');
                    if(moreButton) moreButton.insertAdjacentHTML('beforebegin', html);
                } else {
                    output.innerHTML = html;
                }
                document.getElementById('generate-more-niches').style.display = 'block';
            } catch (error) {
                 output.innerHTML = `<p class="text-red-500">Ocorreu um erro: ${error.message}</p>`;
            }
        },
        'find-subniches': async (output, append = false) => {
            try {
                let mainNiche = document.getElementById('main-niche').value.trim();
                const country = document.getElementById('subniche-country').value;
                if (!mainNiche) { mainNiche = "qualquer nicho com alta demanda e baixa concorrência" }
                
                const prompt = `Para o nicho principal de "${mainNiche}", no país ${country}, gere EXATAMENTE 3 subnichos inexplorados e criativos.
Sua resposta DEVE SER UM JSON VÁLIDO que corresponda ao schema fornecido. Não inclua nenhum texto ou formatação markdown fora do objeto JSON.

Exemplo de formato para UM item no array:
{
  "subniche_name": "Nome do Subnicho Exemplo",
  "description": "Uma descrição clara e concisa sobre o que é este subnicho.",
  "video_ideas": ["Ideia de vídeo 1", "Ideia de vídeo 2", "Ideia de vídeo 3"],
  "is_novel": true,
  "scores": {
    "Potencial": 85,
    "Concorrência": 20,
    "Originalidade": 90
  },
  "suggestion": "Uma sugestão estratégica e acionável para ter sucesso neste subnicho."
}

Agora, gere a lista completa com 3 subnichos, seguindo estritamente este formato. Para cada subnicho, forneça pontuações realistas e variadas de Potencial (entre 60-95), Concorrência (entre 10-70) e Originalidade (entre 50-98). Os valores DEVEM ser números inteiros.`;
                
                const schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            subniche_name: { type: "STRING" },
                            description: { type: "STRING" },
                            video_ideas: { type: "ARRAY", items: { type: "STRING" } },
                            is_novel: { type: "BOOLEAN" },
                            scores: {
                                type: "OBJECT",
                                properties: {
                                    Potencial: { type: "NUMBER" },
                                    Concorrência: { type: "NUMBER" },
                                    "Originalidade": { type: "NUMBER" }
                                }
                            },
                            suggestion: { type: "STRING" }
                        }
                    }
                };
                
                const result = await callAIModel(prompt, schema);
                
                if (!result || !Array.isArray(result) || result.length === 0) {
                    throw new Error("A IA não retornou sugestões válidas. Tente refinar sua busca.");
                }

                const html = result.map(item => {
                    const potencial = item.scores?.Potencial || 0;
                    const concorrencia = item.scores?.Concorrência || 0;
                    const originalidade = item.scores?.Originalidade || 0;
                    const subnicheName = item.subniche_name || "Subnicho Indefinido";
                    const description = item.description || "Nenhuma descrição fornecida.";
                    const videoIdeas = (Array.isArray(item.video_ideas) ? item.video_ideas : []).slice(0, 3).join('; ');

                    return `<div class="bg-slate-100 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-lg mb-2">${subnicheName} ${createCopyButton(subnicheName)}</h3>
                                    <p class="text-sm text-slate-700">${description}</p>
                                    <p class="mt-2 font-semibold text-sm">Principais Ideias de Vídeo: ${videoIdeas}</p>
                                </div>
                                ${renderScoreCard(
                                    'Análise do Subnicho', 
                                    potencial, 
                                    { 
                                        'Potencial': potencial, 
                                        'Concorrência (menor é melhor)': 100 - concorrencia, 
                                        'Originalidade': originalidade 
                                    }, 
                                    item.suggestion, 
                                    item.is_novel
                                )}
                            </div>`;
                }).join('');

                if (append) {
                    const moreButton = document.getElementById('generate-more-subniches');
                    if(moreButton) moreButton.insertAdjacentHTML('beforebegin', html);
                } else {
                    output.innerHTML = html;
                }
                document.getElementById('generate-more-subniches').style.display = 'block';
            } catch (error) {
                console.error("Erro no Explorador de Subnichos:", error);
                output.innerHTML = `<div class="text-center p-4 bg-red-50 text-red-700 rounded-lg border border-red-200"><strong>Ocorreu um erro:</strong> ${error.message}</div>`;
            }
        },
        'analyze-niche': async (output) => {
            const niche = document.getElementById('analysis-niche').value.trim();
            const country = document.getElementById('analysis-country').value;
            if (!niche) { output.innerHTML = `<p class="text-red-500">Insira um nicho para análise.</p>`; return; }
            
            const prompt = `Analise profundamente o nicho "${niche}" para o YouTube no país ${country}. Forneça uma estimativa de RPM em dólares, uma pontuação de "hype" (potencial de viralização), e 3 canais de referência que sejam populares nesse país e nesse nicho específico. Os canais devem ser relevantes para o idioma e a cultura do país ${country}. Forneça também uma sugestão estratégica que seja uma "virada de chave".`;
            const schema = {
                type: "OBJECT",
                properties: {
                    niche_name: { type: "STRING" },
                    rpm_estimate_value: { type: "NUMBER" },
                    hype_score: { type: "NUMBER", description: "Pontuação de hype (70-95, >90 é raro)." },
                    reference_channels: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, url: { type: "STRING" } } } },
                    suggestion: { type: "STRING", description: "A 'virada de chave' para o sucesso no nicho." }
                }
            };
            
            try {
                const [result, trendsData] = await Promise.all([
                    callAIModel(prompt, schema),
                    apiRequest(`/api/google-trends/${encodeURIComponent(niche)}/${country}`, 'GET')
                ]);

                const channelsHtml = result.reference_channels.map(ch => `<a href="${ch.url}" target="_blank" class="text-indigo-600 hover:underline">${ch.name}</a>`).join(', ');
                
                const timelineData = trendsData.default.timelineData;
                const labels = timelineData.map(d => new Date(d.time * 1000).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }));
                const values = timelineData.map(d => d.value[0]);
                const avgInterest = Math.round(values.reduce((a, b) => a + b, 0) / values.length);

                output.innerHTML = `
                    <div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg">${result.niche_name}</h3>
                            <p class="text-sm mt-1">RPM Estimado: <strong>$${(result.rpm_estimate_value || 0).toFixed(2)}</strong></p>
                            <p class="text-sm mt-1">Canais de Referência: ${channelsHtml}</p>
                        </div>
                        ${renderScoreCard('Análise de Nicho', result.hype_score, { 'Hype Score': result.hype_score, 'Potencial de RPM': (result.rpm_estimate_value || 0) * 10, 'Demanda de Busca': getTrendLevel(avgInterest) }, result.suggestion)}
                    </div>
                    <div id="trends-chart-container" class="mt-6 bg-white p-4 rounded-lg border">
                        <h4 class="font-semibold text-slate-800 mb-2">Tendência de Interesse (Últimos 12 meses)</h4>
                        <div class="h-64 relative"><canvas id="trends-chart"></canvas></div>
                    </div>`;

                const ctx = document.getElementById('trends-chart').getContext('2d');
                if (trendsChartInstance) trendsChartInstance.destroy();
                trendsChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Interesse em "${niche}"`,
                            data: values,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

            } catch (error) {
                output.innerHTML = `<p class="text-red-500">Erro ao analisar o nicho: ${error.message}</p>`;
            }
        },
        'analyze-video': async (output) => {
            const url = document.getElementById('video-url').value.trim();
            if (!url) { output.innerHTML = `<p class="text-red-500">Insira uma URL válida do YouTube.</p>`; return; }
            const videoIdMatch = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/);
            if (!videoIdMatch) { output.innerHTML = `<p class="text-red-500">URL inválida. Não foi possível extrair o ID do vídeo.</p>`; return; }
            const videoId = videoIdMatch[1];
            
            try {
                showProgressModal();
                const videoData = await apiRequest(`/api/video-details/${videoId}`, 'GET');
                appState.currentVideoAnalysis = videoData;
                const { title, description, tags, detectedLanguage } = videoData;
                const lang = detectedLanguage || 'a língua original do texto';
                const thumbnailUrl = `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`;

                const prompt = `Como um especialista em SEO para YouTube, analise criticamente os metadados de um vídeo e depois crie versões otimizadas. Gere TODAS as respostas e otimizações no idioma: "${lang}".
                
                DADOS ATUAIS:
                - Título: "${title}"
                - Descrição: "${description}"
                - Tags: "${tags.join(', ')}"

                SUA TAREFA:
                1.  **Análise Crítica:** Avalie cada item (título, descrição, tags) e atribua uma pontuação de 0 a 100 para cada um, explicando brevemente o porquê da nota.
                2.  **Otimização:** Crie 3 novas sugestões de títulos, 3 headlines (frases curtas e de impacto para notificações), 1 nova descrição e 1 novo conjunto de tags. Para cada item otimizado, atribua uma nova pontuação (SEMPRE ACIMA de 80) e uma "virada de chave" (a principal melhoria).`;
                
                const schema = {
                    type: "OBJECT",
                    properties: {
                        analysis: {
                            type: "OBJECT",
                            properties: {
                                title: { type: "OBJECT", properties: { score: { type: "NUMBER" }, critique: { type: "STRING" } } },
                                description: { type: "OBJECT", properties: { score: { type: "NUMBER" }, critique: { type: "STRING" } } },
                                tags: { type: "OBJECT", properties: { score: { type: "NUMBER" }, critique: { type: "STRING" } } }
                            }
                        },
                        optimizations: {
                            type: "OBJECT",
                            properties: {
                                titles: { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } } },
                                headlines: { type: "ARRAY", items: { type: "OBJECT", properties: { text: { type: "STRING" }, score: { type: "NUMBER" } } } },
                                description: { type: "OBJECT", properties: { text: { type: "STRING" }, hashtags: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } },
                                tags: { type: "OBJECT", properties: { tag_list: { type: "ARRAY", items: { type: "STRING" } }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } }
                            }
                        }
                    }
                };
                
                const result = await callAIModel(prompt, schema);
                const { analysis, optimizations } = result;

                const renderTitles = (titles) => titles.map(t => `<div class="mb-4"><div class="flex justify-between items-start gap-2"><p class="text-sm bg-white p-2 rounded border flex-1">${t.title} ${createCopyButton(t.title)}</p><div class="w-32 flex-shrink-0 text-center"><p class="font-bold text-lg ${getScoreTextColor(t.score)}">${t.score}</p><p class="text-xs text-slate-500">Potencial</p></div></div><p class="text-xs text-slate-600 mt-1 pl-1"><strong>Virada de Chave:</strong> ${t.suggestion}</p></div>`).join('');
                const allHeadlinesText = optimizations.headlines.map(h => h.text).join('\n');

                output.innerHTML = `
                    <div class="mb-6"><h3 class="text-xl font-bold mb-2">Vídeo Analisado</h3><div class="flex flex-col md:flex-row gap-4 bg-slate-100 p-4 rounded-lg"><img src="${thumbnailUrl}" onerror="this.style.display='none'" class="rounded-md w-full md:w-48 h-auto object-cover"/><div class="flex-1"><h4 class="font-semibold">${title}</h4><p class="text-xs text-slate-500 mt-1">Idioma Detectado: ${lang}</p></div></div></div>
                    <div class="space-y-8">
                        <div><h3 class="text-xl font-bold mb-3 border-b pb-2">Análise de Título</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-slate-100 p-4 rounded-lg"><h4 class="font-semibold mb-2">Título Atual</h4><p class="text-sm bg-white p-2 rounded border">${title}</p><div class="mt-4">${renderScoreCard('Pontuação Atual', analysis.title.score, { 'SEO & CTR': analysis.title.score }, analysis.title.critique)}</div></div><div class="bg-green-50 p-4 rounded-lg border border-green-200"><h4 class="font-semibold mb-2 text-green-800">Sugestões Otimizadas</h4><div id="optimized-titles-container">${renderTitles(optimizations.titles)}</div><button id="generate-more-titles" class="w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais Sugestões</button></div></div></div>
                        
                        <div class="bg-white p-4 rounded-lg border"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold text-lg">⭐ Headlines de Impacto</h4>${createCopyButton(allHeadlinesText)}</div><div class="grid grid-cols-1 sm:grid-cols-3 gap-4">${optimizations.headlines.map(h => `<div class="bg-indigo-50 p-3 rounded-md text-center"><p class="font-semibold text-indigo-800">"${h.text}"</p><p class="text-xs mt-1 font-bold ${getScoreTextColor(h.score)}">${h.score}/100 Potencial</p></div>`).join('')}</div></div>

                        <div><h3 class="text-xl font-bold mb-3 border-b pb-2">Análise de Descrição</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-slate-100 p-4 rounded-lg"><h4 class="font-semibold mb-2">Descrição Atual</h4><div class="text-sm bg-white p-2 rounded border prose whitespace-pre-wrap max-h-48 overflow-y-auto">${description}</div><div class="mt-4">${renderScoreCard('Pontuação Atual', analysis.description.score, { 'SEO & Clareza': analysis.description.score }, analysis.description.critique)}</div></div><div class="bg-green-50 p-4 rounded-lg border border-green-200"><h4 class="font-semibold mb-2 text-green-800">Descrição Otimizada ${createCopyButton(optimizations.description.text + '\n\n' + optimizations.description.hashtags)}</h4><div class="text-sm bg-white p-2 rounded border prose whitespace-pre-wrap max-h-48 overflow-y-auto">${optimizations.description.text}</div><p class="text-sm bg-white p-2 rounded border mt-2 font-semibold">${optimizations.description.hashtags}</p><div class="mt-4">${renderScoreCard('Pontuação Otimizada', optimizations.description.score, { 'SEO & Engajamento': optimizations.description.score }, optimizations.description.suggestion)}</div></div></div></div>
                        
                        <div><h3 class="text-xl font-bold mb-3 border-b pb-2">Análise de Tags</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-slate-100 p-4 rounded-lg"><h4 class="font-semibold mb-2">Tags Atuais</h4><p class="text-sm bg-white p-2 rounded border">${tags.join(', ')}</p><div class="mt-4">${renderScoreCard('Pontuação Atual', analysis.tags.score, { 'Relevância': analysis.tags.score }, analysis.tags.critique)}</div></div><div class="bg-green-50 p-4 rounded-lg border border-green-200"><h4 class="font-semibold mb-2 text-green-800">Tags Otimizadas ${createCopyButton(optimizations.tags.tag_list.join(', '))}</h4><p class="text-sm bg-white p-2 rounded border">${optimizations.tags.tag_list.join(', ')}</p><div class="mt-4">${renderScoreCard('Pontuação Otimizada', optimizations.tags.score, { 'Relevância & Volume': optimizations.tags.score }, optimizations.tags.suggestion)}</div></div></div></div>
                    </div>`;
                document.getElementById('generate-more-titles').addEventListener('click', () => handlers['generate-more-titles'](document.getElementById('optimized-titles-container')));

            } catch (error) {
                 output.innerHTML = `<p class="text-red-500">Erro ao analisar vídeo: ${error.message}</p>`;
            }
        },
        'generate-more-titles': async (output) => {
            if (!appState.currentVideoAnalysis) return;
            const { title, detectedLanguage } = appState.currentVideoAnalysis;
            const lang = detectedLanguage || 'pt-BR';
            
            const prompt = `Gere mais 3 sugestões de títulos otimizados para um vídeo com o título original "${title}". As novas sugestões devem ser criativas, diferentes das anteriores, e ter uma pontuação de potencial viral ACIMA de 80. O idioma deve ser ${lang}.`;
            const schema = {
                type: "ARRAY",
                items: { type: "OBJECT", properties: { title: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } }
            };

            const result = await callAIModel(prompt, schema);
            const renderMoreTitles = (titles) => {
                return titles.map(t => `
                    <div class="mb-4 fade-in">
                        <div class="flex justify-between items-start gap-2">
                            <p class="text-sm bg-white p-2 rounded border flex-1">${t.title} ${createCopyButton(t.title)}</p>
                            <div class="w-32 flex-shrink-0 text-center">
                                <p class="font-bold text-lg ${getScoreTextColor(t.score)}">${t.score}</p>
                                <p class="text-xs text-slate-500">Potencial</p>
                            </div>
                        </div>
                        <p class="text-xs text-slate-600 mt-1 pl-1"><strong>Virada de Chave:</strong> ${t.suggestion}</p>
                    </div>
                `).join('');
            };
            output.insertAdjacentHTML('beforeend', renderMoreTitles(result));
        },
        'analyze-competitor': async (output) => {
            const channelId = document.getElementById('competitor-channel-id').value.trim();
            if (!channelId) { output.innerHTML = `<p class="text-red-500">Insira o ID de um canal concorrente.</p>`; return; }

            try {
                showProgressModal();
                const stats = await apiRequest(`/api/youtube-stats/${channelId}`, 'GET');
                const recentVideos = stats.uploadsPlaylistId ? await apiRequest(`/api/youtube-recent-videos/${stats.uploadsPlaylistId}`, 'GET') : [];
                
                const videosInfo = recentVideos.map(v => `- Título: "${v.title}", Views: ${v.viewCount}`).join('\n');
                
                const prompt = `Aja como um consultor de estratégia de conteúdo para YouTube. Analise os dados de um canal concorrente e forneça uma análise SWOT (Forças, Fraquezas, Oportunidades, Ameaças) aprofundada.
                DADOS DO CANAL:
                - Inscritos: ${stats.subscriberCount}
                - Vídeos Totais: ${stats.videoCount}
                - Views Totais: ${stats.viewCount}
                - Vídeos Recentes:
                ${videosInfo}

                SUA ANÁLISE ESTRATÉGICA:
                1.  **Forças (Strengths):** Quais são os 2 maiores trunfos deste canal, com base nos títulos e performance?
                2.  **Fraquezas (Weaknesses):** Qual a maior vulnerabilidade ou ponto cego na estratégia de conteúdo deles?
                3.  **Oportunidades (Opportunities):** Identifique 3 "brechas de conteúdo" (tópicos ou formatos que eles não cobrem) que poderiam ser exploradas.
                4.  **Ameaças (Threats):** Qual o maior risco para a relevância contínua deste canal?
                5.  **Plano de Ação Rápido:** Sugira 2 títulos de vídeo específicos que um novo canal poderia criar para explorar as fraquezas e oportunidades identificadas.`;
                
                const schema = {
                    type: "OBJECT",
                    properties: {
                        swot_analysis: {
                            type: "OBJECT",
                            properties: {
                                strengths: { type: "ARRAY", items: { type: "STRING" } },
                                weaknesses: { type: "ARRAY", items: { type: "STRING" } },
                                opportunities: { type: "ARRAY", items: { type: "STRING" } },
                                threats: { type: "ARRAY", items: { type: "STRING" } }
                            }
                        },
                        action_plan: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    title: { type: "STRING" },
                                    strategy: { type: "STRING" }
                                }
                            }
                        }
                    }
                };

                const result = await callAIModel(prompt, schema);
                const { swot_analysis, action_plan } = result;

                const renderList = (items) => items.map(item => `<li class="text-sm text-slate-700">${item}</li>`).join('');

                output.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-lg mb-2">Análise SWOT do Concorrente</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-green-50 p-3 rounded-md">
                                    <h5 class="font-bold text-green-800">Forças</h5>
                                    <ul class="list-disc list-inside mt-1">${renderList(swot_analysis.strengths)}</ul>
                                </div>
                                <div class="bg-red-50 p-3 rounded-md">
                                    <h5 class="font-bold text-red-800">Fraquezas</h5>
                                    <ul class="list-disc list-inside mt-1">${renderList(swot_analysis.weaknesses)}</ul>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-md">
                                    <h5 class="font-bold text-blue-800">Oportunidades</h5>
                                    <ul class="list-disc list-inside mt-1">${renderList(swot_analysis.opportunities)}</ul>
                                </div>
                                <div class="bg-yellow-50 p-3 rounded-md">
                                    <h5 class="font-bold text-yellow-800">Ameaças</h5>
                                    <ul class="list-disc list-inside mt-1">${renderList(swot_analysis.threats)}</ul>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-lg mb-2">Plano de Ação (Para Você)</h4>
                            <div class="space-y-3">
                                ${action_plan.map(idea => `
                                    <div class="bg-slate-50 p-3 rounded-md">
                                        <p class="font-semibold text-slate-800">${idea.title} ${createCopyButton(idea.title)}</p>
                                        <p class="text-xs text-slate-600 mt-1"><strong>Estratégia:</strong> ${idea.strategy}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                output.innerHTML = `<p class="text-red-500">Erro ao analisar concorrente: ${error.message}</p>`;
            } finally {
                hideProgressModal();
            }
        },
        'analyze-comments': async (output) => {
            const url = document.getElementById('comment-video-url').value.trim();
            if (!url) { output.innerHTML = `<p class="text-red-500">Insira a URL de um vídeo.</p>`; return; }
            const videoIdMatch = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/);
            if (!videoIdMatch) { output.innerHTML = `<p class="text-red-500">URL inválida.</p>`; return; }
            const videoId = videoIdMatch[1];

            try {
                showProgressModal();
                const [comments, videoData] = await Promise.all([
                    apiRequest(`/api/video-comments/${videoId}`, 'GET'),
                    apiRequest(`/api/video-details/${videoId}`, 'GET')
                ]);

                if (comments.length === 0) {
                    output.innerHTML = `<p class="text-slate-500">Este vídeo não tem comentários ou eles estão desativados.</p>`;
                    hideProgressModal();
                    return;
                }
                
                const lang = videoData.detectedLanguage || 'pt-BR';
                const commentsText = comments.map(c => `- "${c}"`).join('\n');
                const prompt = `Analise a seguinte lista de comentários REAIS de um vídeo do YouTube. O idioma do vídeo é ${lang}.
                COMENTÁRIOS:
                ${commentsText}

                SUA ANÁLISE ESTRUTURADA (responda no idioma ${lang}):
                1.  **Saúde do Vídeo:** Dê uma nota geral de 0 a 100 para a "saúde" do vídeo com base na recepção do público nos comentários e explique o porquê.
                2.  **Principais Elogios:** Liste os 3 pontos mais elogiados.
                3.  **Principais Dúvidas/Críticas:** Liste as 3 principais questões ou críticas.
                4.  **Ideias para Novos Vídeos:** Sugira 3 títulos de novos vídeos baseados nos comentários. Para cada um, forneça uma "virada de chave" estratégica e uma pontuação de potencial (0-100).`;
                
                const schema = {
                    type: "OBJECT",
                    properties: {
                        health: { type: "OBJECT", properties: { score: { type: "NUMBER" }, analysis: { type: "STRING" } } },
                        praises: { type: "ARRAY", items: { type: "STRING" } },
                        criticisms: { type: "ARRAY", items: { type: "STRING" } },
                        video_ideas: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    title: { type: "STRING" },
                                    suggestion: { type: "STRING" },
                                    potential_score: { type: "NUMBER" }
                                }
                            }
                        }
                    }
                };
                
                const result = await callAIModel(prompt, schema);
                const { health, praises, criticisms, video_ideas } = result;

                const renderListItems = (items) => items.map(item => `<li class="bg-slate-50 p-2 rounded-md text-sm">${item}</li>`).join('');

                output.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 space-y-4">
                            ${renderScoreCard('Saúde do Vídeo', health.score, { 'Recepção do Público': health.score }, health.analysis)}
                        </div>
                        <div class="lg:col-span-2 space-y-4">
                            <div class="bg-white p-4 rounded-lg border">
                                <h4 class="font-semibold text-green-700 mb-2">👍 Principais Elogios</h4>
                                <ul class="space-y-2">${renderListItems(praises)}</ul>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <h4 class="font-semibold text-yellow-700 mb-2">🤔 Principais Dúvidas e Críticas</h4>
                                <ul class="space-y-2">${renderListItems(criticisms)}</ul>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 bg-white p-4 rounded-lg border">
                        <h3 class="text-xl font-bold mb-3">💡 Oportunidades de Conteúdo</h3>
                        <div class="space-y-4">
                            ${video_ideas.map(idea => `
                                <div class="bg-indigo-50 border-l-4 border-indigo-400 p-4 rounded-r-lg flex justify-between items-start">
                                    <div>
                                        <p class="font-semibold text-indigo-800">${idea.title} ${createCopyButton(idea.title)}</p>
                                        <p class="text-xs text-slate-600 mt-1"><strong>Virada de Chave:</strong> ${idea.suggestion}</p>
                                    </div>
                                    <div class="text-center ml-4">
                                        <p class="font-bold text-lg ${getScoreTextColor(idea.potential_score)}">${idea.potential_score}</p>
                                        <p class="text-xs text-slate-500">Potencial</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;

            } catch (error) {
                output.innerHTML = `<p class="text-red-500">Erro ao analisar comentários: ${error.message}</p>`;
            } finally {
                hideProgressModal();
            }
        },
        'generate-structures': async (output, append = false) => {
            const topic = document.getElementById('structure-topic').value.trim();
            const langSelect = document.getElementById('structure-lang');
            const lang = langSelect.value;
            const country = lang.split('-')[1] || 'BR';
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um tópico.</p>`; return; }
            
            let searchScore = 50; // Default score
            try {
                const trendsData = await apiRequest(`/api/google-trends/${encodeURIComponent(topic)}/${country}`, 'GET');
                const timelineData = trendsData.default.timelineData;
                if (timelineData && timelineData.length > 0) {
                    const avgValue = timelineData.reduce((sum, d) => sum + d.value[0], 0) / timelineData.length;
                    searchScore = Math.round(avgValue);
                }
            } catch (error) {
                console.warn("Não foi possível buscar dados do Google Trends:", error.message);
            }

            const prompt = `Crie 3 estruturas de títulos virais para "${topic}" no idioma ${lang}, com no MÁXIMO 100 caracteres. A nota de 'Busca' para este tópico é ${searchScore}. Apenas retorne títulos com nota acima de 80. Para cada estrutura, forneça uma sugestão que seja uma "virada de chave".`;
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        structure_name: { type: "STRING" },
                        structure: { type: "STRING" },
                        example_title: { type: "STRING", description: "Exemplo de título (máx 100 chars)." },
                        explanation: { type: "STRING" },
                        viral_score: { type: "NUMBER", description: "Pontuação (80-98)." },
                        suggestion: { type: "STRING", description: "A 'virada de chave' para esta estrutura." },
                        is_novel: { type: "BOOLEAN", description: "Se a estrutura é inédita e tem pontuação > 93." }
                    }
                }
            };
            try {
                const result = await callAIModel(prompt, schema);
                const filteredResult = result.filter(item => item.viral_score > 80);
                let html = filteredResult.map(item => `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><h4 class="font-semibold">${item.example_title} ${createCopyButton(item.example_title)}</h4><p class="text-sm text-slate-600"><strong>Estrutura:</strong> ${item.structure_name} - <code>${item.structure}</code></p><p class="text-sm text-slate-600 mt-1">${item.explanation}</p></div><div class="flex-shrink-0">${renderScoreCard('Potencial Viral', item.viral_score, { 'Curiosidade': item.viral_score, 'Clareza': item.viral_score - 5, 'Demanda de Busca': getTrendLevel(searchScore) }, item.suggestion, item.is_novel && item.viral_score > 93)}</div></div>`).join('');
                if (append) {
                    const moreButton = document.getElementById('generate-more-structures');
                    if(moreButton) moreButton.insertAdjacentHTML('beforebegin', html);
                } else {
                    output.innerHTML = html;
                }
                document.getElementById('generate-more-structures').style.display = 'block';
            } catch (error) {
                 output.innerHTML = `<p class="text-red-500">Ocorreu um erro: ${error.message}</p>`;
            }
        },
        'generate-script': async (output) => {
            const topic = document.getElementById('script-topic').value.trim();
            const duration = document.getElementById('script-duration').value;
            const parts = document.getElementById('script-parts').value;
            const narrationOnly = document.getElementById('script-narration-only').checked;
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um tópico.</p>`; return; }
            let prompt = `Atue como um roteirista profissional. Crie um roteiro de alta qualidade sobre "${topic}" em português (pt-BR).`;
            if (duration) prompt += ` O roteiro deve ter aproximadamente ${duration} minutos de duração.`;
            if (parts) prompt += ` Divida o roteiro em ${parts} partes distintas, cada parte com cerca de 5 parágrafos.`;
            if (narrationOnly) prompt += ` O roteiro DEVE conter APENAS narração, sem diálogos.`;
            prompt += ` Foque em storytelling e hooks emocionais para alta retenção.`;
            
            try {
                const result = await callAIModel(prompt);
                output.innerHTML = `<div class="bg-slate-100 p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Roteiro Gerado</h4>${createCopyButton(result.text)}</div><div class="prose h-96 overflow-y-auto whitespace-pre-wrap p-2 bg-white rounded border">${result.text}</div></div>`;
            } catch (error) {
                 output.innerHTML = `<p class="text-red-500">Ocorreu um erro: ${error.message}</p>`;
            }
        },
        'generate-prompts': async (output, append = false) => {
            const title = document.getElementById('thumb-title').value.trim();
            const platform = document.getElementById('thumb-platform').value;
            if (!title) { output.innerHTML = `<p class="text-red-500">Insira um título.</p>`; return; }
            const platformConfigs = {
                'Midjourney': 'Foque em composição cinematográfica, use parâmetros como --ar 16:9, --style raw, --chaos 10, e descreva a iluminação (ex: volumetric lighting, dramatic lighting).',
                'Leonardo.AI': 'Use palavras-chave como "photorealistic, cinematic, hyper-detailed, 8k". Descreva a emoção e a paleta de cores. Use "negative prompts" para remover elementos indesejados.',
                'DALL-E 3': 'Seja conversacional e extremamente descritivo. "Crie uma imagem fotorrealista de um astronauta olhando para uma galáxia neon, com um sentimento de admiração. O estilo deve ser cinematográfico e escuro."',
                'Freepik': 'Use termos comerciais e diretos. "Homem surpreso apontando para um gráfico de ações subindo, fundo de escritório, estilo de foto de banco de imagem, cores vibrantes."'
            };
            const prompt = `Gere 2 prompts AVANÇADOS em INGLÊS para a IA '${platform}' para uma thumbnail sobre "${title}". Siga esta diretriz para o prompt: ${platformConfigs[platform]}. Forneça uma sugestão que seja uma "virada de chave".`;
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        prompt: { type: "STRING" },
                        score: { type: "NUMBER", description: "Pontuação (70-95)." },
                        suggestion: { type: "STRING", description: "A 'virada de chave' para este prompt." },
                        ab_test_suggestion: { type: "STRING" }
                    }
                }
            };
            try {
                const result = await callAIModel(prompt, schema);
                let html = result.map(item => `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><div class="font-mono text-sm bg-slate-200 p-2 rounded relative group">${item.prompt}<div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">${createCopyButton(item.prompt)}</div></div><p class="text-xs mt-2 text-slate-600"><strong>Teste A/B:</strong> ${item.ab_test_suggestion}</p></div>${renderScoreCard('Potencial de CTR', item.score, { 'Impacto Visual': item.score + 4, 'Clareza': item.score - 3 }, item.suggestion)}</div>`).join('');
                if (append) {
                    const moreButton = document.getElementById('generate-more-prompts');
                    if(moreButton) moreButton.insertAdjacentHTML('beforebegin', html);
                } else {
                    output.innerHTML = html;
                }
                document.getElementById('generate-more-prompts').style.display = 'block';
            } catch (error) {
                 output.innerHTML = `<p class="text-red-500">Ocorreu um erro: ${error.message}</p>`;
            }
        },
        'generate-description': async (output) => {
            const title = document.getElementById('desc-title').value.trim();
            const topic = document.getElementById('desc-topic').value.trim();
            if (!title || !topic) { output.innerHTML = `<p class="text-red-500">Insira título e tópico.</p>`; return; }
            const prompt = `Crie uma descrição de vídeo para o YouTube, altamente otimizada para SEO sobre o título "${title}" e o tópico "${topic}". Inclua parágrafos, CTAs, e hashtags. Calcule uma pontuação de otimização (0-100) baseada em SEO e engajamento, e forneça uma "virada de chave".`;
            const schema = {
                type: "OBJECT",
                properties: {
                    description: { type: "STRING" },
                    hashtags: { type: "STRING" },
                    score: { type: "NUMBER" },
                    suggestion: { type: "STRING", description: "A 'virada de chave' para esta descrição." }
                }
            };
            try {
                const result = await callAIModel(prompt, schema);
                output.innerHTML = `
                    <div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start">
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold">Descrição Otimizada</h4>
                                ${createCopyButton(result.description + '\n\n' + result.hashtags)}
                            </div>
                            <div class="prose whitespace-pre-wrap text-sm">${result.description}</div>
                             <div class="mt-4">
                                <h5 class="font-semibold text-sm flex justify-between items-center">
                                    <span>Hashtags</span>
                                    ${createCopyButton(result.hashtags)}
                                </h5>
                                <p class="text-sm text-slate-700 p-2 bg-white rounded border mt-1">${result.hashtags}</p>
                            </div>
                        </div>
                        ${renderScoreCard('Otimização', result.score, { 'SEO': result.score, 'Engajamento': result.score > 10 ? result.score - 4 : result.score }, result.suggestion)}
                    </div>`;
            } catch (error) {
                 output.innerHTML = `<p class="text-red-500">Ocorreu um erro: ${error.message}</p>`;
            }
        },
        'generate-tags': async (output) => {
            const topic = document.getElementById('tag-topic').value.trim();
            const lang = document.getElementById('tag-lang').value;
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um tópico.</p>`; return; }
            const prompt = `Gere 25 tags para o campo de tags do YouTube, sobre "${topic}" no idioma ${lang}. As tags devem ser retornadas como uma única string, separadas por vírgula, com no máximo 500 caracteres. Calcule uma pontuação (0-100) baseada na relevância e volume de busca, e forneça uma "virada de chave".`;
            const schema = {
                type: "OBJECT",
                properties: {
                    tags: { type: "STRING" },
                    score: { type: "NUMBER" },
                    suggestion: { type: "STRING", description: "A 'virada de chave' para estas tags." }
                }
            };
            try {
                const result = await callAIModel(prompt, schema);
                output.innerHTML = `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Tags Geradas</h4>${createCopyButton(result.tags)}</div><p class="text-sm text-slate-700 p-2 bg-white rounded border">${result.tags}</p></div>${renderScoreCard('Qualidade', result.score, { 'Relevância': result.score, 'Volume': result.score > 10 ? result.score - 8 : result.score }, result.suggestion)}</div>`;
            } catch (error) {
                 output.innerHTML = `<p class="text-red-500">Ocorreu um erro: ${error.message}</p>`;
            }
        },
        'convert-to-srt': (output) => {
            const texto = document.getElementById('srt-input-text').value;
            if (!texto.trim()) {
                output.innerHTML = `<p class="text-red-500">Por favor, cole um texto para converter.</p>`;
                return;
            }

            const CARACTERES_POR_BLOCO = 500;
            const PALAVRAS_MAX_BLOCO = 100;
            const DURACAO_BLOCO = 30;
            const INTERVALO_ENTRE_BLOCOS = 10;

            function formatarTempo(segundos) {
                const horas = Math.floor(segundos / 3600);
                const minutos = Math.floor((segundos % 3600) / 60);
                const segsRestantes = Math.floor(segundos % 60);
                const milissegundos = Math.floor((segundos % 1) * 1000);
                const pad = (num, size = 2) => num.toString().padStart(size, '0');
                return `${pad(horas)}:${pad(minutos)}:${pad(segsRestantes)},${pad(milissegundos, 3)}`;
            }

            function formatarBlocoSRT(contador, tempoInicio, textoBloco) {
                const tempoFim = tempoInicio + DURACAO_BLOCO;
                return `${contador}\n${formatarTempo(tempoInicio)} --> ${formatarTempo(tempoFim)}\n${textoBloco.trim()}\n\n`;
            }
            
            let srt = '';
            let contador = 1;
            let tempoAcumulado = 0;
            let palavras = texto.split(/\s+/);
            let blocoAtual = '';
            let palavrasNoBloco = 0;

            for (let palavra of palavras) {
                if (blocoAtual.length + palavra.length <= CARACTERES_POR_BLOCO && palavrasNoBloco < PALAVRAS_MAX_BLOCO) {
                    blocoAtual += palavra + ' ';
                    palavrasNoBloco++;
                } else {
                    let ultimoPontoFinal = blocoAtual.lastIndexOf('.');
                    if (ultimoPontoFinal > -1 && ultimoPontoFinal < blocoAtual.length - 2) {
                        let resto = blocoAtual.substring(ultimoPontoFinal + 1);
                        blocoAtual = blocoAtual.substring(0, ultimoPontoFinal + 1);
                        srt += formatarBlocoSRT(contador, tempoAcumulado, blocoAtual);
                        contador++;
                        tempoAcumulado += DURACAO_BLOCO + INTERVALO_ENTRE_BLOCOS;
                        blocoAtual = resto + palavra + ' ';
                        palavrasNoBloco = resto.split(/\s+/).filter(Boolean).length + 1;
                    } else {
                        srt += formatarBlocoSRT(contador, tempoAcumulado, blocoAtual);
                        contador++;
                        tempoAcumulado += DURACAO_BLOCO + INTERVALO_ENTRE_BLOCOS;
                        blocoAtual = palavra + ' ';
                        palavrasNoBloco = 1;
                    }
                }
            }

            if (blocoAtual.trim()) {
                srt += formatarBlocoSRT(contador, tempoAcumulado, blocoAtual);
            }

            output.innerHTML = `
                <div class="bg-slate-100 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold">Resultado SRT</h4>
                        <div>
                            <button id="download-srt-btn" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Download</button>
                            <button id="clear-srt-btn" class="text-xs bg-slate-500 text-white px-3 py-1 rounded hover:bg-slate-600">Limpar</button>
                        </div>
                    </div>
                    <div id="srt-result-content" class="prose whitespace-pre-wrap p-2 bg-white rounded border max-h-72 overflow-y-auto">${srt.trim()}</div>
                </div>`;
            
            document.getElementById('download-srt-btn').addEventListener('click', () => {
                const srtContent = document.getElementById('srt-result-content').textContent;
                const blob = new Blob([srtContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'legendas.srt';
                a.click();
                URL.revokeObjectURL(url);
            });

            document.getElementById('clear-srt-btn').addEventListener('click', () => {
                document.getElementById('srt-input-text').value = '';
                output.innerHTML = '';
            });
        },
    };
    
    // --- Main Render Function ---
    function renderTabContent(tabId) {
        const tool = tools[tabId];
        if (!tool) return;
        ELEMENTS.tabContent.innerHTML = `<div class="fade-in"><h2 class="text-3xl font-bold text-slate-900 mb-2">${tool.title}</h2><p class="text-slate-600 mb-6">${tool.desc}</p>${tool.content}</div>`;
        
        ELEMENTS.mobileHeaderTitle.textContent = tool.title;
        ELEMENTS.sidebar.classList.remove('open');
        ELEMENTS.menuOverlay.style.display = 'none';

        // Add specific initializers for complex tools
        if (tabId === 'settings') initializeSettings();
        if (tabId === 'dashboard') initializeDashboard();
        if (tabId === 'channel-organizer') initializeChannelOrganizer();
        if (tabId === 'planner') initializePlanner();
        if (tabId === 'text-divider') initializeTextDivider();
        if (tabId === 'niche-analysis') {
            const nicheInput = document.getElementById('analysis-niche');
            nicheInput.addEventListener('input', () => {
                const trendsChart = document.getElementById('trends-chart-container');
                if(trendsChart) trendsChart.style.display = 'none';
            });
        }

        const legendContainer = document.getElementById('legend-container');
        if (legendContainer) {
            const legendHtml = getLegendForTool(tabId);
            if (legendHtml) {
                legendContainer.innerHTML = legendHtml;
                legendContainer.style.display = 'none'; // Começa escondido
            }
        }

        const outputEl = document.getElementById('output');
        if (!outputEl) return;

        // Generic button handlers
        Object.keys(handlers).forEach(buttonId => {
            const btn = document.getElementById(buttonId);
            if(btn) {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.addEventListener('click', () => {
                    if (legendContainer) legendContainer.style.display = 'block';
                    handlers[buttonId](outputEl, false)
                });
            }
        });
        
        ['niches', 'subniches', 'structures', 'prompts'].forEach(type => {
            const moreBtn = document.getElementById(`generate-more-${type}`);
            if (moreBtn) {
                const newMoreBtn = moreBtn.cloneNode(true);
                moreBtn.parentNode.replaceChild(newMoreBtn, moreBtn);
                newMoreBtn.addEventListener('click', () => {
                    const handlerKey = type === 'subniches' ? 'find-subniches' : `generate-${type}`;
                    handlers[handlerKey](outputEl, true)
                });
            }
        });
    }

    // --- Specific Initializers ---
    
    async function validateOpenAIKey(key, statusEl) {
        if (!key) {
            statusEl.innerHTML = '<span title="Chave não informada">⚪</span>';
            return;
        }
        statusEl.innerHTML = '<span class="animate-spin">⏳</span>';
        try {
            const response = await fetch('https://api.openai.com/v1/models', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${key}` }
            });
            if (response.ok) {
                statusEl.innerHTML = '<span title="Chave Válida">✅</span>';
            } else {
                statusEl.innerHTML = '<span title="Chave Inválida ou Expirada">❌</span>';
            }
        } catch (error) {
            statusEl.innerHTML = '<span title="Erro de rede ao validar">❌</span>';
        }
    }

    async function validateGeminiKey(key, statusEl) {
        if (!key) {
            statusEl.innerHTML = '<span title="Chave não informada">⚪</span>';
            return;
        }
        statusEl.innerHTML = '<span class="animate-spin">⏳</span>';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${key}`;
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: "teste" }] }] })
            });
            if (response.ok) {
                statusEl.innerHTML = '<span title="Chave Válida">✅</span>';
            } else {
                statusEl.innerHTML = '<span title="Chave Inválida ou Expirada">❌</span>';
            }
        } catch (error) {
            statusEl.innerHTML = '<span title="Erro de rede ao validar">❌</span>';
        }
    }

    async function validateGoogleApiKey(key, statusEl) {
        if (!key) {
            statusEl.innerHTML = '<span title="Chave não informada">⚪</span>';
            return;
        }
        statusEl.innerHTML = '<span class="animate-spin">⏳</span>';
        const testVideoId = 'dQw4w9WgXcQ'; // Um vídeo público conhecido
        const apiUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${testVideoId}&key=${key}`;
        try {
            const response = await fetch(apiUrl);
            if (response.ok) {
                statusEl.innerHTML = '<span title="Chave Válida">✅</span>';
            } else {
                statusEl.innerHTML = '<span title="Chave Inválida ou sem permissão para YouTube API">❌</span>';
            }
        } catch (error) {
            statusEl.innerHTML = '<span title="Erro de rede ao validar">❌</span>';
        }
    }

    async function initializeSettings() {
        const ids = {
            openai: 'openai-key',
            gemini1: 'gemini-key-1',
            gemini2: 'gemini-key-2',
            gemini3: 'gemini-key-3',
            google: 'google-api-key'
        };

        const inputs = {
            openai: document.getElementById(ids.openai),
            gemini1: document.getElementById(ids.gemini1),
            gemini2: document.getElementById(ids.gemini2),
            gemini3: document.getElementById(ids.gemini3),
            google: document.getElementById(ids.google)
        };

        inputs.openai.value = appState.apiKeys.openai || '';
        inputs.gemini1.value = appState.apiKeys.gemini[0] || '';
        inputs.gemini2.value = appState.apiKeys.gemini[1] || '';
        inputs.gemini3.value = appState.apiKeys.gemini[2] || '';
        inputs.google.value = appState.apiKeys.google_api || '';

        // Listeners para os botões de validação
        document.getElementById('validate-openai-key').addEventListener('click', () => validateOpenAIKey(inputs.openai.value, document.getElementById('openai-key-status')));
        document.getElementById('validate-gemini-key-1').addEventListener('click', () => validateGeminiKey(inputs.gemini1.value, document.getElementById('gemini-key-1-status')));
        document.getElementById('validate-gemini-key-2').addEventListener('click', () => validateGeminiKey(inputs.gemini2.value, document.getElementById('gemini-key-2-status')));
        document.getElementById('validate-gemini-key-3').addEventListener('click', () => validateGeminiKey(inputs.gemini3.value, document.getElementById('gemini-key-3-status')));
        document.getElementById('validate-google-api-key').addEventListener('click', () => validateGoogleApiKey(inputs.google.value, document.getElementById('google-api-key-status')));

        // Listener para o botão de salvar
        document.getElementById('save-settings').addEventListener('click', async () => {
            const newSettings = {
                openai: inputs.openai.value.trim(),
                gemini: [
                    inputs.gemini1.value.trim(),
                    inputs.gemini2.value.trim(),
                    inputs.gemini3.value.trim()
                ],
                google_api: inputs.google.value.trim(),
                userChannels: appState.userChannels,
                videoIdeas: appState.videoIdeas
            };
            const feedbackEl = document.getElementById('settings-feedback');
            feedbackEl.textContent = '';
            try {
                await apiRequest(`/api/settings/${appState.currentUser.id}`, 'POST', { settings: newSettings });
                appState.apiKeys = { 
                    openai: newSettings.openai, 
                    gemini: newSettings.gemini,
                    google_api: newSettings.google_api
                };
                feedbackEl.textContent = 'Configurações salvas com sucesso!';
                feedbackEl.className = 'text-green-600 text-sm mt-4';
            } catch (error) {
                feedbackEl.textContent = `Erro ao salvar: ${error.message}`;
                feedbackEl.className = 'text-red-500 text-sm mt-4';
            } finally {
                setTimeout(() => feedbackEl.textContent = '', 3000);
            }
        });
    }

    function initializeTextDivider() {
        const textInput = document.getElementById('text-divider-input');
        const wordCountEl = document.getElementById('word-count');
        const charCountEl = document.getElementById('char-count');
        const timeEstimateEl = document.getElementById('time-estimate');
        const chunkSizeInput = document.getElementById('split-chunk-size');
        const chunkTypeSelect = document.getElementById('split-chunk-type');
        const splitBtn = document.getElementById('split-text-btn');
        const outputEl = document.getElementById('output');

        const updateAnalytics = () => {
            const text = textInput.value;
            const words = text.trim().split(/\s+/).filter(Boolean);
            const wordCount = words.length;
            const charCount = text.length;
            
            wordCountEl.textContent = wordCount;
            charCountEl.textContent = charCount;

            const timeInSeconds = (wordCount / 150) * 60; // Average 150 WPM
            const minutes = Math.floor(timeInSeconds / 60);
            const seconds = Math.floor(timeInSeconds % 60);
            timeEstimateEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };

        const splitText = () => {
            const text = textInput.value.trim();
            const chunkSize = parseInt(chunkSizeInput.value, 10);
            const chunkType = chunkTypeSelect.value;
            outputEl.innerHTML = '';

            if (!text || isNaN(chunkSize) || chunkSize <= 0) {
                outputEl.innerHTML = '<p class="text-center text-slate-500">Por favor, insira um texto e um tamanho de divisão válido.</p>';
                return;
            }

            const parts = [];
            if (chunkType === 'word') {
                const words = text.split(/\s+/).filter(Boolean);
                for (let i = 0; i < words.length; i += chunkSize) {
                    parts.push(words.slice(i, i + chunkSize).join(' '));
                }
            } else { // 'char'
                for (let i = 0; i < text.length; i += chunkSize) {
                    parts.push(text.substring(i, i + chunkSize));
                }
            }

            if (parts.length > 0) {
                outputEl.innerHTML = parts.map((part, index) => `
                    <div class="bg-slate-100 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-slate-800">Parte ${index + 1}</h4>
                            ${createCopyButton(part)}
                        </div>
                        <p class="text-sm bg-white p-3 rounded border whitespace-pre-wrap">${part}</p>
                    </div>
                `).join('');
            } else {
                outputEl.innerHTML = '<p class="text-center text-slate-500">Nenhuma parte para exibir com as configurações atuais.</p>';
            }
        };

        textInput.addEventListener('input', updateAnalytics);
        splitBtn.addEventListener('click', splitText);
        updateAnalytics(); // Initial call
    }
    
    let mainChartInstance = null;
    async function initializeDashboard() {
        const container = document.getElementById('dashboard-container');
        if (appState.userChannels.length === 0) {
            container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg border"><p>Nenhum canal adicionado. Vá para <button class="text-indigo-600 font-semibold" onclick="renderTabContent('channel-organizer')">Organizador de Canais</button> para começar.</p></div>`;
            return;
        }
        
        const options = appState.userChannels.map(ch => `<option value="${ch.id}">${ch.name}</option>`).join('');
        container.innerHTML = `
            <div class="mb-6 flex items-center justify-between">
                <select id="channel-selector" class="p-2 border rounded-md bg-white">${options}</select>
                <div id="dashboard-filters" class="flex gap-2"></div>
            </div>
            <div id="dashboard-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6"></div>
            <div id="recent-videos-container" class="mt-6"></div>
        `;
        
        const selector = document.getElementById('channel-selector');
        selector.addEventListener('change', (e) => renderDashboardData(e.target.value));
        
        renderDashboardData(selector.value);
    }

    async function renderDashboardData(channelId) {
        const contentContainer = document.getElementById('dashboard-content');
        const videosContainer = document.getElementById('recent-videos-container');
        contentContainer.innerHTML = `<div class="lg:col-span-3 text-center p-8"><p>Buscando dados do canal...</p></div>`;
        videosContainer.innerHTML = '';
        
        try {
            const stats = await apiRequest(`/api/youtube-stats/${channelId}`, 'GET');
            
            contentContainer.innerHTML = `
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="font-semibold mb-4">Visualizações e Inscritos (Tendência Simulada)</h3>
                    <div class="h-80 relative"><canvas id="main-chart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="font-semibold mb-4">Métricas Reais</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="bg-slate-50 p-3 rounded-lg"><p class="text-sm text-slate-500">Inscritos</p><p class="text-2xl font-bold text-slate-800">${stats.subscriberCount}</p></div>
                        <div class="bg-slate-50 p-3 rounded-lg"><p class="text-sm text-slate-500">Visualizações Totais</p><p class="text-2xl font-bold text-slate-800">${stats.viewCount}</p></div>
                        <div class="bg-slate-50 p-3 rounded-lg"><p class="text-sm text-slate-500">Vídeos Publicados</p><p class="text-2xl font-bold text-slate-800">${stats.videoCount}</p></div>
                    </div>
                </div>
            `;
            
            const renderChart = (days) => {
                const ctx = document.getElementById('main-chart').getContext('2d');
                if (mainChartInstance) mainChartInstance.destroy();
                
                const gradient = ctx.createLinearGradient(0, 0, 0, 320);
                gradient.addColorStop(0, 'rgba(79, 70, 229, 0.5)');
                gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');

                mainChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { 
                        labels: Array.from({ length: days }, (_, i) => `Dia ${i + 1}`), 
                        datasets: [{ 
                            label: 'Visualizações', 
                            data: Array.from({ length: days }, () => Math.floor(Math.random() * 50000) + 10000), 
                            borderColor: '#4f46e5',
                            backgroundColor: gradient,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#4f46e5',
                            pointHoverRadius: 6,
                            borderWidth: 2,
                            tension: 0.4, 
                            fill: true 
                        }] 
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            };

            const filterContainer = document.getElementById('dashboard-filters');
            filterContainer.innerHTML = [7, 15, 30].map(d => `<button class="filter-btn px-3 py-1 text-sm rounded-md ${d === 30 ? 'bg-indigo-600 text-white' : 'bg-white'}" data-days="${d}">${d} dias</button>`).join('');
            filterContainer.addEventListener('click', e => {
                if(e.target.classList.contains('filter-btn')) {
                    filterContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('bg-indigo-600', 'text-white'));
                    e.target.classList.add('bg-indigo-600', 'text-white');
                    renderChart(parseInt(e.target.dataset.days));
                }
            });

            renderChart(30); // Initial render

            if (stats.uploadsPlaylistId) {
                const recentVideos = await apiRequest(`/api/youtube-recent-videos/${stats.uploadsPlaylistId}`, 'GET');
                videosContainer.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">Últimos Vídeos</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                        ${recentVideos.map(video => `
                            <div class="bg-white p-4 rounded-lg border shadow-sm">
                                <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank">
                                    <img src="${video.thumbnail}" alt="${video.title}" class="rounded-md mb-2 w-full aspect-video object-cover">
                                    <h4 class="font-semibold text-sm leading-tight truncate">${video.title}</h4>
                                </a>
                                <div class="text-xs text-slate-500 mt-2 flex justify-between">
                                    <span>👁️ ${video.viewCount}</span>
                                    <span>👍 ${video.likeCount}</span>
                                    <span>💬 ${video.commentCount}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
            }

        } catch (error) {
            contentContainer.innerHTML = `<div class="lg:col-span-3 text-center p-8 bg-red-50 rounded-lg"><p class="text-red-600">${error.message}</p><p class="text-sm text-slate-500 mt-2">Verifique se o ID do canal está correto no Organizador de Canais e se sua chave da API do Google está configurada.</p></div>`;
        }
    }

    function initializeChannelOrganizer() {
        const form = document.getElementById('channel-form');
        const output = document.getElementById('organizer-output');
        const renderChannels = () => {
            if (appState.userChannels.length === 0) {
                output.innerHTML = `<p class="text-center text-slate-500 py-8">Nenhum canal adicionado.</p>`;
                return;
            }
            output.innerHTML = appState.userChannels.map((ch, index) => `<div class="bg-white p-4 rounded-lg shadow-sm border"><div class="flex justify-between items-center"><h3 class="text-lg font-semibold">${ch.name}</h3><button class="remove-channel text-red-500 text-2xl" data-index="${index}" title="Remover Canal">&times;</button></div><div class="text-sm text-slate-600 mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2"><p><strong>Nicho:</strong> ${ch.niche}</p><p><strong>Idioma:</strong> ${ch.lang}</p><p><strong>Vídeos/Semana:</strong> ${ch.freq}</p><p><strong>Horário:</strong> ${ch.time}</p><p><strong>Backlog:</strong> ${ch.backlogQty || '0'}</p><p class="col-span-1 sm:col-span-2 break-all"><strong>ID do Canal:</strong> ${ch.id}</p></div></div>`).join('');
        };
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const channelId = prompt("Por favor, insira o ID do Canal do YouTube (ex: UC_x5XG1OV2P6uZZ5FSM9Ttw)");
            if (!channelId) return;
            const newChannel = {
                id: channelId,
                name: document.getElementById('org-channel-name').value,
                niche: document.getElementById('org-channel-niche').value,
                lang: document.getElementById('org-channel-lang').value,
                freq: document.getElementById('org-videos-week').value,
                time: document.getElementById('org-post-time').value,
                backlogQty: document.getElementById('org-backlog-qty').value,
            };
            appState.userChannels.push(newChannel);
            await saveSettings();
            renderChannels();
            form.reset();
        });
        output.addEventListener('click', async (e) => {
            if (e.target.classList.contains('remove-channel')) {
                const index = parseInt(e.target.dataset.index, 10);
                appState.userChannels.splice(index, 1);
                await saveSettings();
                renderChannels();
            }
        });
        renderChannels();
    }

    function initializePlanner() {
        const form = document.getElementById('planner-form');
        const output = document.getElementById('planner-output');
        const channelSelect = document.getElementById('planner-channel-select');
        channelSelect.innerHTML = '<option value="">Selecione um Canal</option>' + appState.userChannels.map(ch => `<option value="${ch.name}">${ch.name}</option>`).join('');
        const renderPlanner = () => {
            if (appState.videoIdeas.length === 0) {
                output.innerHTML = `<p class="text-center text-slate-500 py-8">Nenhuma ideia adicionada.</p>`;
                return;
            }
            output.innerHTML = appState.videoIdeas.map((idea, index) => `<div class="bg-white p-4 rounded-lg shadow-sm border flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4"><div><h4 class="font-semibold">${idea.title}</h4><p class="text-sm text-slate-500">${idea.channel}</p></div><div class="flex items-center gap-2"><select class="status-select bg-slate-100 border-slate-200 rounded-md text-sm p-1" data-index="${index}"><option value="Planejado" ${idea.status === 'Planejado' ? 'selected' : ''}>Planejado</option><option value="Em Produção" ${idea.status === 'Em Produção' ? 'selected' : ''}>Em Produção</option><option value="Publicado" ${idea.status === 'Publicado' ? 'selected' : ''}>Publicado</option></select><button class="delete-idea text-red-500 hover:text-red-700 text-2xl" data-index="${index}" title="Remover Ideia">&times;</button></div></div>`).join('');
        };
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newIdea = {
                title: document.getElementById('idea-title').value,
                channel: channelSelect.value,
                status: 'Planejado'
            };
            appState.videoIdeas.push(newIdea);
            await saveSettings();
            renderPlanner();
            form.reset();
        });
        output.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-idea')) {
                appState.videoIdeas.splice(e.target.dataset.index, 1);
                await saveSettings();
                renderPlanner();
            }
        });
        output.addEventListener('change', async (e) => {
            if (e.target.classList.contains('status-select')) {
                appState.videoIdeas[e.target.dataset.index].status = e.target.value;
                await saveSettings();
            }
        });
        renderPlanner();
    }

    async function saveSettings() {
        if (!appState.currentUser) return;
        const settingsToSave = { 
            gemini: appState.apiKeys.gemini,
            openai: appState.apiKeys.openai,
            google_api: appState.apiKeys.google_api,
            userChannels: appState.userChannels, 
            videoIdeas: appState.videoIdeas 
        };
        await apiRequest(`/api/settings/${appState.currentUser.id}`, 'POST', { settings: settingsToSave });
    }

    // --- Event Listeners ---
    ELEMENTS.loginForm.addEventListener('submit', handleLogin);
    ELEMENTS.registerForm.addEventListener('submit', handleRegister);
    ELEMENTS.showRegister.addEventListener('click', (e) => { e.preventDefault(); showRegisterScreen(); });
    ELEMENTS.showLogin.addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });
    ELEMENTS.logoutBtn.addEventListener('click', handleLogout);
    
    ELEMENTS.sidebarNav.addEventListener('click', (event) => {
        const clickedButton = event.target.closest('.sidebar-btn');
        if (clickedButton) {
            ELEMENTS.sidebarNav.querySelectorAll('.sidebar-btn').forEach(btn => btn.classList.remove('sidebar-btn-active'));
            clickedButton.classList.add('sidebar-btn-active');
            renderTabContent(clickedButton.getAttribute('data-tab'));
        }
    });

    ELEMENTS.tabContent.addEventListener('click', (e) => {
        if (e.target.classList.contains('copy-btn')) {
            const button = e.target;
            const text = decodeURIComponent(button.dataset.copyText);
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                button.textContent = 'Copiado!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'Copiar';
                    button.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Falha ao copiar', err);
            }
            document.body.removeChild(textArea);
        }
    });

    // Mobile Menu Listeners
    ELEMENTS.openMenuBtn.addEventListener('click', () => {
        ELEMENTS.sidebar.classList.add('open');
        ELEMENTS.menuOverlay.style.display = 'block';
    });
    // Assuming there might be a close button inside the sidebar in the future
    const closeBtn = document.getElementById('close-menu-btn');
    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            ELEMENTS.sidebar.classList.remove('open');
            ELEMENTS.menuOverlay.style.display = 'none';
        });
    }
    ELEMENTS.menuOverlay.addEventListener('click', () => {
        ELEMENTS.sidebar.classList.remove('open');
        ELEMENTS.menuOverlay.style.display = 'none';
    });

    // Basic Security: Disable Dev Tools
    document.addEventListener('keydown', function (e) {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C'))) {
            e.preventDefault();
        }
    });
    </script>
</body>
</html>
