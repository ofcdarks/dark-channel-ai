<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darks Vips AI v18.3</title>
    <!-- Favicon -->
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîÆ</text></svg>">
    
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .sidebar-btn { transition: all 0.2s ease-in-out; }
        .sidebar-btn:hover { background-color: #f1f5f9; color: #334155; }
        .sidebar-btn-active { background-color: #eef2ff; color: #4f46e5; font-weight: 600; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar-container { background-color: #e0e7ff; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-bar-inner { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
        .progress-bar-indeterminate { background-size: 200% 100%; background-image: linear-gradient(to right, #e0e7ff 0%, #c7d2fe 50%, #e0e7ff 100%); animation: move-bg 2s linear infinite; }
        @keyframes move-bg { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        #login-container { display: flex; }
        #register-container, #app-container, #progress-modal, #legend-modal, #ticket-modal, #updates-modal { display: none; }
        .prose { max-width: none; }
        .copy-btn.copied { background-color: #10b981; color: white; }
        .app-title-gradient {
            background: linear-gradient(45deg, #4f46e5, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #log-panel {
            position: fixed; bottom: 0; left: 0; right: 0; background-color: #1e293b;
            color: #e2e8f0; z-index: 100; transition: max-height 0.3s ease-in-out;
            max-height: 40px; overflow: hidden; border-top: 1px solid #334155;
        }
        #log-panel.open { max-height: 300px; }
        #log-header { cursor: pointer; }
        #log-content { height: 240px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .log-entry { border-bottom: 1px solid #334155; }
        .log-info { color: #93c5fd; } .log-success { color: #4ade80; }
        .log-error { color: #f87171; } .log-warn { color: #facc15; }

        @media (max-width: 768px) {
            #app-container { flex-direction: column; }
            #sidebar { 
                position: fixed; left: -100%; top: 0; height: 100%; z-index: 40;
                transition: left 0.3s ease-in-out; width: 288px;
            }
            #sidebar.open { left: 0; }
            #main-content { margin-left: 0; }
            #menu-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.5); z-index: 30;
            }
            #app-container { padding-bottom: 40px; }
        }
    </style>
</head>
<body class="text-slate-800" oncontextmenu="return false;">

    <!-- Telas de Autentica√ß√£o -->
    <div id="login-container" class="flex items-center justify-center h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <div class="flex flex-col items-center">
                 <div id="logo-container-login" class="w-16 h-16 mb-2"></div>
                <h2 class="text-3xl font-extrabold text-center app-title-gradient">Darks Vips AI</h2>
                <p class="mt-2 text-center text-sm text-slate-600">Fa√ßa login para continuar</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div id="login-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                <input id="login-email" type="email" autocomplete="email" required class="appearance-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Endere√ßo de e-mail">
                <input id="login-password" type="password" autocomplete="current-password" required class="appearance-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Senha">
                <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Entrar</button>
            </form>
            <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-slate-200"></div><span class="flex-shrink mx-4 text-slate-400 text-xs">OU</span><div class="flex-grow border-t border-slate-200"></div></div>
            
            <div class="flex justify-center">
                <div id="g_id_onload"
                     data-client_id="483231613006-31cqno4qts2p5ut9i0s7rrnpl488aiqc.apps.googleusercontent.com"
                     data-callback="handleGoogleCredentialResponse">
                </div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
            </div>

            <p class="text-center text-sm mt-4">N√£o tem uma conta? <a href="#" id="show-register" class="font-medium text-indigo-600 hover:text-indigo-500">Registre-se</a></p>
        </div>
    </div>
    <div id="register-container" class="hidden items-center justify-center h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
             <div class="flex flex-col items-center">
                <div id="logo-container-register" class="w-16 h-16 mb-2"></div>
                <h2 class="text-3xl font-extrabold text-center text-slate-900">Criar Conta</h2>
                <p class="mt-2 text-center text-sm text-slate-600">Junte-se √† plataforma</p>
            </div>
            <form id="register-form" class="mt-8 space-y-6">
                <div id="register-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                <input id="register-email" type="email" required class="appearance-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Seu melhor e-mail">
                <input id="register-password" type="password" required class="appearance-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Crie uma senha forte">
                <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Criar Conta</button>
            </form>
            <p class="text-center text-sm">J√° tem uma conta? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">Fa√ßa login</a></p>
        </div>
    </div>

    <!-- Modais -->
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h3 class="text-lg font-semibold text-slate-800 mb-2">Processando...</h3>
            <p id="progress-phrase" class="text-sm text-slate-600 mb-4">Otimizando para o algoritmo...</p>
            <div class="w-full bg-slate-200 rounded-full h-2.5"><div class="h-2.5 rounded-full progress-bar-indeterminate"></div></div>
        </div>
    </div>

    <div id="legend-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg relative">
            <button id="close-legend-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            <h3 class="text-2xl font-bold text-slate-800 mb-4">Entenda as Pontua√ß√µes</h3>
            <div class="space-y-4 text-slate-700">
                <div>
                    <h4 class="font-semibold text-lg text-indigo-600">Pontua√ß√£o de Conte√∫do (0-100)</h4>
                    <p class="text-sm">Mede a qualidade e o potencial geral de um nicho, ideia ou v√≠deo. Pontua√ß√µes mais altas indicam maior probabilidade de sucesso. Pontua√ß√µes acima de 80 s√£o excelentes.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-indigo-600">An√°lise de Nicho/Subnicho</h4>
                    <ul class="list-disc list-inside text-sm space-y-1 mt-1">
                        <li><strong class="text-green-600">Potencial:</strong> O qu√£o promissor o tema √© para crescimento.</li>
                        <li><strong class="text-yellow-600">Concorr√™ncia (menor √© melhor):</strong> O n√≠vel de satura√ß√£o do nicho. Pontua√ß√µes menores significam um oceano azul.</li>
                        <li><strong class="text-blue-600">Volume de Busca:</strong> O interesse de busca do p√∫blico.</li>
                        <li><strong class="text-purple-600">Originalidade:</strong> O qu√£o nova e criativa a ideia √©.</li>
                        <li><strong class="text-orange-600">Hype Score:</strong> Potencial de viraliza√ß√£o do t√≥pico.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div id="ticket-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg relative">
            <button id="close-ticket-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            <h3 class="text-2xl font-bold text-slate-800 mb-4">Reportar um Problema</h3>
            <form id="ticket-form" class="space-y-4">
                <div>
                    <label for="ticket-description" class="block text-sm font-medium text-slate-700">Descreva o problema</label>
                    <textarea id="ticket-description" rows="5" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="Seja o mais detalhado poss√≠vel..." required></textarea>
                </div>
                <div>
                    <label for="ticket-screenshot" class="block text-sm font-medium text-slate-700">Anexar print da tela (opcional)</label>
                    <input type="file" id="ticket-screenshot" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                    <img id="screenshot-preview" class="hidden mt-2 rounded-md max-h-40 w-auto"/>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Enviar Ticket</button>
            </form>
        </div>
    </div>
    
    <div id="updates-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg relative">
            <button id="close-updates-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            <h3 id="updates-modal-title" class="text-2xl font-bold text-slate-800 mb-4">√öltimas Atualiza√ß√µes</h3>
            <div id="updates-modal-content" class="prose prose-sm text-slate-700"></div>
        </div>
    </div>

    <!-- Conte√∫do da Aplica√ß√£o -->
    <div id="app-container" class="hidden h-screen bg-slate-50">
        <div id="menu-overlay" class="hidden md:hidden"></div>
        <aside id="sidebar" class="w-72 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col">
            <div class="p-6 border-b flex items-center gap-3">
                <div id="logo-container-sidebar" class="w-10 h-10"></div>
                <h1 class="text-2xl font-bold app-title-gradient">Darks Vips AI</h1>
                <button id="close-menu-btn" class="md:hidden text-2xl ml-auto">&times;</button>
            </div>
            <div class="p-4 text-sm text-slate-500" id="user-email-display"></div>
            <nav id="sidebar-nav" class="p-4 space-y-1 flex-1 overflow-y-auto"></nav>
            <div class="p-4 border-t space-y-2">
                 <button id="open-ticket-btn" class="w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-amber-50 hover:text-amber-700">
                    <span>üêû</span><span>Reportar Erro</span>
                </button>
                <button id="logout-btn" class="w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-red-50 hover:text-red-700">
                    <span>üö™</span><span>Sair</span>
                </button>
            </div>
        </aside>
        <div id="main-content" class="flex-1 flex flex-col overflow-hidden">
            <header class="p-4 md:hidden bg-white border-b flex items-center">
                <button id="open-menu-btn" class="text-2xl">‚ò∞</button>
                <h2 id="mobile-header-title" class="ml-4 font-semibold text-lg">Dashboard</h2>
            </header>
            <main id="tab-content" class="flex-1 p-6 md:p-10 overflow-y-auto"></main>
        </div>
    </div>
    
    <div id="log-panel">
        <div id="log-header" class="p-2 bg-slate-700 flex justify-between items-center">
            <span class="text-sm font-semibold">Logs da Aplica√ß√£o</span>
            <span id="log-toggle-icon">‚ñ≤</span>
        </div>
        <div id="log-content" class="p-2"></div>
    </div>

    <script>
    // --- Global State & Constants ---
    let appState = {
        currentUser: null, token: null,
        apiKeys: { gemini: "", gemini_backup1: "", gemini_backup2: "", openai: "", google_api: "", openrouter: "" },
        userChannels: [], videoIdeas: [], currentGeminiKeyIndex: 0
    };

    const ELEMENTS = {
        loginContainer: document.getElementById('login-container'),
        registerContainer: document.getElementById('register-container'),
        appContainer: document.getElementById('app-container'),
        loginForm: document.getElementById('login-form'),
        registerForm: document.getElementById('register-form'),
        loginFeedback: document.getElementById('login-feedback'),
        registerFeedback: document.getElementById('register-feedback'),
        showRegister: document.getElementById('show-register'),
        showLogin: document.getElementById('show-login'),
        sidebar: document.getElementById('sidebar'),
        sidebarNav: document.getElementById('sidebar-nav'),
        tabContent: document.getElementById('tab-content'),
        progressModal: document.getElementById('progress-modal'),
        progressPhrase: document.getElementById('progress-phrase'),
        userEmailDisplay: document.getElementById('user-email-display'),
        logoutBtn: document.getElementById('logout-btn'),
        openMenuBtn: document.getElementById('open-menu-btn'),
        closeMenuBtn: document.getElementById('close-menu-btn'),
        menuOverlay: document.getElementById('menu-overlay'),
        mobileHeaderTitle: document.getElementById('mobile-header-title'),
        legendModal: document.getElementById('legend-modal'),
        closeLegendModal: document.getElementById('close-legend-modal'),
        ticketModal: document.getElementById('ticket-modal'),
        closeTicketModal: document.getElementById('close-ticket-modal'),
        openTicketBtn: document.getElementById('open-ticket-btn'),
        ticketForm: document.getElementById('ticket-form'),
        screenshotInput: document.getElementById('ticket-screenshot'),
        screenshotPreview: document.getElementById('screenshot-preview'),
        updatesModal: document.getElementById('updates-modal'),
        closeUpdatesModal: document.getElementById('close-updates-modal'),
        updatesModalTitle: document.getElementById('updates-modal-title'),
        updatesModalContent: document.getElementById('updates-modal-content'),
        logPanel: document.getElementById('log-panel'),
        logHeader: document.getElementById('log-header'),
        logContent: document.getElementById('log-content'),
        logToggleIcon: document.getElementById('log-toggle-icon')
    };

    const PROGRESS_PHRASES = [ "Decodificando o algoritmo...", "Buscando insights virais...", "Consultando os dados de tend√™ncia...", "Polindo as palavras-chave...", "Ajustando o potencial de clique..." ];
    
    const TOOL_UPDATES = {
        'dashboard': `<h4>v1.1 - 18/08/2025</h4><ul><li>Corre√ß√£o na busca de dados de canais.</li><li>Otimiza√ß√£o no carregamento do gr√°fico.</li></ul>`,
        'niche-finder': `<h4>v1.3 - 18/08/2025</h4><ul><li>Melhoria no prompt da IA para garantir pontua√ß√µes mais precisas e consistentes.</li></ul>`,
        'subniche-finder': `<h4>v1.4 - 18/08/2025</h4><ul><li>Ajuste no prompt da IA para evitar scores zerados.</li><li>Resultados agora mostram mais ideias de v√≠deo.</li></ul>`,
        'niche-analysis': `<h4>v1.5 - 18/08/2025</h4><ul><li>Corrigido erro que impedia a busca de tend√™ncias.</li><li>Melhoria no prompt da IA para garantir pontua√ß√µes mais precisas.</li></ul>`,
        'default': `<p>Nenhuma atualiza√ß√£o recente para esta ferramenta.</p>`
    };

    // --- Logging & API ---
    function log(message, type = 'info') {
        const now = new Date();
        const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        const entry = document.createElement('div');
        entry.className = `log-entry p-1 log-${type}`;
        entry.innerHTML = `<span class="font-semibold">[${timestamp}]</span>: ${message}`;
        ELEMENTS.logContent.appendChild(entry);
        ELEMENTS.logContent.scrollTop = ELEMENTS.logContent.scrollHeight;
    }

    async function apiRequest(endpoint, method, body = null) {
        log(`Iniciando requisi√ß√£o ${method} para ${endpoint}`);
        const headers = { 'Content-Type': 'application/json' };
        if (appState.token) headers['Authorization'] = `Bearer ${appState.token}`;
        
        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);

        try {
            const response = await fetch(endpoint, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Ocorreu um erro na API do servidor.');
            }
            const contentType = response.headers.get("content-type");
            const result = contentType?.includes("application/json") ? await response.json() : null;
            log(`Requisi√ß√£o para ${endpoint} bem-sucedida.`, 'success');
            return result;
        } catch (error) {
            log(`Falha na requisi√ß√£o para ${endpoint}: ${error.message}`, 'error');
            throw error;
        }
    }

    // --- Authentication ---
    function showLoginScreen() {
        ELEMENTS.registerContainer.style.display = 'none';
        ELEMENTS.loginContainer.style.display = 'flex';
    }

    function showRegisterScreen() {
        ELEMENTS.loginContainer.style.display = 'none';
        ELEMENTS.registerContainer.style.display = 'flex';
    }

    async function handleLogin(e) {
        e.preventDefault();
        log('Tentativa de login com e-mail/senha...');
        ELEMENTS.loginFeedback.textContent = '';
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            const data = await apiRequest('/api/login', 'POST', { email, password });
            appState.currentUser = data.user;
            appState.token = data.accessToken;
            await initializeApp();
        } catch (error) {
            ELEMENTS.loginFeedback.textContent = error.message;
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        log('Tentativa de registro...');
        ELEMENTS.registerFeedback.textContent = '';
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        try {
            const data = await apiRequest('/api/register', 'POST', { email, password });
            appState.currentUser = data.user;
            appState.token = data.accessToken;
            await initializeApp();
        } catch (error) {
            ELEMENTS.registerFeedback.textContent = error.message;
        }
    }
    
    window.handleGoogleCredentialResponse = async (response) => {
        log('Recebida credencial do Google. Enviando para o backend...');
        try {
            const data = await apiRequest('/api/google-login', 'POST', { credential: response.credential });
            if (data && data.user && data.accessToken) {
                appState.currentUser = data.user;
                appState.token = data.accessToken;
                await initializeApp();
            } else {
                throw new Error("Resposta do servidor inv√°lida ap√≥s login com Google.");
            }
        } catch (error) {
            document.getElementById('login-feedback').textContent = 'Falha no login com Google: ' + error.message;
            log('Falha no login com Google: ' + error.message, 'error');
        }
    }
    
    function handleLogout() {
        log('Usu√°rio deslogado.');
        appState = { currentUser: null, token: null, apiKeys: { gemini: "", gemini_backup1: "", gemini_backup2: "", openai: "", google_api: "", openrouter: "" }, userChannels: [], videoIdeas: [], currentGeminiKeyIndex: 0 };
        ELEMENTS.appContainer.style.display = 'none';
        showLoginScreen();
        document.getElementById('login-form').reset();
    }

    // --- App Initialization & UI ---
    async function initializeApp() {
        if (!appState.currentUser || !appState.token) {
            log('Falha na inicializa√ß√£o: usu√°rio ou token ausente.', 'error');
            return;
        }
        log(`Inicializando aplica√ß√£o para ${appState.currentUser.email}...`);
        
        try {
            const settings = await apiRequest(`/api/settings/${appState.currentUser.id}`, 'GET');
            if (settings && Object.keys(settings).length > 0) {
                appState.apiKeys = { ...appState.apiKeys, ...settings };
                appState.userChannels = settings.userChannels || [];
                appState.videoIdeas = settings.videoIdeas || [];
            }
            log('Configura√ß√µes do usu√°rio carregadas.', 'success');
        } catch(error) {
            log(`N√£o foi poss√≠vel carregar as configura√ß√µes: ${error.message}`, 'warn');
        }

        ELEMENTS.userEmailDisplay.textContent = appState.currentUser.name || appState.currentUser.email;
        ELEMENTS.loginContainer.style.display = 'none';
        ELEMENTS.registerContainer.style.display = 'none';
        ELEMENTS.appContainer.style.display = 'flex';
        
        buildSidebar();
        renderTabContent('dashboard');
    }

    function buildSidebar() {
        const navItems = [
            { id: 'dashboard', icon: 'üìà', label: 'Dashboard' },
            { type: 'divider', label: 'PESQUISA E ESTRAT√âGIA' },
            { id: 'niche-finder', icon: 'üîé', label: 'Localizador de Nichos' },
            { id: 'subniche-finder', icon: 'üíé', label: 'Explorador de Subnichos' },
            { id: 'niche-analysis', icon: 'üìä', label: 'An√°lise de Nicho' },
            { id: 'video-optimizer', icon: 'üöÄ', label: 'Analisador de V√≠deo' },
            { id: 'competitor-analysis', icon: 'üïµÔ∏è', label: 'An√°lise de Concorr√™ncia' },
            { id: 'comment-analyzer', icon: 'üí¨', label: 'An√°lise de Coment√°rios' },
            { type: 'divider', label: 'CRIA√á√ÉO E CONTE√öDO' },
            { id: 'title-structures', icon: 'üèóÔ∏è', label: 'Estruturas de T√≠tulos' },
            { id: 'script-writer', icon: 'üìú', label: 'Criador de Roteiros' },
            { id: 'shorts-script-writer', icon: '‚ö°', label: 'Roteiros para Shorts' },
            { id: 'content-recycler', icon: '‚ôªÔ∏è', label: 'Reciclador de Conte√∫do' },
            { id: 'visual-storyboard', icon: 'üé¨', label: 'Storyboard Visual' },
            { id: 'thumbnail-prompts', icon: 'üé®', label: 'Prompts de Thumbnail' },
            { type: 'divider', label: 'OTIMIZA√á√ÉO E GEST√ÉO' },
            { id: 'description-optimizer', icon: 'üìÑ', label: 'Otimizador de Descri√ß√£o' },
            { id: 'tag-generator', icon: 'üè∑Ô∏è', label: 'Gerador de Tags' },
            { id: 'channel-organizer', icon: 'üì∫', label: 'Organizador de Canais' },
            { id: 'planner', icon: 'üóìÔ∏è', label: 'Planejador de Conte√∫do' },
            { id: 'monetization-helper', icon: 'üí∞', label: 'Ideias de Monetiza√ß√£o' },
            { id: 'settings', icon: '‚öôÔ∏è', label: 'Configura√ß√µes' },
        ];

        ELEMENTS.sidebarNav.innerHTML = navItems.map(item => {
            if (item.type === 'divider') {
                return `<div class="pt-2 mt-2 border-t"><span class="px-4 text-xs font-semibold text-slate-400">${item.label}</span></div>`;
            }
            return `<button class="sidebar-btn ${item.id === 'dashboard' ? 'sidebar-btn-active' : ''} w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg" data-tab="${item.id}"><span>${item.icon}</span><span>${item.label}</span></button>`;
        }).join('');
    }
    
    // --- Utility Functions ---
    const showProgressModal = () => { ELEMENTS.progressModal.style.display = 'flex'; ELEMENTS.progressPhrase.textContent = PROGRESS_PHRASES[Math.floor(Math.random() * PROGRESS_PHRASES.length)]; };
    const hideProgressModal = () => { ELEMENTS.progressModal.style.display = 'none'; };
    const getScoreColor = (score) => score >= 80 ? 'bg-green-500' : score >= 50 ? 'bg-yellow-500' : 'bg-red-500';
    const getScoreTextColor = (score) => score >= 80 ? 'text-green-500' : score >= 50 ? 'text-yellow-500' : 'text-red-500';
    const createCopyButton = (text) => `<button class="copy-btn text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded hover:bg-slate-300" data-copy-text="${encodeURIComponent(text)}">Copiar</button>`;
    const createCorrectButton = (text) => {
        if (!appState.apiKeys.openrouter) return '';
        return `<button class="correct-btn text-xs bg-slate-500 text-white px-2 py-1 rounded hover:bg-slate-600 ml-2" data-correct-text="${encodeURIComponent(text)}">Revisar com OpenRouter</button>`;
    };
    
    const getTrendLevel = (score) => {
        if (score > 66) return "Alto";
        if (score > 33) return "M√©dio";
        return "Baixo";
    };

    const renderScoreCard = (title, mainScore, subScores, suggestion, isNovel = false) => {
        const intMainScore = Math.round(Math.min(100, mainScore || 0));
        const novelBadge = isNovel ? '<span class="inline-flex items-center rounded-md bg-purple-100 px-2 py-1 text-xs font-medium text-purple-700">‚ú® In√©dita</span>' : '';
        const subScoresHtml = Object.entries(subScores).map(([key, value]) => {
            let displayValue = typeof value === 'number' ? `${Math.round(value)}/100` : value;
            let color = 'text-slate-700';
            let progress = '';

            if (key.includes('Busca')) {
                 displayValue = getTrendLevel(value);
                 color = displayValue === 'Alto' ? 'text-green-500' : displayValue === 'M√©dio' ? 'text-yellow-500' : 'text-red-500';
            } else if (typeof value === 'number') {
                color = getScoreTextColor(value);
                progress = `<div class="progress-bar-container"><div class="progress-bar-inner ${getScoreColor(value)}" style="width: ${value}%;"></div></div>`;
            } else {
                 color = value === 'Positiva' ? 'text-green-500' : value === 'Negativa' ? 'text-red-500' : value === 'Mista' ? 'text-yellow-500' : 'text-slate-700';
            }
            
            return `
            <div class="mb-2">
                <div class="flex justify-between items-center text-sm mb-1"><span class="text-slate-600">${key}</span><span class="font-semibold ${color}">${displayValue}</span></div>
                ${progress}
            </div>`;
        }).join('');
        return `<div class="bg-white p-4 rounded-lg border w-full md:w-72 flex-shrink-0">
                    <h4 class="font-semibold text-slate-800 mb-2">${title}</h4>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-baseline gap-1">
                            <span class="text-3xl font-bold ${getScoreTextColor(intMainScore)}">${intMainScore}</span>
                            <span class="text-slate-500 text-sm">/ 100</span>
                        </div>
                        ${novelBadge}
                    </div>
                    ${subScoresHtml}
                    ${suggestion ? `<p class="text-xs text-slate-500 mt-4"><strong class="text-slate-600">A Virada de Chave:</strong> ${suggestion}</p>` : ''}
                </div>`;
    };

    // --- Gemini API Call with Key Rotation ---
    function getAvailableGeminiKeys() {
        return [appState.apiKeys.gemini, appState.apiKeys.gemini_backup1, appState.apiKeys.gemini_backup2].filter(key => key && key.trim() !== '');
    }

    async function callGenerativeAPI(prompt, schema = null) {
        const availableKeys = getAvailableGeminiKeys();
        if (availableKeys.length === 0) {
            log("Nenhuma chave da API Gemini configurada.", 'error');
            hideProgressModal();
            throw new Error("Nenhuma chave da API Gemini encontrada. Por favor, adicione-a nas Configura√ß√µes.");
        }
        showProgressModal();
        for (let i = 0; i < availableKeys.length; i++) {
            const currentKey = availableKeys[appState.currentGeminiKeyIndex % availableKeys.length];
            log(`Tentando chamada √† API com a chave #${appState.currentGeminiKeyIndex + 1}`);
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${currentKey}`;
            const finalPrompt = `Responda em texto puro (plain text), sem usar formata√ß√£o markdown. Use codifica√ß√£o UTF-8. ${prompt}`;
            let payload = { contents: [{ role: "user", parts: [{ text: finalPrompt }] }] };
            if (schema) {
                payload.generationConfig = { response_mime_type: "application/json", response_schema: schema };
            }
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });
                clearTimeout(timeoutId);
                if (response.ok) {
                    const result = await response.json();
                     if (result.candidates?.[0]?.content?.parts?.[0]) {
                        log('API Gemini respondeu com sucesso.', 'success');
                        hideProgressModal();
                        const text = result.candidates[0].content.parts[0].text;
                        try { return schema ? JSON.parse(text) : { text }; }
                        catch (jsonError) {
                            log(`Erro ao parsear JSON da API: ${jsonError.message}`, 'error');
                            log(`Resposta de texto recebida: ${text}`, 'info');
                            throw new Error("A IA retornou uma resposta em formato inesperado. Tente novamente.");
                        }
                    }
                    if (result.candidates?.[0]?.finishReason === 'SAFETY') throw new Error("A resposta foi bloqueada por pol√≠ticas de seguran√ßa.");
                    throw new Error("Resposta da API inv√°lida ou vazia.");
                }
                if (response.status === 429 || response.status >= 500) {
                    log(`Erro ${response.status} com a chave #${appState.currentGeminiKeyIndex + 1}. Tentando a pr√≥xima...`, 'warn');
                    appState.currentGeminiKeyIndex++;
                    if (i < availableKeys.length - 1) continue;
                    throw new Error("Todas as chaves da API Gemini falharam ou excederam a cota.");
                }
                const errorBody = await response.json();
                throw new Error(`Erro na API: ${response.status} - ${errorBody.error?.message || 'Verifique sua chave de API.'}`);
            } catch (error) {
                log(`Erro na chamada da API com a chave #${appState.currentGeminiKeyIndex + 1}: ${error.message}`, 'error');
                appState.currentGeminiKeyIndex++;
                if (i === availableKeys.length - 1) {
                    hideProgressModal();
                    throw error;
                }
            }
        }
        hideProgressModal();
        throw new Error("Todas as chaves da API Gemini falharam.");
    }

    // --- OpenRouter API Call ---
    async function correctTextWithOpenRouter(text) {
        const openrouterKey = appState.apiKeys.openrouter || "";
        if (!openrouterKey) {
            log("Chave da API OpenRouter n√£o encontrada.", 'warn');
            return text;
        }
        showProgressModal();
        try {
            const response = await apiRequest('/api/correct-text', 'POST', { text, openrouterKey });
            return response.text;
        } catch (error) {
            hideProgressModal();
            throw error;
        }
    }
    
    // --- Tools Content & Handlers ---
    let trendsChartInstance = null;
    
    const tools = {
        "dashboard": { title: "Dashboard de Performance", desc: "Selecione um canal para ver as m√©tricas e obter insights da IA.", content: `<div id="dashboard-container"></div>` },
        "niche-finder": { title: "Localizador de Nichos", desc: "Encontre nichos e tend√™ncias de mercado com estimativas de RPM.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="niche-keyword" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Palavra-chave (opcional)"><select id="niche-country" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="BR">Brasil</option><option value="US">EUA</option><option value="PT">Portugal</option></select></div><button id="generate-niches" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üîé Encontrar Nichos</button><div id="output" class="mt-6"></div><button id="generate-more-niches" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button></div>` },
        "subniche-finder": { title: "Explorador de Subnichos", desc: "Descubra subnichos inexplorados a partir de um nicho principal.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="main-niche" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nicho principal (ou deixe em branco)"><select id="subniche-country" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="BR">Brasil</option><option value="US">EUA</option><option value="PT">Portugal</option></select></div><button id="find-subniches" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üíé Explorar Subnichos</button><div id="output" class="mt-6"></div><button id="generate-more-subniches" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button></div>` },
        "niche-analysis": { title: "An√°lise de Nicho (RPM/Hype)", desc: "Analise o potencial de um nicho espec√≠fico.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="analysis-niche" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nicho a ser analisado"><select id="analysis-country" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="BR">Brasil</option><option value="US">EUA</option><option value="PT">Portugal</option></select></div><button id="analyze-niche" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üìä Analisar Nicho</button><div id="output" class="mt-6"></div></div>` },
        "video-optimizer": { title: "Analisador de V√≠deo (URL)", desc: "Otimize t√≠tulos, descri√ß√µes e tags a partir de uma URL do YouTube.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="url" id="video-url" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="https://www.youtube.com/watch?v=..."><button id="analyze-video" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üöÄ Otimizar V√≠deo</button><div id="output" class="mt-6"></div></div>` },
        "competitor-analysis": { title: "An√°lise de Concorr√™ncia", desc: "Analise a estrat√©gia de canais concorrentes para encontrar oportunidades.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="competitor-channel-id" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="ID do Canal concorrente (Ex: UC_x5XG1OV2P6uZZ5FSM9Ttw)"><button id="analyze-competitor" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üïµÔ∏è Analisar Concorrente</button><div id="output" class="mt-6"></div></div>` },
        "comment-analyzer": { title: "An√°lise de Coment√°rios", desc: "Entenda o sentimento do p√∫blico e extraia ideias dos coment√°rios de um v√≠deo.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="url" id="comment-video-url" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="URL do v√≠deo para analisar os coment√°rios"><button id="analyze-comments" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üí¨ Analisar Coment√°rios</button><div id="output" class="mt-6"></div></div>` },
        "title-structures": { title: "Estruturas de T√≠tulos Virais", desc: "Gere estruturas de t√≠tulos com alto potencial de clique.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="structure-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="T√≥pico. Ex: Produtividade"><select id="structure-lang" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="pt-BR">Portugu√™s</option><option value="en-US">Ingl√™s</option></select></div><button id="generate-structures" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üèóÔ∏è Gerar Estruturas</button><div id="output" class="mt-6 space-y-4"></div><button id="generate-more-structures" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button></div>` },
        "script-writer": { title: "Criador de Roteiros", desc: "Gere roteiros com foco em alta reten√ß√£o.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="space-y-4"><input type="text" id="script-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="T√≥pico do V√≠deo"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="number" id="script-duration" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Dura√ß√£o (minutos)"><input type="number" id="script-parts" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="N¬∫ de Partes"></div><div class="flex items-center"><input id="script-narration-only" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="script-narration-only" class="ml-2 block text-sm text-gray-900">Apenas Narra√ß√£o (sem di√°logos)</label></div><button id="generate-script" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üìú Gerar Roteiro</button></div><div id="output" class="mt-6"></div></div>` },
        "shorts-script-writer": { title: "Roteiros para Shorts", desc: "Crie roteiros r√°pidos e din√¢micos para v√≠deos verticais.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="shorts-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="T√≥pico do v√≠deo curto"><button id="generate-shorts-script" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">‚ö° Gerar Roteiro de Short</button><div id="output" class="mt-6"></div></div>` },
        "content-recycler": { title: "Reciclador de Conte√∫do", desc: "Transforme um roteiro de v√≠deo longo em v√°rias ideias para v√≠deos curtos.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><textarea id="recycler-script" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" rows="10" placeholder="Cole aqui o roteiro do seu v√≠deo longo..."></textarea><button id="recycle-content" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">‚ôªÔ∏è Reciclar Conte√∫do</button><div id="output" class="mt-6"></div></div>` },
        "visual-storyboard": { title: "Storyboard Visual", desc: "Transforme seu roteiro em um guia de cenas e visuais.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><textarea id="storyboard-script" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" rows="8" placeholder="Cole seu roteiro aqui..."></textarea><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div class="grid grid-cols-2 gap-2"><input type="number" id="storyboard-minutes" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Minutos"><input type="number" id="storyboard-seconds" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Segundos"></div><div class="grid grid-cols-2 gap-2"><input type="number" id="storyboard-scene-seconds" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Segs / cena"><input type="number" id="storyboard-words-scene" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Palavras / cena"></div></div><button id="generate-storyboard" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üé¨ Criar Storyboard</button><div id="output" class="mt-6"></div></div>` },
        "thumbnail-prompts": { title: "Prompts de Thumbnail", desc: "Gere prompts otimizados para IAs de imagem.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="space-y-4"><input type="text" id="thumb-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="T√≠tulo do V√≠deo"><select id="thumb-platform" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="Midjourney">Midjourney</option><option value="Leonardo.AI">Leonardo.AI</option><option value="DALL-E 3">DALL-E 3</option></select></div><button id="generate-prompts" class="w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üé® Gerar Prompts</button><div id="output" class="mt-6 space-y-4"></div><button id="generate-more-prompts" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button></div>` },
        "description-optimizer": { title: "Otimizador de Descri√ß√£o", desc: "Crie descri√ß√µes com SEO e CTAs eficazes.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="desc-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="T√≠tulo do V√≠deo"><textarea id="desc-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" rows="4" placeholder="Resumo do v√≠deo e palavras-chave..."></textarea><button id="generate-description" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üìÑ Gerar Descri√ß√£o</button><div id="output" class="mt-6"></div></div>` },
        "tag-generator": { title: "Gerador de Tags", desc: "Gere tags relevantes para maximizar o alcance.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="tag-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="T√≥pico do V√≠deo"><select id="tag-lang" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="pt-BR">Portugu√™s</option><option value="en-US">Ingl√™s</option></select></div><button id="generate-tags" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üè∑Ô∏è Gerar Tags</button><div id="output" class="mt-6"></div></div>` },
        "channel-organizer": { title: "Organizador de Canais", desc: "Adicione e gerencie as informa√ß√µes e estrat√©gias dos seus canais.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border mb-6"><h3 class="text-lg font-semibold mb-4">Adicionar Novo Canal</h3><form id="channel-form" class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="org-channel-name" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nome do Canal" required><input type="text" id="org-channel-niche" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nicho Principal" required><select id="org-channel-lang" class="px-4 py-3 bg-slate-100 border rounded-lg"><option value="pt-BR">Portugu√™s (BR)</option><option value="en-US">Ingl√™s (US)</option></select><input type="number" id="org-videos-week" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="V√≠deos por Semana" required><input type="text" id="org-post-time" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Hor√°rio de Postagem. Ex: 18:00"><input type="number" id="org-backlog-qty" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Qtd. de V√≠deos no Backlog"><button type="submit" class="md:col-span-2 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Adicionar Canal</button></form></div><div id="organizer-output" class="space-y-4"></div>` },
        "planner": { title: "Planejador de Conte√∫do", desc: "Organize suas ideias de v√≠deo, agende postagens e receba alertas.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border mb-6"><h3 class="text-lg font-semibold mb-4">Adicionar Nova Ideia</h3><form id="planner-form" class="space-y-4"><select id="planner-channel-select" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" required><option value="">Selecione um Canal</option></select><input type="text" id="idea-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="T√≠tulo da ideia de v√≠deo" required><input type="datetime-local" id="idea-datetime" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" title="Data e hora de postagem"><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Adicionar ao Planejamento</button></form></div><div id="planner-output" class="space-y-4"></div>` },
        "monetization-helper": { title: "Ideias de Monetiza√ß√£o", desc: "Descubra novas formas de monetizar seu canal al√©m do AdSense.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><select id="monetization-channel-select" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4"><option value="">Selecione um canal cadastrado</option></select><button id="generate-monetization-ideas" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üí∞ Gerar Ideias</button><div id="output" class="mt-6"></div></div>` },
        "settings": { title: "Configura√ß√µes", desc: "Gerencie suas chaves de API.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border space-y-6"><div><h3 class="text-lg font-semibold">Chaves de API</h3><div class="space-y-4 mt-2"><div><label class="block text-sm font-medium text-slate-700">Gemini API Key (Principal)</label><input type="password" id="gemini-key" class="mt-1 block w-full px-3 py-2 border rounded-md"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-indigo-600 hover:underline">Obter chave do Google AI Studio</a></div><div><label class="block text-sm font-medium text-slate-700">Gemini API Key (Reserva 1)</label><input type="password" id="gemini-key-backup1" class="mt-1 block w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium text-slate-700">Gemini API Key (Reserva 2)</label><input type="password" id="gemini-key-backup2" class="mt-1 block w-full px-3 py-2 border rounded-md"></div><div><label class="block text-sm font-medium text-slate-700">OpenRouter API Key (Opcional)</label><input type="password" id="openrouter-key" class="mt-1 block w-full px-3 py-2 border rounded-md"><a href="https://openrouter.ai/keys" target="_blank" class="text-xs text-indigo-600 hover:underline">Obter chave da OpenRouter</a></div><div><label class="block text-sm font-medium text-slate-700">Google API Key (YouTube Data)</label><input type="password" id="google-api-key" class="mt-1 block w-full px-3 py-2 border rounded-md"><p class="text-xs text-slate-500 mt-1">Usada para buscar dados de canais e v√≠deos do YouTube.</p><a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-xs text-indigo-600 hover:underline">Obter chave do Google Cloud (com YouTube Data API v3 ativada)</a></div></div></div><button id="save-settings" class="w-full bg-indigo-800 text-white font-bold py-3 px-4 rounded-lg mt-6">Salvar Configura√ß√µes</button><div id="settings-feedback" class="mt-4 min-h-[20px]"></div></div>` },
    };
    
    // --- Handlers para as ferramentas
    const handlers = {
        'generate-niches': async (output, append = false) => {
            try {
                const keyword = document.getElementById('niche-keyword').value || 't√≥picos em alta';
                const country = document.getElementById('niche-country').value;
                const prompt = `Como um especialista em YouTube, gere EXATAMENTE 3 nichos promissores para o YouTube sobre '${keyword}' para o pa√≠s ${country}. Para cada nicho, atribua pontua√ß√µes realistas e N√ÉO-ZERADAS de 60 a 95 para "Potencial", de 10 a 80 para "Concorr√™ncia" (onde 10 √© baixo e 80 √© alto), e de 50 a 95 para "Volume de Busca". O score de Potencial deve ser o principal indicador de qualidade. Forne√ßa tamb√©m uma estimativa de RPM realista (ex: 4.50), n√£o pode ser zero.`;
                const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { niche_name: { type: "STRING" }, description: { type: "STRING" }, unexplored_subniches: { type: "ARRAY", items: { type: "STRING" } }, rpm_estimate_value: { type: "NUMBER" }, scores: { type: "OBJECT", properties: { Potencial: { type: "NUMBER" }, Concorr√™ncia: { type: "NUMBER" }, "Volume de Busca": { type: "NUMBER" } } }, suggestion: { type: "STRING" } } } };
                const result = await callGenerativeAPI(prompt, schema);
                const html = result.map(item => {
                    const concorrencia = item.scores?.Concorr√™ncia ?? 50;
                    return `<div class="bg-slate-100 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4"><div class="flex-1"><h3 class="font-semibold text-lg mb-2">${item.niche_name} ${createCopyButton(item.niche_name)}</h3><p class="text-sm text-slate-700">${item.description || 'Sem descri√ß√£o.'}</p><p class="mt-2 font-semibold text-sm">RPM Estimado: $${(item.rpm_estimate_value || 0).toFixed(2)}</p><p class="mt-2 font-semibold text-sm">Subnichos Inexplorados: ${(item.unexplored_subniches || []).join(', ')}</p></div>${renderScoreCard('An√°lise de Nicho', item.scores.Potencial, { 'Potencial': item.scores.Potencial, 'Concorr√™ncia (menor √© melhor)': 100 - concorrencia, 'Busca': item.scores['Volume de Busca'] }, item.suggestion)}</div>`;
                }).join('');
                if (append) output.insertAdjacentHTML('beforeend', html); else output.innerHTML = html;
                document.getElementById('generate-more-niches').style.display = 'block';
            } catch(error) { output.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'find-subniches': async (output, append = false) => {
            try {
                let mainNiche = document.getElementById('main-niche').value.trim() || "qualquer nicho com alta demanda e baixa concorr√™ncia";
                const country = document.getElementById('subniche-country').value;
                const prompt = `Para o nicho principal de "${mainNiche}", no pa√≠s ${country}, gere EXATAMENTE 3 subnichos criativos. Para cada um, **IMPORTANTE**: Atribua pontua√ß√µes realistas e N√ÉO-ZERADAS de 0 a 100 para "Potencial" (entre 60-95), "Concorr√™ncia" (onde um valor baixo como 15 √© melhor que um alto como 80), e "Originalidade" (entre 50-98).`;
                const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { subniche_name: { type: "STRING" }, description: { type: "STRING" }, video_ideas: { type: "ARRAY", items: { type: "STRING" } }, is_novel: { type: "BOOLEAN" }, scores: { type: "OBJECT", properties: { Potencial: { type: "NUMBER" }, Concorr√™ncia: { type: "NUMBER" }, "Originalidade": { type: "NUMBER" } } }, suggestion: { type: "STRING" } } } };
                const result = await callGenerativeAPI(prompt, schema);
                const html = result.map(item => {
                    const mainScore = item.scores?.Potencial || 0;
                    const subScores = { 'Potencial': item.scores?.Potencial || 0, 'Concorr√™ncia (menor √© melhor)': 100 - (item.scores?.Concorr√™ncia || 50), 'Originalidade': item.scores?.Originalidade || 0 };
                    return `<div class="bg-slate-100 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4"><div class="flex-1"><h3 class="font-semibold text-lg mb-2">${item.subniche_name} ${createCopyButton(item.subniche_name)}</h3><p class="text-sm text-slate-700">${item.description || ''}</p><p class="mt-2 font-semibold text-sm">Ideias de V√≠deo: ${(item.video_ideas || []).join('; ')}</p></div>${renderScoreCard('An√°lise do Subnicho', mainScore, subScores, item.suggestion, item.is_novel)}</div>`;
                }).join('');
                if (append) output.insertAdjacentHTML('beforeend', html); else output.innerHTML = html;
                document.getElementById('generate-more-subniches').style.display = 'block';
            } catch (error) { output.innerHTML = `<p class="text-red-500">Ocorreu um erro ao buscar os subnichos: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'analyze-niche': async (output) => {
            const niche = document.getElementById('analysis-niche').value.trim();
            const country = document.getElementById('analysis-country').value;
            if (!niche) { output.innerHTML = `<p class="text-red-500">Insira um nicho para an√°lise.</p>`; return; }
            showProgressModal();
            try {
                const prompt = `Analise o nicho "${niche}" para YouTube no pa√≠s ${country}. Forne√ßa uma estimativa de RPM, canais de refer√™ncia, uma sugest√£o estrat√©gica e uma pontua√ß√£o de "hype" (potencial de viraliza√ß√£o) realista e N√ÉO-ZERADA entre 50 e 98.`;
                const schema = { type: "OBJECT", properties: { niche_name: { type: "STRING" }, rpm_estimate_value: { type: "NUMBER" }, hype_score: { type: "NUMBER" }, reference_channels: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, url: { type: "STRING" } } } }, suggestion: { type: "STRING" } } };
                const [result, trendsData] = await Promise.all([ callGenerativeAPI(prompt, schema), apiRequest(`/api/google-trends/${encodeURIComponent(niche)}/${country}`, 'GET') ]);
                
                const channelsHtml = result.reference_channels.map(ch => `<a href="${ch.url}" target="_blank" class="text-indigo-600 hover:underline">${ch.name}</a>`).join(', ');
                
                let avgInterest = 50, trendsChartHtml = '<p class="text-xs text-slate-500 mt-2">Dados de tend√™ncia indispon√≠veis.</p>', labels = [], values = [];
                if (trendsData?.default?.timelineData?.length > 0) {
                    const timelineData = trendsData.default.timelineData;
                    labels = timelineData.map(d => new Date(d.time * 1000).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }));
                    values = timelineData.map(d => d.value[0]);
                    avgInterest = Math.round(values.reduce((a, b) => a + b, 0) / values.length);
                    trendsChartHtml = `<div class="h-64 relative"><canvas id="trends-chart"></canvas></div><div class="text-xs text-slate-500 mt-2 p-2 bg-slate-50 rounded-md"><strong>M√©dia de Interesse: ${avgInterest}/100</strong>.</div>`;
                }

                output.innerHTML = `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><h3 class="font-semibold text-lg">${result.niche_name}</h3><p class="text-sm mt-1">RPM Estimado: <strong>$${(result.rpm_estimate_value || 0).toFixed(2)}</strong></p><p class="text-sm mt-1">Canais de Refer√™ncia: ${channelsHtml}</p></div>${renderScoreCard('An√°lise de Nicho', result.hype_score, { 'Hype Score': result.hype_score, 'Potencial de RPM': (result.rpm_estimate_value || 0) * 10, 'Busca': avgInterest }, result.suggestion)}</div><div id="trends-chart-container" class="mt-6 bg-white p-4 rounded-lg border"><h4 class="font-semibold text-slate-800 mb-2">Tend√™ncia de Interesse (√öltimos 12 meses)</h4>${trendsChartHtml}</div>`;
                
                if (values.length > 0) {
                    const ctx = document.getElementById('trends-chart').getContext('2d');
                    if (trendsChartInstance) trendsChartInstance.destroy();
                    trendsChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: `Interesse em "${niche}"`, data: values, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false } });
                }
            } catch (error) { output.innerHTML = `<p class="text-red-500">Erro ao analisar o nicho: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'analyze-video': async (output) => {
            const url = document.getElementById('video-url').value.trim();
            if (!url) { output.innerHTML = `<p class="text-red-500">Insira uma URL v√°lida do YouTube.</p>`; return; }
            const videoIdMatch = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/);
            if (!videoIdMatch) { output.innerHTML = `<p class="text-red-500">URL inv√°lida.</p>`; return; }
            const videoId = videoIdMatch[1];
            showProgressModal();
            try {
                const videoData = await apiRequest(`/api/video-details/${videoId}`, 'GET');
                const { title, description, tags } = videoData;
                const prompt = `Analise os metadados de um v√≠deo e crie vers√µes otimizadas. DADOS: T√≠tulo: "${title}", Descri√ß√£o: "${description}", Tags: "${tags.join(', ')}". TAREFA: 1. Analise cada item e d√™ uma pontua√ß√£o de 0 a 100. 2. Crie 3 novos t√≠tulos, 1 nova descri√ß√£o e 1 novo conjunto de tags, com pontua√ß√µes melhoradas.`;
                const schema = { type: "OBJECT", properties: { analysis: { type: "OBJECT", properties: { title: { type: "OBJECT", properties: { score: { type: "NUMBER" }, critique: { type: "STRING" } } }, description: { type: "OBJECT", properties: { score: { type: "NUMBER" }, critique: { type: "STRING" } } }, tags: { type: "OBJECT", properties: { score: { type: "NUMBER" }, critique: { type: "STRING" } } } } }, optimizations: { type: "OBJECT", properties: { titles: { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } } }, description: { type: "OBJECT", properties: { text: { type: "STRING" }, hashtags: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } }, tags: { type: "OBJECT", properties: { tag_list: { type: "ARRAY", items: { type: "STRING" } }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } } } } } };
                const result = await callGenerativeAPI(prompt, schema);
                const html = `
                    <div class="bg-white p-4 rounded-lg shadow-sm border mb-6">
                        <h3 class="font-bold text-xl mb-2">An√°lise do V√≠deo Original</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${renderScoreCard('T√≠tulo Original', result.analysis.title.score, {}, result.analysis.title.critique)}
                            ${renderScoreCard('Descri√ß√£o Original', result.analysis.description.score, {}, result.analysis.description.critique)}
                            ${renderScoreCard('Tags Originais', result.analysis.tags.score, {}, result.analysis.tags.critique)}
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <h3 class="font-bold text-xl mb-4">Vers√µes Otimizadas pela IA</h3>
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-lg mb-2">Novos T√≠tulos</h4>
                                <div class="space-y-4">
                                    ${result.optimizations.titles.map(t => `<div class="bg-slate-100 p-3 rounded-lg flex items-center justify-between"><span class="flex-1">${t.title}</span><div class="ml-4 flex-shrink-0 flex items-center">${createCopyButton(t.title)}</div></div>`).join('')}
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg mb-2">Nova Descri√ß√£o</h4>
                                <div class="bg-slate-100 p-3 rounded-lg relative">
                                    <p class="text-sm whitespace-pre-wrap">${result.optimizations.description.text}</p>
                                    <p class="text-xs text-indigo-700 mt-2">${result.optimizations.description.hashtags}</p>
                                    <div class="absolute top-2 right-2">${createCopyButton(result.optimizations.description.text + ' ' + result.optimizations.description.hashtags)}</div>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg mb-2">Novas Tags</h4>
                                <div class="bg-slate-100 p-3 rounded-lg flex items-center justify-between">
                                    <p class="flex-1 text-sm">${result.optimizations.tags.tag_list.join(', ')}</p>
                                    <div class="ml-4 flex-shrink-0">${createCopyButton(result.optimizations.tags.tag_list.join(', '))}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                output.innerHTML = html;
            } catch (error) { output.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'analyze-competitor': async (output) => {
            const channelId = document.getElementById('competitor-channel-id').value.trim();
            if (!channelId) { output.innerHTML = `<p class="text-red-500">Insira o ID do canal concorrente.</p>`; return; }
            showProgressModal();
            try {
                const videoData = await apiRequest(`/api/youtube-recent-videos/${channelId}`, 'GET');
                const titles = videoData.map(v => v.title).join('; ');
                const prompt = `Analise os t√≠tulos dos v√≠deos recentes de um canal concorrente e identifique a estrat√©gia de conte√∫do, as palavras-chave mais usadas e 5 ideias de v√≠deos que seriam bem-sucedidas neste canal. T√çTULOS: ${titles}.`;
                const schema = { type: "OBJECT", properties: { strategy_analysis: { type: "STRING" }, keywords: { type: "ARRAY", items: { type: "STRING" } }, new_video_ideas: { type: "ARRAY", items: { type: "STRING" } } } };
                const result = await callGenerativeAPI(prompt, schema);
                const html = `
                    <div class="bg-white p-4 rounded-lg shadow-sm border space-y-4">
                        <h3 class="font-bold text-lg mb-2">An√°lise de Estrat√©gia</h3>
                        <p class="text-sm">${result.strategy_analysis}</p>
                        <h4 class="font-semibold">Palavras-chave Relevantes:</h4>
                        <p class="text-sm">${result.keywords.join(', ')}</p>
                        <h4 class="font-semibold">Ideias de V√≠deos Potenciais:</h4>
                        <ul class="list-disc list-inside text-sm">
                            ${result.new_video_ideas.map(idea => `<li>${idea}</li>`).join('')}
                        </ul>
                    </div>
                `;
                output.innerHTML = html;
            } catch (error) { output.innerHTML = `<p class="text-red-500">Erro ao analisar o concorrente: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'analyze-comments': async (output) => {
            const url = document.getElementById('comment-video-url').value.trim();
            if (!url) { output.innerHTML = `<p class="text-red-500">Insira uma URL v√°lida do YouTube.</p>`; return; }
            const videoIdMatch = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/);
            if (!videoIdMatch) { output.innerHTML = `<p class="text-red-500">URL inv√°lida.</p>`; return; }
            const videoId = videoIdMatch[1];
            showProgressModal();
            try {
                const comments = await apiRequest(`/api/video-comments/${videoId}`, 'GET');
                const prompt = `Analise o sentimento e a inten√ß√£o dos seguintes coment√°rios de um v√≠deo do YouTube. Resuma o sentimento geral (Positivo, Negativo, Misto) e extraia 3 perguntas ou ideias de conte√∫do mais frequentes. COMENT√ÅRIOS: ${comments.join('; ')}`;
                const schema = { type: "OBJECT", properties: { sentiment: { type: "STRING" }, summary: { type: "STRING" }, ideas: { type: "ARRAY", items: { type: "STRING" } } } };
                const result = await callGenerativeAPI(prompt, schema);
                const html = `
                    <div class="bg-white p-4 rounded-lg shadow-sm border space-y-4">
                        <h3 class="font-bold text-lg mb-2">An√°lise de Sentimento</h3>
                        <p class="text-sm">Sentimento Geral: <strong class="${getScoreTextColor(result.sentiment === 'Positivo' ? 80 : result.sentiment === 'Misto' ? 50 : 20)}">${result.sentiment}</strong></p>
                        <p class="text-sm">${result.summary}</p>
                        <h4 class="font-semibold">Ideias e Perguntas Recorrentes:</h4>
                        <ul class="list-disc list-inside text-sm">
                            ${result.ideas.map(idea => `<li>${idea}</li>`).join('')}
                        </ul>
                    </div>
                `;
                output.innerHTML = html;
            } catch (error) { output.innerHTML = `<p class="text-red-500">Erro ao analisar os coment√°rios: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'generate-structures': async (output, append = false) => {
            try {
                const topic = document.getElementById('structure-topic').value;
                const lang = document.getElementById('structure-lang').value;
                const prompt = `Gere 5 estruturas de t√≠tulos virais sobre o t√≥pico "${topic}" em ${lang}. Para cada estrutura, adicione uma breve explica√ß√£o de por que ela funciona.`;
                const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { structure: { type: "STRING" }, explanation: { type: "STRING" } } } };
                const result = await callGenerativeAPI(prompt, schema);
                const html = result.map(item => `
                    <div class="bg-slate-100 p-4 rounded-lg">
                        <h4 class="font-semibold text-indigo-600 mb-1">${item.structure}</h4>
                        <p class="text-sm text-slate-700">${item.explanation}</p>
                    </div>
                `).join('');
                if (append) output.insertAdjacentHTML('beforeend', html); else output.innerHTML = html;
                document.getElementById('generate-more-structures').style.display = 'block';
            } catch (error) { output.innerHTML = `<p class="text-red-500">Erro ao gerar estruturas: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'script-writer': async (output) => {
            const topic = document.getElementById('script-topic').value.trim();
            const duration = document.getElementById('script-duration').value;
            const parts = document.getElementById('script-parts').value;
            const narrationOnly = document.getElementById('script-narration-only').checked;
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um t√≥pico para o roteiro.</p>`; return; }
            showProgressModal();
            try {
                const prompt = `Escreva um roteiro de v√≠deo para o YouTube sobre "${topic}", com foco em manter a aten√ß√£o do espectador. O roteiro deve ter aproximadamente ${duration} minutos e ser dividido em ${parts} partes. Inclua sugest√µes de cenas e efeitos visuais. Se for apenas narra√ß√£o, n√£o inclua di√°logos.`;
                const result = await callGenerativeAPI(prompt);
                output.innerHTML = `<div class="bg-white p-4 rounded-lg shadow-sm border"><h3 class="font-bold text-lg mb-2">Roteiro Gerado</h3><p class="text-sm whitespace-pre-wrap">${result.text}</p></div>`;
            } catch (error) { output.innerHTML = `<p class="text-red-500">Erro ao gerar roteiro: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'shorts-script-writer': async (output) => {
            const topic = document.getElementById('shorts-topic').value.trim();
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um t√≥pico para o v√≠deo curto.</p>`; return; }
            showProgressModal();
            try {
                const prompt = `Escreva um roteiro de v√≠deo curto (Shorts, Reels) de 30 a 60 segundos sobre "${topic}", com uma introdu√ß√£o forte, pontos diretos e um gancho para o pr√≥ximo v√≠deo.`;
                const result = await callGenerativeAPI(prompt);
                output.innerHTML = `<div class="bg-white p-4 rounded-lg shadow-sm border"><h3 class="font-bold text-lg mb-2">Roteiro de Short Gerado</h3><p class="text-sm whitespace-pre-wrap">${result.text}</p></div>`;
            } catch (error) { output.innerHTML = `<p class="text-red-500">Erro ao gerar roteiro de short: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'content-recycler': async (output) => {
            const script = document.getElementById('recycler-script').value.trim();
            if (!script) { output.innerHTML = `<p class="text-red-500">Cole um roteiro para reciclar.</p>`; return; }
            showProgressModal();
            try {
                const prompt = `A partir do roteiro de v√≠deo longo a seguir, gere 3 ideias para v√≠deos curtos (shorts) que possam ser derivados dele, com t√≠tulos e um breve resumo. ROTEIRO: "${script}"`;
                const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, summary: { type: "STRING" } } } };
                const result = await callGenerativeAPI(prompt, schema);
                const html = `
                    <div class="bg-white p-4 rounded-lg shadow-sm border space-y-4">
                        <h3 class="font-bold text-lg mb-2">Ideias de Shorts</h3>
                        ${result.map(idea => `
                            <div class="bg-slate-100 p-3 rounded-lg">
                                <h4 class="font-semibold text-indigo-600">${idea.title}</h4>
                                <p class="text-sm">${idea.summary}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
                output.innerHTML = html;
            } catch (error) { output.innerHTML = `<p class="text-red-500">Erro ao reciclar conte√∫do: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'visual-storyboard': async (output) => {
            const script = document.getElementById('storyboard-script').value.trim();
            if (!script) { output.innerHTML = `<p class="text-red-500">Cole um roteiro para criar o storyboard.</p>`; return; }
            showProgressModal();
            try {
                const prompt = `Transforme o roteiro a seguir em um storyboard visual. Para cada cena, descreva a a√ß√£o visual, o √°udio e a dura√ß√£o. ROTEIRO: "${script}"`;
                const result = await callGenerativeAPI(prompt);
                output.innerHTML = `<div class="bg-white p-4 rounded-lg shadow-sm border"><h3 class="font-bold text-lg mb-2">Storyboard Gerado</h3><p class="text-sm whitespace-pre-wrap">${result.text}</p></div>`;
            } catch (error) { output.innerHTML = `<p class="text-red-500">Erro ao gerar storyboard: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'thumbnail-prompts': async (output, append = false) => {
            const title = document.getElementById('thumb-title').value.trim();
            const platform = document.getElementById('thumb-platform').value;
            if (!title) { output.innerHTML = `<p class="text-red-500">Insira um t√≠tulo para o v√≠deo.</p>`; return; }
            showProgressModal();
            try {
                const prompt = `Gere 3 prompts de intelig√™ncia artificial para thumbnail de YouTube com foco em alto CTR (Click-Through Rate), baseados no t√≠tulo "${title}", otimizados para a plataforma ${platform}.`;
                const schema = { type: "ARRAY", items: { type: "STRING" } };
                const result = await callGenerativeAPI(prompt, schema);
                const html = `
                    <div class="bg-white p-4 rounded-lg shadow-sm border space-y-4">
                        <h3 class="font-bold text-lg mb-2">Prompts de Thumbnail para ${platform}</h3>
                        ${result.map(p => `
                            <div class="bg-slate-100 p-3 rounded-lg flex items-center justify-between">
                                <p class="text-sm flex-1">${p}</p>
                                <div class="ml-4 flex-shrink-0">${createCopyButton(p)}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                if (append) output.insertAdjacentHTML('beforeend', html); else output.innerHTML = html;
                document.getElementById('generate-more-prompts').style.display = 'block';
            } catch (error) { output.innerHTML = `<p class="text-red-500">Erro ao gerar prompts: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'description-optimizer': async (output) => {
            const title = document.getElementById('desc-title').value.trim();
            const topic = document.getElementById('desc-topic').value.trim();
            if (!title || !topic) { output.innerHTML = `<p class="text-red-500">Preencha o t√≠tulo e o resumo.</p>`; return; }
            showProgressModal();
            try {
                const prompt = `Crie uma descri√ß√£o completa para um v√≠deo do YouTube com o t√≠tulo "${title}" e o resumo "${topic}". A descri√ß√£o deve ter 3 par√°grafos, incluir um CTA (Call to Action) para o p√∫blico se inscrever e seguir nas redes sociais, e um conjunto de 10 hashtags relevantes.`;
                const result = await callGenerativeAPI(prompt);
                output.innerHTML = `<div class="bg-white p-4 rounded-lg shadow-sm border"><h3 class="font-bold text-lg mb-2">Descri√ß√£o Gerada</h3><p class="text-sm whitespace-pre-wrap">${result.text}</p></div>`;
            } catch (error) { output.innerHTML = `<p class="text-red-500">Erro ao gerar descri√ß√£o: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'tag-generator': async (output) => {
            const topic = document.getElementById('tag-topic').value.trim();
            const lang = document.getElementById('tag-lang').value;
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um t√≥pico para as tags.</p>`; return; }
            showProgressModal();
            try {
                const prompt = `Gere 10 tags relevantes e de alta procura em ${lang} para um v√≠deo sobre o t√≥pico "${topic}".`;
                const schema = { type: "ARRAY", items: { type: "STRING" } };
                const result = await callGenerativeAPI(prompt, schema);
                const html = `
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <h3 class="font-bold text-lg mb-2">Tags Geradas</h3>
                        <div class="flex items-center justify-between">
                            <p class="text-sm flex-1">${result.join(', ')}</p>
                            <div class="ml-4 flex-shrink-0">${createCopyButton(result.join(', '))}</div>
                        </div>
                    </div>
                `;
                output.innerHTML = html;
            } catch (error) { output.innerHTML = `<p class="text-red-500">Erro ao gerar tags: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        },
        'monetization-helper': async (output) => {
            const niche = document.getElementById('monetization-channel-select').value;
            if (!niche) { output.innerHTML = `<p class="text-red-500">Selecione um canal para obter ideias de monetiza√ß√£o.</p>`; return; }
            showProgressModal();
            try {
                const prompt = `Gere 5 ideias de monetiza√ß√£o al√©m do AdSense para um canal no nicho de ${niche}.`;
                const schema = { type: "ARRAY", items: { type: "STRING" } };
                const result = await callGenerativeAPI(prompt, schema);
                const html = `
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <h3 class="font-bold text-lg mb-2">Ideias de Monetiza√ß√£o para o Nicho de ${niche}</h3>
                        <ul class="list-disc list-inside text-sm">
                            ${result.map(idea => `<li>${idea}</li>`).join('')}
                        </ul>
                    </div>
                `;
                output.innerHTML = html;
            } catch (error) { output.innerHTML = `<p class="text-red-500">Erro ao gerar ideias de monetiza√ß√£o: ${error.message}</p>`; }
            finally { hideProgressModal(); }
        }
    };
    
    // --- Fun√ß√µes de Inicializa√ß√£o para as abas
    function renderTabContent(tabId) {
        const tool = tools[tabId];
        if (!tool) return;
        log(`Renderizando a aba: ${tool.title}`);
        
        const updatesButton = `<button class="show-updates-btn text-indigo-400 hover:text-indigo-600" data-tool-id="${tabId}" title="Ver atualiza√ß√µes da ferramenta"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></button>`;
        
        ELEMENTS.tabContent.innerHTML = `<div class="fade-in"><div class="flex items-center gap-3 mb-2"><h2 class="text-3xl font-bold text-slate-900">${tool.title}</h2>${updatesButton}<button id="show-legend-btn" class="text-sm text-indigo-600 font-semibold hidden md:inline-block ml-auto">Entenda as Pontua√ß√µes</button></div><p class="text-slate-600 mb-6">${tool.desc}</p>${tool.content}</div>`;
        
        ELEMENTS.mobileHeaderTitle.textContent = tool.title;
        ELEMENTS.sidebar.classList.remove('open');
        ELEMENTS.menuOverlay.style.display = 'none';

        // Anexa os listeners dos bot√µes da ferramenta atual
        const outputEl = document.getElementById('output');
        const toolActionMapping = {
            'niche-finder': { btn: 'generate-niches', handler: handlers['generate-niches'], moreBtn: 'generate-more-niches' },
            'subniche-finder': { btn: 'find-subniches', handler: handlers['find-subniches'], moreBtn: 'generate-more-subniches' },
            'niche-analysis': { btn: 'analyze-niche', handler: handlers['analyze-niche'] },
            'video-optimizer': { btn: 'analyze-video', handler: handlers['analyze-video'] },
            'competitor-analysis': { btn: 'analyze-competitor', handler: handlers['analyze-competitor'] },
            'comment-analyzer': { btn: 'analyze-comments', handler: handlers['analyze-comments'] },
            'title-structures': { btn: 'generate-structures', handler: handlers['generate-structures'], moreBtn: 'generate-more-structures' },
            'script-writer': { btn: 'generate-script', handler: handlers['script-writer'] },
            'shorts-script-writer': { btn: 'generate-shorts-script', handler: handlers['shorts-script-writer'] },
            'content-recycler': { btn: 'recycle-content', handler: handlers['content-recycler'] },
            'visual-storyboard': { btn: 'generate-storyboard', handler: handlers['visual-storyboard'] },
            'thumbnail-prompts': { btn: 'generate-prompts', handler: handlers['thumbnail-prompts'], moreBtn: 'generate-more-prompts' },
            'description-optimizer': { btn: 'generate-description', handler: handlers['description-optimizer'] },
            'tag-generator': { btn: 'generate-tags', handler: handlers['tag-generator'] },
            'monetization-helper': { btn: 'generate-monetization-ideas', handler: handlers['monetization-helper'] }
        };
        const currentTool = toolActionMapping[tabId];
        if (currentTool && document.getElementById(currentTool.btn)) {
            document.getElementById(currentTool.btn).addEventListener('click', () => currentTool.handler(outputEl, false));
            if (currentTool.moreBtn && document.getElementById(currentTool.moreBtn)) {
                document.getElementById(currentTool.moreBtn).addEventListener('click', () => currentTool.handler(outputEl, true));
            }
        }
        
        // Chamadas para inicializar handlers espec√≠ficos que precisam de dados
        if (tabId === 'settings') initializeSettings();
        else if (tabId === 'dashboard') initializeDashboard();
        else if (tabId === 'channel-organizer') initializeChannelOrganizer();
        else if (tabId === 'planner') initializePlanner();
        else if (tabId === 'monetization-helper') initializeMonetizationHelper();
        
        // Listener para o modal de legendas
        const showLegendBtn = document.getElementById('show-legend-btn');
        if (showLegendBtn) { showLegendBtn.style.display = 'inline-block'; showLegendBtn.addEventListener('click', () => ELEMENTS.legendModal.style.display = 'flex'); }
    }

    async function saveAllUserSettings() {
        if (!appState.currentUser) return;
        const settingsToSave = { 
            gemini: appState.apiKeys.gemini,
            gemini_backup1: appState.apiKeys.gemini_backup1,
            gemini_backup2: appState.apiKeys.gemini_backup2,
            openai: appState.apiKeys.openai,
            google_api: appState.apiKeys.google_api,
            openrouter: appState.apiKeys.openrouter,
            userChannels: appState.userChannels, 
            videoIdeas: appState.videoIdeas 
        };
        try {
            await apiRequest(`/api/settings/${appState.currentUser.id}`, 'POST', { settings: settingsToSave });
            log('Configura√ß√µes salvas no servidor.', 'success');
            return true;
        } catch(error) {
            log(`Erro ao salvar configura√ß√µes: ${error.message}`, 'error');
            return false;
        }
    }

    // --- Specific Initializers (Dashboard, Settings, etc.) ---
    function initializeSettings() {
        const geminiKeyInput = document.getElementById('gemini-key');
        const geminiBackup1Input = document.getElementById('gemini-key-backup1');
        const geminiBackup2Input = document.getElementById('gemini-key-backup2');
        const openrouterKeyInput = document.getElementById('openrouter-key');
        const googleApiKeyInput = document.getElementById('google-api-key');
        const saveBtn = document.getElementById('save-settings');
        const feedbackEl = document.getElementById('settings-feedback');

        geminiKeyInput.value = appState.apiKeys.gemini || '';
        geminiBackup1Input.value = appState.apiKeys.gemini_backup1 || '';
        geminiBackup2Input.value = appState.apiKeys.gemini_backup2 || '';
        openrouterKeyInput.value = appState.apiKeys.openrouter || '';
        googleApiKeyInput.value = appState.apiKeys.google_api || '';

        saveBtn.addEventListener('click', async () => {
            appState.apiKeys.gemini = geminiKeyInput.value.trim();
            appState.apiKeys.gemini_backup1 = geminiBackup1Input.value.trim();
            appState.apiKeys.gemini_backup2 = geminiBackup2Input.value.trim();
            appState.apiKeys.openrouter = openrouterKeyInput.value.trim();
            appState.apiKeys.google_api = googleApiKeyInput.value.trim();
            
            feedbackEl.textContent = 'Salvando...';
            feedbackEl.className = 'text-slate-600 text-sm mt-4';
            const success = await saveAllUserSettings();
            if (success) {
                feedbackEl.textContent = 'Configura√ß√µes salvas com sucesso!';
                feedbackEl.className = 'text-green-600 text-sm mt-4';
            } else {
                feedbackEl.textContent = `Erro ao salvar as configura√ß√µes.`;
                feedbackEl.className = 'text-red-500 text-sm mt-4';
            }
            setTimeout(() => feedbackEl.textContent = '', 3000);
        });
    }

    async function initializeDashboard() {
        const container = document.getElementById('dashboard-container');
        if (!appState.userChannels || appState.userChannels.length === 0) {
            container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg border"><p>Nenhum canal adicionado. V√° para <button class="text-indigo-600 font-semibold" onclick="renderTabContent('channel-organizer')">Organizador de Canais</button> para come√ßar.</p></div>`;
            return;
        }
        
        const options = appState.userChannels.map(ch => `<option value="${ch.id}">${ch.name}</option>`).join('');
        container.innerHTML = `<div class="mb-6"><select id="channel-selector" class="p-2 border rounded-md bg-white">${options}</select></div><div id="dashboard-content"></div>`;
        
        const selector = document.getElementById('channel-selector');
        selector.addEventListener('change', (e) => renderDashboardData(e.target.value));
        renderDashboardData(selector.value);
    }
    async function renderDashboardData(channelId) {
        const contentContainer = document.getElementById('dashboard-content');
        contentContainer.innerHTML = `<div class="text-center p-8"><p>Buscando dados do canal...</p></div>`;
        try {
            const stats = await apiRequest(`/api/youtube-stats/${channelId}`, 'GET');
            if (!stats) throw new Error("N√£o foi poss√≠vel obter as estat√≠sticas do canal.");

            contentContainer.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white p-4 rounded-lg border"><p class="text-sm text-slate-500">Inscritos</p><p class="text-2xl font-bold">${Number(stats.subscriberCount).toLocaleString('pt-BR')}</p></div>
                <div class="bg-white p-4 rounded-lg border"><p class="text-sm text-slate-500">Visualiza√ß√µes</p><p class="text-2xl font-bold">${Number(stats.viewCount).toLocaleString('pt-BR')}</p></div>
                <div class="bg-white p-4 rounded-lg border"><p class="text-sm text-slate-500">V√≠deos</p><p class="text-2xl font-bold">${Number(stats.videoCount).toLocaleString('pt-BR')}</p></div>
            </div>`;
            
            if (stats.uploadsPlaylistId) {
                const recentVideos = await apiRequest(`/api/youtube-recent-videos/${stats.uploadsPlaylistId}`, 'GET');
                contentContainer.innerHTML += `<h3 class="text-xl font-bold mt-8 mb-4">√öltimos V√≠deos</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                    ${recentVideos.map(video => `<div class="bg-white p-4 rounded-lg border shadow-sm"><a href="https://www.youtube.com/watch?v=${video.id}" target="_blank"><img src="${video.thumbnail}" alt="${video.title}" class="rounded-md mb-2 w-full aspect-video object-cover"><h4 class="font-semibold text-sm leading-tight truncate">${video.title}</h4></a><div class="text-xs text-slate-500 mt-2 flex justify-between"><span>üëÅÔ∏è ${Number(video.viewCount).toLocaleString('pt-BR')}</span><span>üëç ${Number(video.likeCount).toLocaleString('pt-BR')}</span><span>üí¨ ${Number(video.commentCount).toLocaleString('pt-BR')}</span></div></div>`).join('')}
                </div>`;
            }
        } catch (error) {
            contentContainer.innerHTML = `<div class="text-center p-8 bg-red-50 rounded-lg"><p class="text-red-600">${error.message}</p><p class="text-sm text-slate-500 mt-2">Verifique se o ID do canal est√° correto no Organizador de Canais e se sua chave da API do Google est√° configurada.</p></div>`;
        }
    }
    
    function initializeChannelOrganizer() {
        const form = document.getElementById('channel-form');
        const output = document.getElementById('organizer-output');
        const renderChannels = () => {
            if (appState.userChannels.length === 0) {
                output.innerHTML = `<p class="text-center text-slate-500 py-8">Nenhum canal adicionado.</p>`;
                return;
            }
            output.innerHTML = appState.userChannels.map((ch, index) => `<div class="bg-white p-4 rounded-lg shadow-sm border"><div class="flex justify-between items-center"><h3 class="text-lg font-semibold">${ch.name}</h3><button class="remove-channel text-red-500 text-2xl" data-index="${index}" title="Remover Canal">&times;</button></div><div class="text-sm text-slate-600 mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2"><p><strong>Nicho:</strong> ${ch.niche}</p><p><strong>Idioma:</strong> ${ch.lang}</p><p><strong>V√≠deos/Semana:</strong> ${ch.freq}</p><p><strong>Hor√°rio:</strong> ${ch.time}</p><p><strong>Backlog:</strong> ${ch.backlogQty || '0'}</p><p class="col-span-1 sm:col-span-2 break-all"><strong>ID do Canal:</strong> ${ch.id}</p></div></div>`).join('');
        };
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const channelId = prompt("Por favor, insira o ID do Canal do YouTube (ex: UC_x5XG1OV2P6uZZ5FSM9Ttw)");
            if (!channelId) return;
            const newChannel = {
                id: channelId,
                name: document.getElementById('org-channel-name').value,
                niche: document.getElementById('org-channel-niche').value,
                lang: document.getElementById('org-channel-lang').value,
                freq: document.getElementById('org-videos-week').value,
                time: document.getElementById('org-post-time').value,
                backlogQty: document.getElementById('org-backlog-qty').value,
            };
            appState.userChannels.push(newChannel);
            await saveAllUserSettings();
            renderChannels();
            form.reset();
        });
        output.addEventListener('click', async (e) => {
            if (e.target.classList.contains('remove-channel')) {
                const index = parseInt(e.target.dataset.index, 10);
                appState.userChannels.splice(index, 1);
                await saveAllUserSettings();
                renderChannels();
            }
        });
        renderChannels();
    }

    function initializePlanner() {
        const form = document.getElementById('planner-form');
        const output = document.getElementById('planner-output');
        const channelSelect = document.getElementById('planner-channel-select');
        channelSelect.innerHTML = '<option value="">Selecione um Canal</option>' + appState.userChannels.map(ch => `<option value="${ch.name}">${ch.name}</option>`).join('');
        
        const renderPlanner = () => {
            if (appState.videoIdeas.length === 0) {
                output.innerHTML = `<p class="text-center text-slate-500 py-8">Nenhuma ideia adicionada.</p>`;
                return;
            }
            output.innerHTML = appState.videoIdeas.map((idea, index) => {
                const postDate = idea.datetime ? new Date(idea.datetime) : null;
                const isPast = postDate && postDate < new Date();
                const dateString = postDate ? postDate.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Sem data';

                return `<div class="bg-white p-4 rounded-lg shadow-sm border flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                    <div>
                        <h4 class="font-semibold">${idea.title}</h4>
                        <p class="text-sm text-slate-500">${idea.channel}</p>
                        <p class="text-sm font-medium ${isPast && idea.status !== 'Publicado' ? 'text-red-500' : 'text-slate-600'}">
                           ‚è∞ ${dateString}
                        </p>
                    </div>
                    <div class="flex items-center gap-2">
                        <select class="status-select bg-slate-100 border-slate-200 rounded-md text-sm p-1" data-index="${index}">
                            <option value="Planejado" ${idea.status === 'Planejado' ? 'selected' : ''}>Planejado</option>
                            <option value="Em Produ√ß√£o" ${idea.status === 'Em Produ√ß√£o' ? 'selected' : ''}>Em Produ√ß√£o</option>
                            <option value="Publicado" ${idea.status === 'Publicado' ? 'selected' : ''}>Publicado</option>
                        </select>
                        <button class="delete-idea text-red-500 hover:text-red-700 text-2xl" data-index="${index}" title="Remover Ideia">&times;</button>
                    </div>
                </div>`;
            }).join('');
        };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newIdea = {
                title: document.getElementById('idea-title').value,
                channel: channelSelect.value,
                datetime: document.getElementById('idea-datetime').value,
                status: 'Planejado'
            };
            appState.videoIdeas.push(newIdea);
            await saveAllUserSettings();
            renderPlanner();
            form.reset();
        });

        output.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-idea')) {
                appState.videoIdeas.splice(e.target.dataset.index, 1);
                await saveAllUserSettings();
                renderPlanner();
            }
        });

        output.addEventListener('change', async (e) => {
            if (e.target.classList.contains('status-select')) {
                appState.videoIdeas[e.target.dataset.index].status = e.target.value;
                await saveAllUserSettings();
            }
        });

        renderPlanner();
    }
    
    function initializeMonetizationHelper() {
        const channelSelect = document.getElementById('monetization-channel-select');
        if(appState.userChannels.length > 0) {
            channelSelect.innerHTML = '<option value="">Selecione um canal cadastrado</option>' + appState.userChannels.map(ch => `<option value="${ch.niche}">${ch.name} (${ch.niche})</option>`).join('');
            document.getElementById('generate-monetization-ideas').disabled = false;
        } else {
            channelSelect.innerHTML = '<option value="">Nenhum canal cadastrado</option>';
            channelSelect.disabled = true;
            document.getElementById('generate-monetization-ideas').disabled = true;
        }
    }

    // --- Event Listeners Globais ---
    document.addEventListener('DOMContentLoaded', () => {
        // Renderiza o SVG do logo
        const logo = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#4f46e5;stop-opacity:1" /><stop offset="100%" style="stop-color:#818cf8;stop-opacity:1" /></linearGradient></defs><circle cx="50" cy="50" r="45" fill="url(#grad)" stroke="#fff" stroke-width="5"/><path d="M35 30 L65 50 L35 70 Z" fill="#fff"/></svg>`;
        document.getElementById('logo-container-login').innerHTML = logo;
        document.getElementById('logo-container-register').innerHTML = logo;
        document.getElementById('logo-container-sidebar').innerHTML = logo;

        // Adiciona listeners para os formul√°rios de autentica√ß√£o
        ELEMENTS.loginForm.addEventListener('submit', handleLogin);
        ELEMENTS.registerForm.addEventListener('submit', handleRegister);
        ELEMENTS.showRegister.addEventListener('click', (e) => { e.preventDefault(); showRegisterScreen(); });
        ELEMENTS.showLogin.addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });
        
        // Adiciona listeners para bot√µes de navega√ß√£o
        ELEMENTS.logoutBtn.addEventListener('click', handleLogout);
        ELEMENTS.sidebarNav.addEventListener('click', (event) => {
            const clickedButton = event.target.closest('.sidebar-btn');
            if (clickedButton) {
                ELEMENTS.sidebarNav.querySelectorAll('.sidebar-btn').forEach(btn => btn.classList.remove('sidebar-btn-active'));
                clickedButton.classList.add('sidebar-btn-active');
                renderTabContent(clickedButton.getAttribute('data-tab'));
            }
        });
        
        // Adiciona listeners para modais e logs
        ELEMENTS.closeLegendModal.addEventListener('click', () => ELEMENTS.legendModal.style.display = 'none');
        ELEMENTS.closeUpdatesModal.addEventListener('click', () => ELEMENTS.updatesModal.style.display = 'none');
        ELEMENTS.openTicketBtn.addEventListener('click', () => {
            ELEMENTS.ticketForm.reset();
            ELEMENTS.screenshotPreview.style.display = 'none';
            ELEMENTS.screenshotPreview.src = '';
            ELEMENTS.ticketModal.style.display = 'flex';
        });
        ELEMENTS.closeTicketModal.addEventListener('click', () => ELEMENTS.ticketModal.style.display = 'none');
        ELEMENTS.screenshotInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    ELEMENTS.screenshotPreview.src = event.target.result;
                    ELEMENTS.screenshotPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                ELEMENTS.screenshotPreview.style.display = 'none';
            }
        });
        ELEMENTS.ticketForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const description = document.getElementById('ticket-description').value;
            const subject = "Report de Erro - Darks Vips AI";
            let body = `Descri√ß√£o do Problema:\n${description}\n\n--- Fim da Descri√ß√£o ---`;
            const mailtoLink = `mailto:suporte@canaisdarks.com.br?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            ELEMENTS.ticketModal.style.display = 'none';
        });
        ELEMENTS.logHeader.addEventListener('click', () => {
            ELEMENTS.logPanel.classList.toggle('open');
            ELEMENTS.logToggleIcon.textContent = ELEMENTS.logPanel.classList.contains('open') ? '‚ñº' : '‚ñ≤';
        });
        
        // Listener para bot√µes de copiar e de updates
        ELEMENTS.tabContent.addEventListener('click', (e) => {
            const copyBtn = e.target.closest('.copy-btn');
            if (copyBtn) {
                const text = decodeURIComponent(copyBtn.dataset.copyText);
                navigator.clipboard.writeText(text).then(() => {
                    copyBtn.textContent = 'Copiado!';
                    copyBtn.classList.add('copied');
                    setTimeout(() => {
                        copyBtn.textContent = 'Copiar';
                        copyBtn.classList.remove('copied');
                    }, 2000);
                });
            }
            const updatesBtn = e.target.closest('.show-updates-btn');
            if(updatesBtn) {
                const toolId = updatesBtn.dataset.tool-id;
                const tool = tools[toolId];
                ELEMENTS.updatesModalTitle.textContent = `Atualiza√ß√µes de ${tool.title}`;
                ELEMENTS.updatesModalContent.innerHTML = TOOL_UPDATES[toolId] || TOOL_UPDATES['default'];
                ELEMENTS.updatesModal.style.display = 'flex';
            }
        });

        // Listeners para o menu mobile
        ELEMENTS.openMenuBtn.addEventListener('click', () => { ELEMENTS.sidebar.classList.add('open'); ELEMENTS.menuOverlay.style.display = 'block'; });
        ELEMENTS.closeMenuBtn.addEventListener('click', () => { ELEMENTS.sidebar.classList.remove('open'); ELEMENTS.menuOverlay.style.display = 'none'; });
        ELEMENTS.menuOverlay.addEventListener('click', () => { ELEMENTS.sidebar.classList.remove('open'); ELEMENTS.menuOverlay.style.display = 'none'; });
        
        // Preven√ß√£o do F12 e DevTools
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase()))) e.preventDefault();
        });
    });
    </script>
</body>
</html>
