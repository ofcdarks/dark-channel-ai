<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Dark Channel Automator v12.9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .sidebar-btn { transition: all 0.2s ease-in-out; }
        .sidebar-btn:hover { background-color: #f1f5f9; color: #334155; }
        .sidebar-btn-active { background-color: #eef2ff; color: #4f46e5; font-weight: 600; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar-container { background-color: #e0e7ff; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-bar-inner { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
        .progress-bar-indeterminate { background-size: 200% 100%; background-image: linear-gradient(to right, #e0e7ff 0%, #c7d2fe 50%, #e0e7ff 100%); animation: move-bg 2s linear infinite; }
        @keyframes move-bg { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        /* Correção: Apenas o login container é flex por padrão */
        #login-container { display: flex; }
        #register-container, #app-container, #progress-modal { display: none; }
        .prose { max-width: none; }
        .copy-btn.copied { background-color: #10b981; color: white; }
        .form-switch { cursor: pointer; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Tela de Login -->
    <div id="login-container" class="flex items-center justify-center h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <div>
                <h2 class="text-3xl font-extrabold text-center text-slate-900">Dark Channel AI</h2>
                <p class="mt-2 text-center text-sm text-slate-600">Faça login para continuar</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div id="login-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <input id="login-email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Endereço de e-mail">
                    <input id="login-password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Senha">
                </div>
                <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Entrar</button>
            </form>
            <p class="text-center text-sm">Não tem uma conta? <a href="#" id="show-register" class="font-medium text-indigo-600 hover:text-indigo-500">Registre-se</a></p>
        </div>
    </div>

    <!-- Tela de Registro -->
    <div id="register-container" class="hidden items-center justify-center h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <div>
                <h2 class="text-3xl font-extrabold text-center text-slate-900">Criar Conta</h2>
                <p class="mt-2 text-center text-sm text-slate-600">Junte-se à plataforma</p>
            </div>
            <form id="register-form" class="mt-8 space-y-6">
                <div id="register-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <input id="register-email" type="email" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Seu melhor e-mail">
                    <input id="register-password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Crie uma senha forte">
                </div>
                <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Criar Conta</button>
            </form>
            <p class="text-center text-sm">Já tem uma conta? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">Faça login</a></p>
        </div>
    </div>

    <!-- Modal de Progresso -->
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h3 class="text-lg font-semibold text-slate-800 mb-2">Processando...</h3>
            <p id="progress-phrase" class="text-sm text-slate-600 mb-4">Otimizando para o algoritmo...</p>
            <div class="w-full bg-slate-200 rounded-full h-2.5"><div class="h-2.5 rounded-full progress-bar-indeterminate"></div></div>
        </div>
    </div>

    <!-- Conteúdo da Aplicação -->
    <div id="app-container" class="hidden h-screen bg-slate-50">
        <aside class="w-72 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col">
            <div class="p-6 border-b">
                <h1 class="text-2xl font-bold text-slate-900">Dark Channel AI</h1>
                <div class="text-sm text-slate-500" id="user-email-display"></div>
            </div>
            <nav id="sidebar-nav" class="p-4 space-y-1 flex-1 overflow-y-auto"></nav>
            <div class="p-4 border-t">
                <button id="logout-btn" class="w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-red-50 hover:text-red-700">
                    <span>🚪</span><span>Sair</span>
                </button>
            </div>
        </aside>
        <main id="tab-content" class="flex-1 p-6 md:p-10 overflow-y-auto"></main>
    </div>

    <script>
    // --- Global State Management ---
    let appState = {
        currentUser: null, // { id, email }
        apiKeys: { gemini: "", openai: "", youtube: "", google_search: "" },
        userChannels: [],
        videoIdeas: []
    };

    // --- Constants ---
    const ELEMENTS = {
        loginContainer: document.getElementById('login-container'),
        registerContainer: document.getElementById('register-container'),
        appContainer: document.getElementById('app-container'),
        loginForm: document.getElementById('login-form'),
        registerForm: document.getElementById('register-form'),
        loginFeedback: document.getElementById('login-feedback'),
        registerFeedback: document.getElementById('register-feedback'),
        showRegister: document.getElementById('show-register'),
        showLogin: document.getElementById('show-login'),
        sidebarNav: document.getElementById('sidebar-nav'),
        tabContent: document.getElementById('tab-content'),
        progressModal: document.getElementById('progress-modal'),
        progressPhrase: document.getElementById('progress-phrase'),
        userEmailDisplay: document.getElementById('user-email-display'),
        logoutBtn: document.getElementById('logout-btn'),
    };

    const PROGRESS_PHRASES = [ "Decodificando o algoritmo...", "Buscando insights virais...", "Consultando os dados de tendência...", "Polindo as palavras-chave...", "Ajustando o potencial de clique..." ];

    // --- API Communication ---
    async function apiRequest(endpoint, method, body = null) {
        const options = {
            method,
            headers: { 'Content-Type': 'application/json' },
        };
        if (body) {
            options.body = JSON.stringify(body);
        }
        const response = await fetch(endpoint, options);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Ocorreu um erro.');
        }
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            return response.json();
        }
        return null;
    }

    // --- Authentication ---
    function showLoginScreen() {
        ELEMENTS.registerContainer.style.display = 'none';
        ELEMENTS.loginContainer.style.display = 'flex';
    }

    function showRegisterScreen() {
        ELEMENTS.loginContainer.style.display = 'none';
        ELEMENTS.registerContainer.style.display = 'flex';
    }

    async function handleLogin(e) {
        e.preventDefault();
        ELEMENTS.loginFeedback.textContent = '';
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            const user = await apiRequest('/api/login', 'POST', { email, password });
            appState.currentUser = user;
            await initializeApp();
        } catch (error) {
            ELEMENTS.loginFeedback.textContent = error.message;
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        ELEMENTS.registerFeedback.textContent = '';
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        try {
            await apiRequest('/api/register', 'POST', { email, password });
            const user = await apiRequest('/api/login', 'POST', { email, password });
            appState.currentUser = user;
            await initializeApp();
        } catch (error) {
            ELEMENTS.registerFeedback.textContent = error.message;
        }
    }
    
    function handleLogout() {
        appState.currentUser = null;
        appState.apiKeys = { gemini: "", openai: "", youtube: "", google_search: "" };
        ELEMENTS.appContainer.style.display = 'none';
        showLoginScreen();
        document.getElementById('login-form').reset();
    }

    // --- App Initialization ---
    async function initializeApp() {
        if (!appState.currentUser) return;
        
        try {
            const settings = await apiRequest(`/api/settings/${appState.currentUser.id}`, 'GET');
            if (settings && Object.keys(settings).length > 0) {
                appState.apiKeys = settings;
            }
        } catch(error) {
            console.error("Não foi possível carregar as configurações:", error.message);
        }

        ELEMENTS.userEmailDisplay.textContent = appState.currentUser.email;
        ELEMENTS.loginContainer.style.display = 'none';
        ELEMENTS.registerContainer.style.display = 'none';
        ELEMENTS.appContainer.style.display = 'flex';
        
        buildSidebar();
        renderTabContent('dashboard');
    }

    // --- UI Building ---
    function buildSidebar() {
        const navItems = [
            { id: 'dashboard', icon: '📈', label: 'Dashboard' },
            { type: 'divider', label: 'PESQUISA' },
            { id: 'niche-finder', icon: '🔎', label: 'Nichos e Tendências' },
            { id: 'subniche-finder', icon: '💎', label: 'Explorador de Subnichos' },
            { id: 'niche-analysis', icon: '📊', label: 'Análise de Nicho' },
            { id: 'video-optimizer', icon: '🚀', label: 'Analisador de Vídeo' },
            { type: 'divider', label: 'CRIAÇÃO' },
            { id: 'title-structures', icon: '🏗️', label: 'Estruturas de Títulos' },
            { id: 'script-writer', icon: '📜', label: 'Criador de Roteiros' },
            { id: 'visual-storyboard', icon: '🎬', label: 'Storyboard Visual' },
            { id: 'thumbnail-prompts', icon: '🎨', label: 'Prompts de Thumbnail' },
            { type: 'divider', label: 'OTIMIZAÇÃO' },
            { id: 'description-optimizer', icon: '📄', label: 'Otimizador de Descrição' },
            { id: 'tag-generator', icon: '🏷️', label: 'Gerador de Tags' },
            { type: 'divider', label: 'GERENCIAMENTO' },
            { id: 'channel-organizer', icon: '📺', label: 'Organizador de Canais' },
            { id: 'planner', icon: '🗓️', label: 'Planejador de Conteúdo' },
            { id: 'settings', icon: '⚙️', label: 'Configurações' },
        ];

        ELEMENTS.sidebarNav.innerHTML = navItems.map(item => {
            if (item.type === 'divider') {
                return `<div class="pt-2 mt-2 border-t"><span class="px-4 text-xs font-semibold text-slate-400">${item.label}</span></div>`;
            }
            return `<button class="sidebar-btn ${item.id === 'dashboard' ? 'sidebar-btn-active' : ''} w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg" data-tab="${item.id}"><span>${item.icon}</span><span>${item.label}</span></button>`;
        }).join('');
    }
    
    // --- Utility Functions ---
    const showProgressModal = () => { ELEMENTS.progressModal.style.display = 'flex'; ELEMENTS.progressPhrase.textContent = PROGRESS_PHRASES[Math.floor(Math.random() * PROGRESS_PHRASES.length)]; };
    const hideProgressModal = () => { ELEMENTS.progressModal.style.display = 'none'; };
    const getScoreColor = (score) => score >= 80 ? 'bg-green-500' : score >= 50 ? 'bg-yellow-500' : 'bg-red-500';
    const createCopyButton = (text) => `<button class="copy-btn text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded hover:bg-slate-300" data-copy-text="${encodeURIComponent(text)}">Copiar</button>`;
    const renderScoreCard = (title, mainScore, subScores, suggestion) => {
        const intMainScore = Math.round(mainScore);
        const subScoresHtml = Object.entries(subScores).map(([key, value]) => `
            <div class="mb-2">
                <div class="flex justify-between items-center text-sm mb-1"><span class="text-slate-600">${key}</span><span class="font-semibold text-slate-700">${Math.round(value)}/100</span></div>
                <div class="progress-bar-container"><div class="progress-bar-inner ${getScoreColor(value)}" style="width: ${value}%;"></div></div>
            </div>`).join('');
        return `<div class="bg-white p-4 rounded-lg border w-full md:w-72 flex-shrink-0">
                    <h4 class="font-semibold text-slate-800 mb-2">${title}</h4>
                    <div class="flex items-center gap-2 mb-4"><span class="text-3xl font-bold ${getScoreColor(intMainScore).replace('bg', 'text')}-500">${intMainScore}</span><span class="text-slate-500">/ 100</span></div>
                    ${subScoresHtml}
                    <p class="text-xs text-slate-500 mt-4"><strong class="text-slate-600">Sugestão:</strong> ${suggestion}</p>
                </div>`;
    };

    // --- Gemini API Call ---
    async function callGenerativeAPI(prompt, schema = null, retries = 3, delay = 1000) {
        const geminiKey = appState.apiKeys.gemini || "";
        if (!geminiKey) {
            throw new Error("Chave da API Gemini não encontrada. Por favor, adicione-a nas Configurações.");
        }
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiKey}`;
        let payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        if (schema) payload.generationConfig = { responseMimeType: "application/json", responseSchema: schema };

        showProgressModal();
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });
            clearTimeout(timeoutId);

            if (!response.ok) {
                const errorBody = await response.json();
                if (retries > 0 && response.status === 429) {
                    await new Promise(res => setTimeout(res, delay));
                    return callGenerativeAPI(prompt, schema, retries - 1, delay * 2);
                }
                throw new Error(`Erro na API: ${response.status} - ${errorBody.error?.message || 'Verifique sua chave de API.'}`);
            }
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                const text = result.candidates[0].content.parts[0].text;
                return schema ? JSON.parse(text) : { text };
            }
            if (result.candidates?.[0]?.finishReason === 'SAFETY') throw new Error("A resposta foi bloqueada por políticas de segurança.");
            throw new Error("Resposta da API inválida ou vazia.");
        } catch (error) {
            if (error.name === 'AbortError') throw new Error("A requisição da API excedeu o tempo limite.");
            throw error;
        } finally {
            hideProgressModal();
        }
    }
    
    // --- Tools and Handlers ---
    const tools = {
        "dashboard": { title: "Dashboard de Performance", desc: "Métricas e insights do seu canal. (Dados simulados)", content: `<div id="dashboard-container"><p class="text-center text-slate-500">Carregando dashboard...</p></div>` },
        "niche-finder": { title: "Localizador de Nichos", desc: "Encontre nichos e tendências de mercado.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="niche-keyword" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="Palavra-chave (opcional)"><button id="generate-niches" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🔎 Encontrar Nichos</button><div id="output" class="mt-6"></div></div>` },
        "subniche-finder": { title: "Explorador de Subnichos", desc: "Descubra subnichos inexplorados a partir de um nicho principal.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="main-niche" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="Nicho principal. Ex: História"><button id="find-subniches" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">💎 Explorar Subnichos</button><div id="output" class="mt-6"></div></div>` },
        "niche-analysis": { title: "Análise de Nicho (RPM/Hype)", desc: "Analise o potencial de um nicho específico.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="analysis-niche" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="Nicho a ser analisado"><button id="analyze-niche" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">📊 Analisar Nicho</button><div id="output" class="mt-6"></div></div>` },
        "video-optimizer": { title: "Analisador de Vídeo (URL)", desc: "Otimize títulos e descrições a partir de uma URL do YouTube.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="url" id="video-url" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="https://www.youtube.com/watch?v=..."><button id="analyze-video" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🚀 Otimizar Vídeo</button><div id="output" class="mt-6"></div></div>` },
        "title-structures": { title: "Estruturas de Títulos Virais", desc: "Gere estruturas de títulos com alto potencial de clique.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="structure-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="Tópico. Ex: Produtividade"><button id="generate-structures" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🏗️ Gerar Estruturas</button><div id="output" class="mt-6 space-y-4"></div></div>` },
        "script-writer": { title: "Criador de Roteiros", desc: "Gere roteiros com foco em alta retenção.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="script-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="Tópico do Vídeo"><button id="generate-script" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">📜 Gerar Roteiro</button><div id="output" class="mt-6"></div></div>` },
        "visual-storyboard": { title: "Storyboard Visual", desc: "Transforme seu roteiro em um guia de cenas e visuais.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><textarea id="storyboard-script" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" rows="8" placeholder="Cole seu roteiro aqui..."></textarea><button id="generate-storyboard" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🎬 Criar Storyboard</button><div id="output" class="mt-6"></div></div>` },
        "thumbnail-prompts": { title: "Prompts de Thumbnail", desc: "Gere prompts otimizados para IAs de imagem.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="thumb-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="Título do Vídeo"><button id="generate-prompts" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🎨 Gerar Prompts</button><div id="output" class="mt-6 space-y-4"></div></div>` },
        "description-optimizer": { title: "Otimizador de Descrição", desc: "Crie descrições com SEO e CTAs eficazes.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="desc-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="Título do Vídeo"><textarea id="desc-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" rows="4" placeholder="Resumo do vídeo e palavras-chave..."></textarea><button id="generate-description" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">📄 Gerar Descrição</button><div id="output" class="mt-6"></div></div>` },
        "tag-generator": { title: "Gerador de Tags", desc: "Gere tags relevantes para maximizar o alcance.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="tag-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="Tópico do Vídeo"><button id="generate-tags" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">🏷️ Gerar Tags</button><div id="output" class="mt-6"></div></div>` },
        "channel-organizer": { title: "Organizador de Canais", desc: "Gerencie as informações dos seus canais. (Em breve)", content: `<div class="text-center p-8 bg-white rounded-lg border"><p>Funcionalidade em desenvolvimento.</p></div>` },
        "planner": { title: "Planejador de Conteúdo", desc: "Organize suas ideias de vídeo. (Em breve)", content: `<div class="text-center p-8 bg-white rounded-lg border"><p>Funcionalidade em desenvolvimento.</p></div>` },
        "settings": { title: "Configurações", desc: "Gerencie suas chaves de API.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border space-y-6"><div><h3 class="text-lg font-semibold">Chaves de API</h3><div class="space-y-4 mt-2"><div><label class="block text-sm font-medium text-slate-700">Gemini API Key</label><input type="password" id="gemini-key" class="mt-1 block w-full px-3 py-2 border rounded-md"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-indigo-600 hover:underline">Obter chave do Gemini</a></div><div><label class="block text-sm font-medium text-slate-700">OpenAI API Key (Opcional)</label><input type="password" id="openai-key" class="mt-1 block w-full px-3 py-2 border rounded-md"></div></div></div><button id="save-settings" class="w-full bg-indigo-800 text-white font-bold py-3 px-4 rounded-lg mt-6">Salvar Configurações</button><div id="settings-feedback" class="mt-4 min-h-[20px]"></div></div>` },
    };
    
    const handlers = {
        'generate-niches': async (output) => {
            const keyword = document.getElementById('niche-keyword').value || 'tópicos em alta';
            const prompt = `Atue como um especialista em YouTube. Analise o YouTube para '${keyword}'. Gere 3 nichos. Para cada um: { "niche_name": "string", "description": "string", "unexplored_subniches": ["string"], "rpm_estimate": "string", "scores": { "Potencial": "um número INTEIRO CRITERIOSO entre 50 e 99", "Concorrência": "um número INTEIRO entre 10 e 40", "Volume de Busca": "um número INTEIRO entre 30 e 95" }, "suggestion": "uma sugestão em português" }`;
            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { niche_name: { type: "STRING" }, description: { type: "STRING" }, unexplored_subniches: { type: "ARRAY", items: { type: "STRING" } }, rpm_estimate: { type: "STRING" }, scores: { type: "OBJECT", properties: { "Potencial": { type: "NUMBER" }, "Concorrência": { type: "NUMBER" }, "Volume de Busca": { type: "NUMBER" } } }, suggestion: { type: "STRING" } } } };
            const result = await callGenerativeAPI(prompt, schema);
            output.innerHTML = result.map(item => `<div class="bg-slate-100 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4"><div class="flex-1"><h3 class="font-semibold text-lg mb-2">${item.niche_name} ${createCopyButton(item.niche_name)}</h3><p class="text-sm text-slate-700">${item.description}</p><p class="mt-2 font-semibold text-sm">RPM Estimado: ${item.rpm_estimate}</p><p class="mt-2 font-semibold text-sm">Subnichos Inexplorados: ${item.unexplored_subniches.join(', ')}</p></div>${renderScoreCard('Análise de Nicho', item.scores.Potencial, { 'Potencial': item.scores.Potencial, 'Concorrência (menor é melhor)': 100 - item.scores.Concorrência, 'Volume de Busca': item.scores['Volume de Busca'] }, item.suggestion)}</div>`).join('');
        },
        'find-subniches': async (output) => {
            const mainNiche = document.getElementById('main-niche').value.trim();
            if (!mainNiche) { output.innerHTML = `<p class="text-red-500">Insira um nicho principal.</p>`; return; }
            const prompt = `Atue como um especialista em YouTube. Para o nicho principal de "${mainNiche}", gere 5 subnichos inexplorados. Para cada um: { "subniche_name": "string", "description": "string", "video_ideas": ["string"], "scores": { "Potencial": "um número INTEIRO CRITERIOSO entre 50 e 99", "Concorrência": "um número INTEIRO entre 10 e 40", "Volume de Busca": "um número INTEIRO entre 30 e 95" }, "suggestion": "uma sugestão em português" }`;
            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { subniche_name: { type: "STRING" }, description: { type: "STRING" }, video_ideas: { type: "ARRAY", items: { type: "STRING" } }, scores: { type: "OBJECT", properties: { "Potencial": { type: "NUMBER" }, "Concorrência": { type: "NUMBER" }, "Volume de Busca": { type: "NUMBER" } } }, suggestion: { type: "STRING" } } } };
            const result = await callGenerativeAPI(prompt, schema);
            output.innerHTML = result.map(item => `<div class="bg-slate-100 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4"><div class="flex-1"><h3 class="font-semibold text-lg mb-2">${item.subniche_name} ${createCopyButton(item.subniche_name)}</h3><p class="text-sm text-slate-700">${item.description}</p><p class="mt-2 font-semibold text-sm">Ideias de Vídeo: ${item.video_ideas.join('; ')}</p></div>${renderScoreCard('Análise do Subnicho', item.scores.Potencial, { 'Potencial': item.scores.Potencial, 'Concorrência': 100 - item.scores.Concorrência, 'Volume de Busca': item.scores['Volume de Busca'] }, item.suggestion)}</div>`).join('');
        },
        'analyze-niche': async (output) => {
            const niche = document.getElementById('analysis-niche').value.trim();
            if (!niche) { output.innerHTML = `<p class="text-red-500">Insira um nicho para análise.</p>`; return; }
            const prompt = `Atue como um especialista em YouTube. Analise o nicho "${niche}". Forneça: { "niche_name": "string", "rpm_estimate": "string", "hype_score": "um número INTEIRO CRITERIOSO entre 50 e 99", "reference_channels": ["string"], "suggestion": "uma sugestão em português" }`;
            const schema = { type: "OBJECT", properties: { niche_name: { type: "STRING" }, rpm_estimate: { type: "STRING" }, hype_score: { type: "NUMBER" }, reference_channels: { type: "ARRAY", items: { type: "STRING" } }, suggestion: { type: "STRING" } } };
            const result = await callGenerativeAPI(prompt, schema);
            const rpmValue = parseInt(result.rpm_estimate.replace(/[^0-9]/g, ''), 10) || 5;
            output.innerHTML = `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><h3 class="font-semibold text-lg">${result.niche_name}</h3><p class="text-sm mt-1">Canais de Referência: ${result.reference_channels.join(', ')}</p></div>${renderScoreCard('Análise de Nicho', result.hype_score, { 'Hype Score': result.hype_score, 'RPM Estimado': Math.min(100, rpmValue * 10), 'Busca': Math.floor(Math.random() * 40) + 50 }, result.suggestion)}</div>`;
        },
        'analyze-video': async (output) => {
            const url = document.getElementById('video-url').value.trim();
            if (!url) { output.innerHTML = `<p class="text-red-500">Insira uma URL.</p>`; return; }
            const videoIdMatch = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/);
            if (!videoIdMatch) { output.innerHTML = `<p class="text-red-500">URL inválida.</p>`; return; }
            const videoId = videoIdMatch[1];
            const prompt = `Atue como um especialista em YouTube. Simule uma análise do vídeo na URL '${url}'. Crie um estado atual plausível e gere otimizações. Formato: { "current_title": "string", "optimized_titles": [{ "title": "string", "score": "number", "suggestion": "string" }], "optimized_description": { "description": "string", "score": "number", "suggestion": "string" } }`;
            const schema = { type: "OBJECT", properties: { current_title: { type: "STRING" }, optimized_titles: { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } } }, optimized_description: { type: "OBJECT", properties: { description: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } } } };
            const result = await callGenerativeAPI(prompt, schema);
            output.innerHTML = `<div class="mb-6"><h3 class="text-xl font-bold mb-2">Análise Atual (Simulada)</h3><div class="flex gap-4 bg-slate-100 p-4 rounded-lg"><img src="https://i.ytimg.com/vi/${videoId}/hqdefault.jpg" onerror="this.src='https://placehold.co/120x90/e2e8f0/334155?text=Thumb'" class="rounded-md w-32 h-auto object-cover"/><div class="flex-1"><h4 class="font-semibold">${result.current_title}</h4><p class="text-sm text-slate-500">Esta análise é simulada.</p></div></div></div><div><h3 class="text-xl font-bold mb-2">Sugestões de Otimização</h3>${result.optimized_titles.map(t => `<div class="bg-slate-100 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><h4 class="font-semibold">${t.title} ${createCopyButton(t.title)}</h4></div>${renderScoreCard('Potencial Viral', t.score, { 'CTR': t.score + 2, 'SEO': t.score - 3, 'Busca': t.score + 5 }, t.suggestion)}</div>`).join('')}<div class="bg-slate-100 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><h4 class="font-semibold">Descrição Otimizada ${createCopyButton(result.optimized_description.description)}</h4><div class="prose whitespace-pre-wrap text-sm mt-2">${result.optimized_description.description}</div></div>${renderScoreCard('Otimização SEO', result.optimized_description.score, { 'Palavras-chave': result.optimized_description.score + 5, 'Clareza': result.optimized_description.score - 2, 'Busca': result.optimized_description.score + 10 }, result.optimized_description.suggestion)}</div></div>`;
        },
        'generate-structures': async (output) => {
            const topic = document.getElementById('structure-topic').value.trim();
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um tópico.</p>`; return; }
            const prompt = `Crie 3 estruturas de títulos virais para "${topic}". Formato: { "structure_name": "string", "structure": "string", "example_title": "string", "explanation": "string", "viral_score": "number", "suggestion": "string", "is_novel": "boolean" }`;
            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { structure_name: { type: "STRING" }, structure: { type: "STRING" }, example_title: { type: "STRING" }, explanation: { type: "STRING" }, viral_score: { type: "NUMBER" }, suggestion: { type: "STRING" }, is_novel: { type: "BOOLEAN" } } } };
            const result = await callGenerativeAPI(prompt, schema);
            output.innerHTML = result.map(item => `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><h4 class="font-semibold">${item.example_title} ${createCopyButton(item.example_title)}</h4><p class="text-sm text-slate-600"><strong>Estrutura:</strong> ${item.structure_name} - <code>${item.structure}</code></p><p class="text-sm text-slate-600 mt-1">${item.explanation}</p>${item.is_novel ? '<span class="inline-flex items-center rounded-md bg-purple-50 px-2 py-1 text-xs font-medium text-purple-700 ring-1 ring-inset ring-purple-700/10 mt-2">✨ Inédita!</span>' : ''}</div>${renderScoreCard('Potencial Viral', item.viral_score, { 'Curiosidade': item.viral_score + 5, 'Clareza': item.viral_score - 2, 'Busca': item.viral_score + 10 }, item.suggestion)}</div>`).join('');
        },
        'generate-script': async (output) => {
            const topic = document.getElementById('script-topic').value.trim();
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um tópico.</p>`; return; }
            const prompt = `Crie um roteiro de alta qualidade sobre "${topic}", focado em retenção.`;
            const result = await callGenerativeAPI(prompt);
            output.innerHTML = `<div class="bg-slate-100 p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Roteiro Gerado</h4>${createCopyButton(result.text)}</div><div class="prose h-96 overflow-y-auto whitespace-pre-wrap p-2 bg-white rounded border">${result.text}</div></div>`;
        },
        'generate-storyboard': async (output) => {
            const script = document.getElementById('storyboard-script').value.trim();
            if (!script) { output.innerHTML = `<p class="text-red-500">Cole um roteiro.</p>`; return; }
            const prompt = `Divida o roteiro a seguir em cenas e para cada uma, crie um prompt detalhado para uma IA de vídeo. ROTEIRO: "${script}". Formato: { "scenes": [{ "scene_number": "number", "script_excerpt": "string", "vo3_prompt_sfx": "string", "suggestion": "string" }] }`;
            const schema = { type: "OBJECT", properties: { scenes: { type: "ARRAY", items: { type: "OBJECT", properties: { scene_number: { type: "NUMBER" }, script_excerpt: { type: "STRING" }, vo3_prompt_sfx: { type: "STRING" }, suggestion: { type: "STRING" } } } } } };
            const result = await callGenerativeAPI(prompt, schema);
            output.innerHTML = result.scenes.map(scene => `<div class="p-4 rounded-lg mb-2 ${scene.scene_number % 2 === 0 ? 'bg-slate-100' : 'bg-white border'}"><p class="font-semibold text-slate-800">Cena ${scene.scene_number}: <span class="font-normal text-slate-600 italic">"${scene.script_excerpt}"</span></p><div class="mt-2 bg-slate-800 text-white p-3 rounded-md font-mono text-xs relative group">${scene.vo3_prompt_sfx} <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">${createCopyButton(scene.vo3_prompt_sfx)}</div></div><p class="text-xs mt-2 text-slate-500"><strong>Sugestão:</strong> ${scene.suggestion}</p></div>`).join('');
        },
        'generate-prompts': async (output) => {
            const title = document.getElementById('thumb-title').value.trim();
            if (!title) { output.innerHTML = `<p class="text-red-500">Insira um título.</p>`; return; }
            const prompt = `Gere 2 prompts avançados em INGLÊS para Midjourney para uma thumbnail sobre "${title}". Formato: { "prompt": "string", "score": "number", "suggestion": "string", "ab_test_suggestion": "string" }`;
            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { prompt: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" }, ab_test_suggestion: { type: "STRING" } } } };
            const result = await callGenerativeAPI(prompt, schema);
            output.innerHTML = result.map(item => `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><div class="font-mono text-sm bg-slate-200 p-2 rounded relative group">${item.prompt}<div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">${createCopyButton(item.prompt)}</div></div><p class="text-xs mt-2 text-slate-600"><strong>Teste A/B:</strong> ${item.ab_test_suggestion}</p></div>${renderScoreCard('Potencial de CTR', item.score, { 'Impacto Visual': item.score + 4, 'Clareza': item.score - 3, 'Busca': item.score + 8 }, item.suggestion)}</div>`).join('');
        },
        'generate-description': async (output) => {
            const title = document.getElementById('desc-title').value.trim();
            const topic = document.getElementById('desc-topic').value.trim();
            if (!title || !topic) { output.innerHTML = `<p class="text-red-500">Insira título e tópico.</p>`; return; }
            const prompt = `Crie uma descrição de vídeo otimizada para "${title}" sobre "${topic}". Formato: { "description": "string", "score": "number", "suggestion": "string" }`;
            const schema = { type: "OBJECT", properties: { description: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } };
            const result = await callGenerativeAPI(prompt, schema);
            output.innerHTML = `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Descrição Otimizada</h4>${createCopyButton(result.description)}</div><div class="prose whitespace-pre-wrap text-sm">${result.description}</div></div>${renderScoreCard('Otimização', result.score, { 'SEO': result.score + 3, 'Engajamento': result.score - 4, 'Busca': result.score + 5 }, result.suggestion)}</div>`;
        },
        'generate-tags': async (output) => {
            const topic = document.getElementById('tag-topic').value.trim();
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um tópico.</p>`; return; }
            const prompt = `Gere 25 tags otimizadas sobre "${topic}". Formato: { "tags": "string", "score": "number", "suggestion": "string" }`;
            const schema = { type: "OBJECT", properties: { tags: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } };
            const result = await callGenerativeAPI(prompt, schema);
            output.innerHTML = `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Tags Geradas</h4>${createCopyButton(result.tags)}</div><p class="text-sm text-slate-700 p-2 bg-white rounded border">${result.tags}</p></div>${renderScoreCard('Qualidade', result.score, { 'Relevância': result.score + 5, 'Volume': result.score - 3, 'Concorrência': result.score + 10 }, result.suggestion)}</div>`;
        }
    };
    
    function renderTabContent(tabId) {
        const tool = tools[tabId];
        if (!tool) return;
        ELEMENTS.tabContent.innerHTML = `<div class="fade-in"><h2 class="text-3xl font-bold text-slate-900 mb-2">${tool.title}</h2><p class="text-slate-600 mb-6">${tool.desc}</p>${tool.content}</div>`;
        
        if (tabId === 'settings') initializeSettings();
        if (tabId === 'dashboard') initializeDashboard();

        const outputEl = document.getElementById('output');
        if (!outputEl) return;

        Object.keys(handlers).forEach(buttonId => {
            const btn = document.getElementById(buttonId);
            if(btn) {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.addEventListener('click', async () => {
                    try { await handlers[buttonId](outputEl); }
                    catch (error) { hideProgressModal(); outputEl.innerHTML = `<p class="text-red-500">${error.message}</p>`; }
                });
            }
        });
    }

    async function initializeSettings() {
        const geminiKeyInput = document.getElementById('gemini-key');
        const openaiKeyInput = document.getElementById('openai-key');
        const saveBtn = document.getElementById('save-settings');
        const feedbackEl = document.getElementById('settings-feedback');

        geminiKeyInput.value = appState.apiKeys.gemini || '';
        openaiKeyInput.value = appState.apiKeys.openai || '';

        saveBtn.addEventListener('click', async () => {
            const newSettings = {
                gemini: geminiKeyInput.value.trim(),
                openai: openaiKeyInput.value.trim(),
            };
            feedbackEl.textContent = '';
            try {
                await apiRequest(`/api/settings/${appState.currentUser.id}`, 'POST', { settings: newSettings });
                appState.apiKeys = newSettings;
                feedbackEl.textContent = 'Configurações salvas com sucesso!';
                feedbackEl.className = 'text-green-600 text-sm mt-4';
            } catch (error) {
                feedbackEl.textContent = `Erro ao salvar: ${error.message}`;
                feedbackEl.className = 'text-red-500 text-sm mt-4';
            } finally {
                setTimeout(() => feedbackEl.textContent = '', 3000);
            }
        });
    }
    
    function initializeDashboard() {
        const container = document.getElementById('dashboard-container');
        container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg border"><p>O dashboard será exibido aqui.</p></div>`;
    }

    // --- Event Listeners ---
    ELEMENTS.loginForm.addEventListener('submit', handleLogin);
    ELEMENTS.registerForm.addEventListener('submit', handleRegister);
    ELEMENTS.showRegister.addEventListener('click', (e) => { e.preventDefault(); showRegisterScreen(); });
    ELEMENTS.showLogin.addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });
    ELEMENTS.logoutBtn.addEventListener('click', handleLogout);
    
    ELEMENTS.sidebarNav.addEventListener('click', (event) => {
        const clickedButton = event.target.closest('.sidebar-btn');
        if (clickedButton) {
            ELEMENTS.sidebarNav.querySelectorAll('.sidebar-btn').forEach(btn => btn.classList.remove('sidebar-btn-active'));
            clickedButton.classList.add('sidebar-btn-active');
            renderTabContent(clickedButton.getAttribute('data-tab'));
        }
    });

    ELEMENTS.tabContent.addEventListener('click', (e) => {
        if (e.target.classList.contains('copy-btn')) {
            const button = e.target;
            const text = decodeURIComponent(button.dataset.copyText);
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                button.textContent = 'Copiado!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'Copiar';
                    button.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Falha ao copiar', err);
            }
            document.body.removeChild(textArea);
        }
    });
    </script>
</body>
</html>
