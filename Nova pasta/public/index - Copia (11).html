<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darks Vips AI v17.9</title>
    <!-- Favicon -->
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîÆ</text></svg>">
    
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .sidebar-btn { transition: all 0.2s ease-in-out; }
        .sidebar-btn:hover { background-color: #f1f5f9; color: #334155; }
        .sidebar-btn-active { background-color: #eef2ff; color: #4f46e5; font-weight: 600; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar-container { background-color: #e0e7ff; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-bar-inner { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
        .progress-bar-indeterminate { background-size: 200% 100%; background-image: linear-gradient(to right, #e0e7ff 0%, #c7d2fe 50%, #e0e7ff 100%); animation: move-bg 2s linear infinite; }
        @keyframes move-bg { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        #login-container { display: flex; }
        #register-container, #app-container, #progress-modal, #legend-modal, #ticket-modal { display: none; }
        .prose { max-width: none; }
        .copy-btn.copied { background-color: #10b981; color: white; }
        .app-title-gradient {
            background: linear-gradient(45deg, #4f46e5, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Log Panel */
        #log-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1e293b;
            color: #e2e8f0;
            z-index: 100;
            transition: max-height 0.3s ease-in-out;
            max-height: 40px;
            overflow: hidden;
            border-top: 1px solid #334155;
        }
        #log-panel.open { max-height: 300px; }
        #log-header { cursor: pointer; }
        #log-content { height: 240px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .log-entry { border-bottom: 1px solid #334155; }
        .log-info { color: #93c5fd; }
        .log-success { color: #4ade80; }
        .log-error { color: #f87171; }
        .log-warn { color: #facc15; }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            #app-container { flex-direction: column; }
            #sidebar { 
                position: fixed;
                left: -100%;
                top: 0;
                height: 100%;
                z-index: 40;
                transition: left 0.3s ease-in-out;
                width: 288px; /* w-72 */
            }
            #sidebar.open { left: 0; }
            #main-content { margin-left: 0; }
            #menu-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 30;
            }
            #app-container { padding-bottom: 40px; } /* Space for log panel */
        }
    </style>
</head>
<body class="text-slate-800" oncontextmenu="return false;">

    <!-- Telas de Autentica√ß√£o -->
    <div id="login-container" class="flex items-center justify-center h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <div class="flex flex-col items-center">
                 <div id="logo-container-login" class="w-16 h-16 mb-2"></div>
                <h2 class="text-3xl font-extrabold text-center app-title-gradient">Darks Vips AI</h2>
                <p class="mt-2 text-center text-sm text-slate-600">Fa√ßa login para continuar</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div id="login-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                <input id="login-email" type="email" autocomplete="email" required class="appearance-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Endere√ßo de e-mail">
                <input id="login-password" type="password" autocomplete="current-password" required class="appearance-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Senha">
                <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Entrar</button>
            </form>
            <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-slate-200"></div><span class="flex-shrink mx-4 text-slate-400 text-xs">OU</span><div class="flex-grow border-t border-slate-200"></div></div>
            
            <!-- Bot√£o de Login com Google -->
            <div class="flex justify-center">
                <div id="g_id_onload"
                     data-client_id="483231613006-31cqno4qts2p5ut9i0s7rrnpl488aiqc.apps.googleusercontent.com" <!-- IMPORTANTE: Substituir -->
                     data-callback="handleGoogleCredentialResponse">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="sign_in_with"
                     data-shape="rectangular"
                     data-logo_alignment="left">
                </div>
            </div>

            <p class="text-center text-sm mt-4">N√£o tem uma conta? <a href="#" id="show-register" class="font-medium text-indigo-600 hover:text-indigo-500">Registre-se</a></p>
        </div>
    </div>
    <div id="register-container" class="hidden items-center justify-center h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
             <div class="flex flex-col items-center">
                <div id="logo-container-register" class="w-16 h-16 mb-2"></div>
                <h2 class="text-3xl font-extrabold text-center text-slate-900">Criar Conta</h2>
                <p class="mt-2 text-center text-sm text-slate-600">Junte-se √† plataforma</p>
            </div>
            <form id="register-form" class="mt-8 space-y-6">
                <div id="register-feedback" class="text-red-500 text-sm text-center min-h-[20px]"></div>
                <input id="register-email" type="email" required class="appearance-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Seu melhor e-mail">
                <input id="register-password" type="password" required class="appearance-none relative block w-full px-3 py-3 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Crie uma senha forte">
                <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Criar Conta</button>
            </form>
            <p class="text-center text-sm">J√° tem uma conta? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">Fa√ßa login</a></p>
        </div>
    </div>

    <!-- Modal de Progresso -->
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h3 class="text-lg font-semibold text-slate-800 mb-2">Processando...</h3>
            <p id="progress-phrase" class="text-sm text-slate-600 mb-4">Otimizando para o algoritmo...</p>
            <div class="w-full bg-slate-200 rounded-full h-2.5"><div class="h-2.5 rounded-full progress-bar-indeterminate"></div></div>
        </div>
    </div>

    <!-- Modal de Legenda -->
    <div id="legend-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg relative">
            <button id="close-legend-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            <h3 class="text-2xl font-bold text-slate-800 mb-4">Entenda as Pontua√ß√µes</h3>
            <div class="space-y-4 text-slate-700">
                <div>
                    <h4 class="font-semibold text-lg text-indigo-600">Pontua√ß√£o de Conte√∫do (0-100)</h4>
                    <p class="text-sm">Mede a qualidade e o potencial geral de um nicho, ideia ou v√≠deo. Pontua√ß√µes mais altas indicam maior probabilidade de sucesso. Pontua√ß√µes acima de 80 s√£o excelentes.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-indigo-600">An√°lise de Nicho/Subnicho</h4>
                    <ul class="list-disc list-inside text-sm space-y-1 mt-1">
                        <li><strong class="text-green-600">Potencial:</strong> O qu√£o promissor o tema √© para crescimento.</li>
                        <li><strong class="text-yellow-600">Concorr√™ncia (menor √© melhor):</strong> O n√≠vel de satura√ß√£o do nicho. Pontua√ß√µes menores significam um oceano azul.</li>
                        <li><strong class="text-blue-600">Volume de Busca:</strong> O interesse de busca do p√∫blico.</li>
                        <li><strong class="text-purple-600">Originalidade:</strong> O qu√£o nova e criativa a ideia √©.</li>
                        <li><strong class="text-orange-600">Hype Score:</strong> Potencial de viraliza√ß√£o do t√≥pico.</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-indigo-600">An√°lise de Otimiza√ß√£o (SEO)</h4>
                    <ul class="list-disc list-inside text-sm space-y-1 mt-1">
                        <li><strong class="text-green-600">SEO & Engajamento:</strong> Avalia se o texto (t√≠tulo, descri√ß√£o, etc.) est√° alinhado com o que os algoritmos e o p√∫blico buscam.</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-lg text-indigo-600">An√°lise de Coment√°rios</h4>
                    <ul class="list-disc list-inside text-sm space-y-1 mt-1">
                        <li><strong class="text-pink-600">Sa√∫de da Comunidade:</strong> Mede o sentimento geral dos coment√°rios (positivo, negativo, misto).</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-lg text-indigo-600">An√°lise de Tend√™ncia (Google Trends)</h4>
                    <ul class="list-disc list-inside text-sm space-y-1 mt-1">
                        <li><strong class="text-red-500">Baixo:</strong> O interesse de busca √© baixo. Pode ser um nicho de baixa demanda ou muito sazonal.</li>
                        <li><strong class="text-yellow-500">M√©dio:</strong> O interesse √© razo√°vel. Uma base de p√∫blico est√°vel.</li>
                        <li><strong class="text-green-500">Alto:</strong> O interesse √© alto e crescente. Grande potencial, mas pode ter maior concorr√™ncia.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Ticket -->
    <div id="ticket-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg relative">
            <button id="close-ticket-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            <h3 class="text-2xl font-bold text-slate-800 mb-4">Reportar um Problema</h3>
            <form id="ticket-form" class="space-y-4">
                <div>
                    <label for="ticket-description" class="block text-sm font-medium text-slate-700">Descreva o problema</label>
                    <textarea id="ticket-description" rows="5" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="Seja o mais detalhado poss√≠vel..."></textarea>
                </div>
                <div>
                    <label for="ticket-screenshot" class="block text-sm font-medium text-slate-700">Anexar print da tela</label>
                    <p class="text-xs text-slate-500">Um print da tela atual ser√° anexado automaticamente.</p>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Enviar Ticket</button>
            </form>
        </div>
    </div>


    <!-- Conte√∫do da Aplica√ß√£o -->
    <div id="app-container" class="hidden h-screen bg-slate-50">
        <div id="menu-overlay" class="hidden md:hidden"></div>
        <aside id="sidebar" class="w-72 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col">
            <div class="p-6 border-b flex items-center gap-3">
                <div id="logo-container-sidebar" class="w-10 h-10"></div>
                <h1 class="text-2xl font-bold app-title-gradient">Darks Vips AI</h1>
                <button id="close-menu-btn" class="md:hidden text-2xl ml-auto">&times;</button>
            </div>
            <div class="p-4 text-sm text-slate-500" id="user-email-display"></div>
            <nav id="sidebar-nav" class="p-4 space-y-1 flex-1 overflow-y-auto"></nav>
            <div class="p-4 border-t space-y-2">
                 <button id="open-ticket-btn" class="w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-amber-50 hover:text-amber-700">
                    <span>üêû</span><span>Reportar Erro</span>
                </button>
                <button id="logout-btn" class="w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-red-50 hover:text-red-700">
                    <span>üö™</span><span>Sair</span>
                </button>
            </div>
        </aside>
        <div id="main-content" class="flex-1 flex flex-col overflow-hidden">
            <header class="p-4 md:hidden bg-white border-b flex items-center">
                <button id="open-menu-btn" class="text-2xl">‚ò∞</button>
                <h2 id="mobile-header-title" class="ml-4 font-semibold text-lg">Dashboard</h2>
            </header>
            <main id="tab-content" class="flex-1 p-6 md:p-10 overflow-y-auto"></main>
        </div>
    </div>
    
    <!-- Painel de Log -->
    <div id="log-panel">
        <div id="log-header" class="p-2 bg-slate-700 flex justify-between items-center">
            <span class="text-sm font-semibold">Logs da Aplica√ß√£o</span>
            <span id="log-toggle-icon">‚ñ≤</span>
        </div>
        <div id="log-content" class="p-2"></div>
    </div>

    <script>
    // --- Global State Management ---
    let appState = {
        currentUser: null,
        token: null, // <-- Para armazenar o JWT
        apiKeys: { 
            gemini: "", 
            gemini_backup1: "",
            gemini_backup2: "",
            openai: "", 
            google_api: "", 
            openrouter: "" 
        },
        userChannels: [],
        videoIdeas: [],
        currentGeminiKeyIndex: 0
    };

    // --- Constants ---
    const ELEMENTS = {
        loginContainer: document.getElementById('login-container'),
        registerContainer: document.getElementById('register-container'),
        appContainer: document.getElementById('app-container'),
        loginForm: document.getElementById('login-form'),
        registerForm: document.getElementById('register-form'),
        loginFeedback: document.getElementById('login-feedback'),
        registerFeedback: document.getElementById('register-feedback'),
        showRegister: document.getElementById('show-register'),
        showLogin: document.getElementById('show-login'),
        sidebar: document.getElementById('sidebar'),
        sidebarNav: document.getElementById('sidebar-nav'),
        tabContent: document.getElementById('tab-content'),
        progressModal: document.getElementById('progress-modal'),
        progressPhrase: document.getElementById('progress-phrase'),
        userEmailDisplay: document.getElementById('user-email-display'),
        logoutBtn: document.getElementById('logout-btn'),
        openMenuBtn: document.getElementById('open-menu-btn'),
        closeMenuBtn: document.getElementById('close-menu-btn'),
        menuOverlay: document.getElementById('menu-overlay'),
        mobileHeaderTitle: document.getElementById('mobile-header-title'),
        legendModal: document.getElementById('legend-modal'),
        closeLegendModal: document.getElementById('close-legend-modal'),
        ticketModal: document.getElementById('ticket-modal'),
        closeTicketModal: document.getElementById('close-ticket-modal'),
        openTicketBtn: document.getElementById('open-ticket-btn'),
        ticketForm: document.getElementById('ticket-form'),
        logPanel: document.getElementById('log-panel'),
        logHeader: document.getElementById('log-header'),
        logContent: document.getElementById('log-content'),
        logToggleIcon: document.getElementById('log-toggle-icon')
    };

    const PROGRESS_PHRASES = [ "Decodificando o algoritmo...", "Buscando insights virais...", "Consultando os dados de tend√™ncia...", "Polindo as palavras-chave...", "Ajustando o potencial de clique..." ];

    // --- Logging System ---
    function log(message, type = 'info') {
        const now = new Date();
        const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        const entry = document.createElement('div');
        entry.className = `log-entry p-1 log-${type}`;
        entry.innerHTML = `<span class="font-semibold">[${timestamp}]</span>: ${message}`;
        ELEMENTS.logContent.appendChild(entry);
        ELEMENTS.logContent.scrollTop = ELEMENTS.logContent.scrollHeight; // Auto-scroll
    }

    // --- API Communication ---
    async function apiRequest(endpoint, method, body = null) {
        log(`Iniciando requisi√ß√£o ${method} para ${endpoint}`);
        const headers = { 'Content-Type': 'application/json' };
        // Adiciona o token de autentica√ß√£o se estiver dispon√≠vel
        if (appState.token) {
            headers['Authorization'] = `Bearer ${appState.token}`;
        }
        
        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);

        try {
            const response = await fetch(endpoint, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Ocorreu um erro na API do servidor.');
            }
            const contentType = response.headers.get("content-type");
            const result = contentType?.includes("application/json") ? await response.json() : null;
            log(`Requisi√ß√£o para ${endpoint} bem-sucedida.`, 'success');
            return result;
        } catch (error) {
            log(`Falha na requisi√ß√£o para ${endpoint}: ${error.message}`, 'error');
            throw error;
        }
    }

    // --- Authentication ---
    function showLoginScreen() {
        ELEMENTS.registerContainer.style.display = 'none';
        ELEMENTS.loginContainer.style.display = 'flex';
    }

    function showRegisterScreen() {
        ELEMENTS.loginContainer.style.display = 'none';
        ELEMENTS.registerContainer.style.display = 'flex';
    }

    async function handleLogin(e) {
        e.preventDefault();
        log('Tentativa de login com e-mail/senha...');
        ELEMENTS.loginFeedback.textContent = '';
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            const data = await apiRequest('/api/login', 'POST', { email, password });
            appState.currentUser = data.user;
            appState.token = data.accessToken;
            await initializeApp();
        } catch (error) {
            ELEMENTS.loginFeedback.textContent = error.message;
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        log('Tentativa de registro...');
        ELEMENTS.registerFeedback.textContent = '';
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        try {
            const data = await apiRequest('/api/register', 'POST', { email, password });
            appState.currentUser = data.user;
            appState.token = data.accessToken;
            await initializeApp();
        } catch (error) {
            ELEMENTS.registerFeedback.textContent = error.message;
        }
    }

    // [CORRE√á√ÉO] Callback do Login com Google agora √© global
    window.handleGoogleCredentialResponse = async (response) => {
        log('Recebida credencial do Google. Enviando para o backend...');
        try {
            const data = await apiRequest('/api/google-login', 'POST', { credential: response.credential });
            if (data && data.user && data.accessToken) {
                appState.currentUser = data.user;
                appState.token = data.accessToken;
                await initializeApp();
            } else {
                throw new Error("Resposta do servidor inv√°lida ap√≥s login com Google.");
            }
        } catch (error) {
            ELEMENTS.loginFeedback.textContent = 'Falha no login com Google: ' + error.message;
            log('Falha no login com Google: ' + error.message, 'error');
        }
    }
    
    function handleLogout() {
        log('Usu√°rio deslogado.');
        appState = { currentUser: null, token: null, apiKeys: { gemini: "", gemini_backup1: "", gemini_backup2: "", openai: "", google_api: "", openrouter: "" }, userChannels: [], videoIdeas: [], currentGeminiKeyIndex: 0 };
        ELEMENTS.appContainer.style.display = 'none';
        showLoginScreen();
        document.getElementById('login-form').reset();
    }

    // --- App Initialization ---
    async function initializeApp() {
        if (!appState.currentUser || !appState.token) {
            log('Falha na inicializa√ß√£o: usu√°rio ou token ausente.', 'error');
            return;
        }
        log(`Inicializando aplica√ß√£o para ${appState.currentUser.email}...`);
        
        try {
            const settings = await apiRequest(`/api/settings/${appState.currentUser.id}`, 'GET');
            if (settings && Object.keys(settings).length > 0) {
                appState.apiKeys = { ...appState.apiKeys, ...settings };
                appState.userChannels = settings.userChannels || [];
                appState.videoIdeas = settings.videoIdeas || [];
            }
            log('Configura√ß√µes do usu√°rio carregadas.', 'success');
        } catch(error) {
            log(`N√£o foi poss√≠vel carregar as configura√ß√µes: ${error.message}`, 'warn');
        }

        ELEMENTS.userEmailDisplay.textContent = appState.currentUser.email;
        ELEMENTS.loginContainer.style.display = 'none';
        ELEMENTS.registerContainer.style.display = 'none';
        ELEMENTS.appContainer.style.display = 'flex';
        
        buildSidebar();
        renderTabContent('dashboard');
        startNotificationChecker();
    }

    // --- UI Building ---
    function buildSidebar() {
        const navItems = [
            { id: 'dashboard', icon: 'üìà', label: 'Dashboard' },
            { type: 'divider', label: 'PESQUISA E ESTRAT√âGIA' },
            { id: 'niche-finder', icon: 'üîé', label: 'Localizador de Nichos' },
            { id: 'subniche-finder', icon: 'üíé', label: 'Explorador de Subnichos' },
            { id: 'niche-analysis', icon: 'üìä', label: 'An√°lise de Nicho' },
            { id: 'video-optimizer', icon: 'üöÄ', label: 'Analisador de V√≠deo' },
            { id: 'competitor-analysis', icon: 'üïµÔ∏è', label: 'An√°lise de Concorr√™ncia' },
            { id: 'comment-analyzer', icon: 'üí¨', label: 'An√°lise de Coment√°rios' },
            { type: 'divider', label: 'CRIA√á√ÉO E CONTE√öDO' },
            { id: 'title-structures', icon: 'üèóÔ∏è', label: 'Estruturas de T√≠tulos' },
            { id: 'script-writer', icon: 'üìú', label: 'Criador de Roteiros' },
            { id: 'shorts-script-writer', icon: '‚ö°', label: 'Roteiros para Shorts' },
            { id: 'content-recycler', icon: '‚ôªÔ∏è', label: 'Reciclador de Conte√∫do' },
            { id: 'visual-storyboard', icon: 'üé¨', label: 'Storyboard Visual' },
            { id: 'thumbnail-prompts', icon: 'üé®', label: 'Prompts de Thumbnail' },
            { type: 'divider', label: 'OTIMIZA√á√ÉO E GEST√ÉO' },
            { id: 'description-optimizer', icon: 'üìÑ', label: 'Otimizador de Descri√ß√£o' },
            { id: 'tag-generator', icon: 'üè∑Ô∏è', label: 'Gerador de Tags' },
            { id: 'channel-organizer', icon: 'üì∫', label: 'Organizador de Canais' },
            { id: 'planner', icon: 'üóìÔ∏è', label: 'Planejador de Conte√∫do' },
            { id: 'monetization-helper', icon: 'üí∞', label: 'Ideias de Monetiza√ß√£o' },
            { id: 'settings', icon: '‚öôÔ∏è', label: 'Configura√ß√µes' },
        ];

        ELEMENTS.sidebarNav.innerHTML = navItems.map(item => {
            if (item.type === 'divider') {
                return `<div class="pt-2 mt-2 border-t"><span class="px-4 text-xs font-semibold text-slate-400">${item.label}</span></div>`;
            }
            return `<button class="sidebar-btn ${item.id === 'dashboard' ? 'sidebar-btn-active' : ''} w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg" data-tab="${item.id}"><span>${item.icon}</span><span>${item.label}</span></button>`;
        }).join('');
    }
    
    // --- Utility Functions ---
    const showProgressModal = () => { ELEMENTS.progressModal.style.display = 'flex'; ELEMENTS.progressPhrase.textContent = PROGRESS_PHRASES[Math.floor(Math.random() * PROGRESS_PHRASES.length)]; };
    const hideProgressModal = () => { ELEMENTS.progressModal.style.display = 'none'; };
    const getScoreColor = (score) => score >= 80 ? 'bg-green-500' : score >= 50 ? 'bg-yellow-500' : 'bg-red-500';
    const getScoreTextColor = (score) => score >= 80 ? 'text-green-500' : score >= 50 ? 'text-yellow-500' : 'text-red-500';
    const createCopyButton = (text) => `<button class="copy-btn text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded hover:bg-slate-300" data-copy-text="${encodeURIComponent(text)}">Copiar</button>`;
    const createCorrectButton = (text) => {
        if (!appState.apiKeys.openrouter) return '';
        return `<button class="correct-btn text-xs bg-slate-500 text-white px-2 py-1 rounded hover:bg-slate-600 ml-2" data-correct-text="${encodeURIComponent(text)}">Revisar com OpenRouter</button>`;
    };
    
    const getTrendLevel = (score) => {
        if (score > 66) return "Alto";
        if (score > 33) return "M√©dio";
        return "Baixo";
    };

    const renderScoreCard = (title, mainScore, subScores, suggestion, isNovel = false) => {
        const intMainScore = Math.round(Math.min(100, mainScore || 0));
        const novelBadge = isNovel ? '<span class="inline-flex items-center rounded-md bg-purple-100 px-2 py-1 text-xs font-medium text-purple-700">‚ú® In√©dita</span>' : '';
        const subScoresHtml = Object.entries(subScores).map(([key, value]) => {
            let displayValue = typeof value === 'number' ? `${Math.round(value)}/100` : value;
            let color = 'text-slate-700';
            let progress = '';

            if (key.includes('Busca')) {
                 displayValue = getTrendLevel(value);
                 color = displayValue === 'Alto' ? 'text-green-500' : displayValue === 'M√©dio' ? 'text-yellow-500' : 'text-red-500';
            } else if (typeof value === 'number') {
                color = getScoreTextColor(value);
                progress = `<div class="progress-bar-container"><div class="progress-bar-inner ${getScoreColor(value)}" style="width: ${value}%;"></div></div>`;
            } else {
                 color = value === 'Positiva' ? 'text-green-500' : value === 'Negativa' ? 'text-red-500' : value === 'Mista' ? 'text-yellow-500' : 'text-slate-700';
            }
            
            return `
            <div class="mb-2">
                <div class="flex justify-between items-center text-sm mb-1"><span class="text-slate-600">${key}</span><span class="font-semibold ${color}">${displayValue}</span></div>
                ${progress}
            </div>`;
        }).join('');
        return `<div class="bg-white p-4 rounded-lg border w-full md:w-72 flex-shrink-0">
                    <h4 class="font-semibold text-slate-800 mb-2">${title}</h4>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-baseline gap-1">
                            <span class="text-3xl font-bold ${getScoreTextColor(intMainScore)}">${intMainScore}</span>
                            <span class="text-slate-500 text-sm">/ 100</span>
                        </div>
                        ${novelBadge}
                    </div>
                    ${subScoresHtml}
                    ${suggestion ? `<p class="text-xs text-slate-500 mt-4"><strong class="text-slate-600">A Virada de Chave:</strong> ${suggestion}</p>` : ''}
                </div>`;
    };

    // --- Gemini API Call with Key Rotation ---
    function getAvailableGeminiKeys() {
        return [
            appState.apiKeys.gemini,
            appState.apiKeys.gemini_backup1,
            appState.apiKeys.gemini_backup2
        ].filter(key => key && key.trim() !== '');
    }

    async function callGenerativeAPI(prompt, schema = null) {
        const availableKeys = getAvailableGeminiKeys();
        if (availableKeys.length === 0) {
            log("Nenhuma chave da API Gemini configurada.", 'error');
            hideProgressModal();
            throw new Error("Nenhuma chave da API Gemini encontrada. Por favor, adicione-a nas Configura√ß√µes.");
        }

        showProgressModal();
        
        for (let i = 0; i < availableKeys.length; i++) {
            const currentKey = availableKeys[appState.currentGeminiKeyIndex % availableKeys.length];
            log(`Tentando chamada √† API com a chave #${appState.currentGeminiKeyIndex + 1}`);
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${currentKey}`;
            const finalPrompt = `Responda em texto puro (plain text), sem usar formata√ß√£o markdown. Use codifica√ß√£o UTF-8. ${prompt}`;
            let payload = { contents: [{ role: "user", parts: [{ text: finalPrompt }] }] };
            if (schema) {
                payload.generationConfig = { 
                    response_mime_type: "application/json",
                    response_schema: schema
                };
            }

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });
                clearTimeout(timeoutId);

                if (response.ok) {
                    const result = await response.json();
                     if (result.candidates?.[0]?.content?.parts?.[0]) {
                        log('API Gemini respondeu com sucesso.', 'success');
                        hideProgressModal();
                        const text = result.candidates[0].content.parts[0].text;
                        try {
                            return schema ? JSON.parse(text) : { text };
                        } catch (jsonError) {
                            log(`Erro ao parsear JSON da API: ${jsonError.message}`, 'error');
                            log(`Resposta de texto recebida: ${text}`, 'info');
                            throw new Error("A resposta da API n√£o √© um JSON v√°lido.");
                        }
                    }
                    if (result.candidates?.[0]?.finishReason === 'SAFETY') throw new Error("A resposta foi bloqueada por pol√≠ticas de seguran√ßa.");
                    throw new Error("Resposta da API inv√°lida ou vazia.");
                }

                // [CORRE√á√ÉO] Trata erros de cota e de servidor para tentar a pr√≥xima chave
                if (response.status === 429 || response.status >= 500) {
                    log(`Erro ${response.status} com a chave #${appState.currentGeminiKeyIndex + 1}. Tentando a pr√≥xima...`, 'warn');
                    appState.currentGeminiKeyIndex++;
                    if (i < availableKeys.length - 1) continue;
                    throw new Error("Todas as chaves da API Gemini falharam ou excederam a cota.");
                }
                
                const errorBody = await response.json();
                throw new Error(`Erro na API: ${response.status} - ${errorBody.error?.message || 'Verifique sua chave de API.'}`);

            } catch (error) {
                log(`Erro na chamada da API com a chave #${appState.currentGeminiKeyIndex + 1}: ${error.message}`, 'error');
                appState.currentGeminiKeyIndex++; // Tenta a pr√≥xima chave em caso de erro de rede/timeout
                if (i === availableKeys.length - 1) {
                    hideProgressModal();
                    throw error;
                }
            }
        }
        hideProgressModal();
        throw new Error("Todas as chaves da API Gemini falharam.");
    }

    // --- OpenRouter API Call for text correction
    async function correctTextWithOpenRouter(text) {
        const openrouterKey = appState.apiKeys.openrouter || "";
        if (!openrouterKey) {
            hideProgressModal();
            log("Chave da API OpenRouter n√£o encontrada.", 'warn');
            return text;
        }
        showProgressModal();
        try {
            const response = await apiRequest('/api/correct-text', 'POST', { text, openrouterKey });
            return response.text;
        } catch (error) {
            hideProgressModal();
            throw error;
        }
    }
    
    // --- Tools and Handlers ---
    let trendsChartInstance = null;
    const tools = {
        "dashboard": { title: "Dashboard de Performance", desc: "Selecione um canal para ver as m√©tricas e obter insights da IA.", content: `<div id="dashboard-container"></div>` },
        "niche-finder": { 
            title: "Localizador de Nichos", 
            desc: "Encontre nichos e tend√™ncias de mercado com estimativas de RPM.", 
            content: `<div class="bg-white p-6 rounded-xl shadow-sm border">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="niche-keyword" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Palavra-chave (opcional)">
                            <select id="niche-country" class="w-full px-4 py-3 bg-slate-100 border rounded-lg">
                                <option value="BR">Brasil</option><option value="US">EUA</option><option value="PT">Portugal</option><option value="ES">Espanha</option><option value="DE">Alemanha</option><option value="FR">Fran√ßa</option><option value="GB">Reino Unido</option><option value="JP">Jap√£o</option>
                            </select>
                        </div>
                        <button id="generate-niches" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üîé Encontrar Nichos</button>
                        <div id="output" class="mt-6"></div>
                        <button id="generate-more-niches" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button>
                      </div>` 
        },
        "subniche-finder": { 
            title: "Explorador de Subnichos", 
            desc: "Descubra subnichos inexplorados a partir de um nicho principal.", 
            content: `<div class="bg-white p-6 rounded-xl shadow-sm border">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="main-niche" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nicho principal (ou deixe em branco)">
                            <select id="subniche-country" class="w-full px-4 py-3 bg-slate-100 border rounded-lg">
                                <option value="BR">Brasil</option><option value="US">EUA</option><option value="PT">Portugal</option><option value="ES">Espanha</option><option value="DE">Alemanha</option><option value="FR">Fran√ßa</option><option value="GB">Reino Unido</option><option value="JP">Jap√£o</option>
                            </select>
                        </div>
                        <button id="find-subniches" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üíé Explorar Subnichos</button>
                        <div id="output" class="mt-6"></div>
                        <button id="generate-more-subniches" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button>
                      </div>` 
        },
        "niche-analysis": { title: "An√°lise de Nicho (RPM/Hype)", desc: "Analise o potencial de um nicho espec√≠fico.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="analysis-niche" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nicho a ser analisado"><select id="analysis-country" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="BR">Brasil</option><option value="US">EUA</option><option value="PT">Portugal</option><option value="ES">Espanha</option><option value="DE">Alemanha</option><option value="FR">Fran√ßa</option></select></div><button id="analyze-niche" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üìä Analisar Nicho</button><div id="output" class="mt-6"></div></div>` },
        "video-optimizer": { title: "Analisador de V√≠deo (URL)", desc: "Otimize t√≠tulos, descri√ß√µes e tags a partir de uma URL do YouTube.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="url" id="video-url" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="https://www.youtube.com/watch?v=..."><button id="analyze-video" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üöÄ Otimizar V√≠deo</button><div id="output" class="mt-6"></div></div>` },
        "competitor-analysis": { title: "An√°lise de Concorr√™ncia", desc: "Analise a estrat√©gia de canais concorrentes para encontrar oportunidades.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="competitor-channel-id" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="ID do Canal concorrente (Ex: UC_x5XG1OV2P6uZZ5FSM9Ttw)"><button id="analyze-competitor" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üïµÔ∏è Analisar Concorrente</button><div id="output" class="mt-6"></div></div>` },
        "comment-analyzer": { title: "An√°lise de Coment√°rios", desc: "Entenda o sentimento do p√∫blico e extraia ideias dos coment√°rios de um v√≠deo.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="url" id="comment-video-url" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="URL do v√≠deo para analisar os coment√°rios"><button id="analyze-comments" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üí¨ Analisar Coment√°rios</button><div id="output" class="mt-6"></div></div>` },
        "title-structures": { title: "Estruturas de T√≠tulos Virais", desc: "Gere estruturas de t√≠tulos com alto potencial de clique.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="structure-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="T√≥pico. Ex: Produtividade"><select id="structure-lang" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="pt-BR">Portugu√™s</option><option value="en-US">Ingl√™s</option><option value="es-ES">Espanhol</option></select></div><button id="generate-structures" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üèóÔ∏è Gerar Estruturas</button><div id="output" class="mt-6 space-y-4"></div><button id="generate-more-structures" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button></div>` },
        "script-writer": { title: "Criador de Roteiros", desc: "Gere roteiros com foco em alta reten√ß√£o.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="space-y-4"><input type="text" id="script-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="T√≥pico do V√≠deo"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="number" id="script-duration" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Dura√ß√£o (minutos)"><input type="number" id="script-parts" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="N¬∫ de Partes"></div><div class="flex items-center"><input id="script-narration-only" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="script-narration-only" class="ml-2 block text-sm text-gray-900">Apenas Narra√ß√£o (sem di√°logos)</label></div><button id="generate-script" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üìú Gerar Roteiro</button></div><div id="output" class="mt-6"></div></div>` },
        "shorts-script-writer": { title: "Roteiros para Shorts", desc: "Crie roteiros r√°pidos e din√¢micos para v√≠deos verticais (Shorts, Reels, TikTok).", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="shorts-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="T√≥pico do v√≠deo curto"><button id="generate-shorts-script" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">‚ö° Gerar Roteiro de Short</button><div id="output" class="mt-6"></div></div>` },
        "content-recycler": { title: "Reciclador de Conte√∫do", desc: "Transforme um roteiro de v√≠deo longo em v√°rias ideias para v√≠deos curtos.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><textarea id="recycler-script" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" rows="10" placeholder="Cole aqui o roteiro do seu v√≠deo longo..."></textarea><button id="recycle-content" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">‚ôªÔ∏è Reciclar Conte√∫do</button><div id="output" class="mt-6"></div></div>` },
        "visual-storyboard": { 
            title: "Storyboard Visual", 
            desc: "Transforme seu roteiro em um guia de cenas e visuais.", 
            content: `<div class="bg-white p-6 rounded-xl shadow-sm border">
                        <textarea id="storyboard-script" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" rows="8" placeholder="Cole seu roteiro aqui..."></textarea>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="storyboard-minutes" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Minutos">
                                <input type="number" id="storyboard-seconds" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Segundos">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="storyboard-scene-seconds" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Segs / cena">
                                <input type="number" id="storyboard-words-scene" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Palavras / cena">
                            </div>
                        </div>
                        <button id="generate-storyboard" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üé¨ Criar Storyboard</button>
                        <div id="output" class="mt-6"></div>
                      </div>` 
        },
        "thumbnail-prompts": { title: "Prompts de Thumbnail", desc: "Gere prompts otimizados para IAs de imagem.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="space-y-4"><input type="text" id="thumb-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="T√≠tulo do V√≠deo"><select id="thumb-platform" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="Midjourney">Midjourney</option><option value="Leonardo.AI">Leonardo.AI</option><option value="DALL-E 3">DALL-E 3</option><option value="Freepik">Freepik</option></select></div><button id="generate-prompts" class="w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üé® Gerar Prompts</button><div id="output" class="mt-6 space-y-4"></div><button id="generate-more-prompts" class="hidden w-full mt-4 bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Gerar Mais</button></div>` },
        "description-optimizer": { title: "Otimizador de Descri√ß√£o", desc: "Crie descri√ß√µes com SEO e CTAs eficazes.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><input type="text" id="desc-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4" placeholder="T√≠tulo do V√≠deo"><textarea id="desc-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" rows="4" placeholder="Resumo do v√≠deo e palavras-chave..."></textarea><button id="generate-description" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üìÑ Gerar Descri√ß√£o</button><div id="output" class="mt-6"></div></div>` },
        "tag-generator": { title: "Gerador de Tags", desc: "Gere tags relevantes para maximizar o alcance.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="tag-topic" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="T√≥pico do V√≠deo"><select id="tag-lang" class="w-full px-4 py-3 bg-slate-100 border rounded-lg"><option value="pt-BR">Portugu√™s</option><option value="en-US">Ingl√™s</option><option value="es-ES">Espanhol</option></select></div><button id="generate-tags" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üè∑Ô∏è Gerar Tags</button><div id="output" class="mt-6"></div></div>` },
        "channel-organizer": { title: "Organizador de Canais", desc: "Adicione e gerencie as informa√ß√µes e estrat√©gias dos seus canais.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border mb-6"><h3 class="text-lg font-semibold mb-4">Adicionar Novo Canal</h3><form id="channel-form" class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="org-channel-name" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nome do Canal" required><input type="text" id="org-channel-niche" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Nicho Principal" required><select id="org-channel-lang" class="px-4 py-3 bg-slate-100 border rounded-lg"><option value="pt-BR">Portugu√™s (BR)</option><option value="en-US">Ingl√™s (US)</option><option value="es-ES">Espanhol (ES)</option></select><input type="number" id="org-videos-week" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="V√≠deos por Semana" required><input type="text" id="org-post-time" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Hor√°rio de Postagem. Ex: 18:00"><input type="number" id="org-backlog-qty" class="px-4 py-3 bg-slate-100 border rounded-lg" placeholder="Qtd. de V√≠deos no Backlog"><button type="submit" class="md:col-span-2 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Adicionar Canal</button></form></div><div id="organizer-output" class="space-y-4"></div>` },
        "planner": { 
            title: "Planejador de Conte√∫do", 
            desc: "Organize suas ideias de v√≠deo, agende postagens e receba alertas.", 
            content: `<div class="bg-white p-6 rounded-xl shadow-sm border mb-6">
                        <h3 class="text-lg font-semibold mb-4">Adicionar Nova Ideia</h3>
                        <form id="planner-form" class="space-y-4">
                            <select id="planner-channel-select" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" required><option value="">Selecione um Canal</option></select>
                            <input type="text" id="idea-title" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" placeholder="T√≠tulo da ideia de v√≠deo" required>
                            <input type="datetime-local" id="idea-datetime" class="w-full px-4 py-3 bg-slate-100 border rounded-lg" title="Data e hora de postagem">
                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Adicionar ao Planejamento</button>
                        </form>
                      </div>
                      <div id="planner-output" class="space-y-4"></div>` 
        },
        "monetization-helper": { title: "Ideias de Monetiza√ß√£o", desc: "Descubra novas formas de monetizar seu canal al√©m do AdSense.", content: `<div class="bg-white p-6 rounded-xl shadow-sm border"><select id="monetization-channel-select" class="w-full px-4 py-3 bg-slate-100 border rounded-lg mb-4"><option value="">Selecione um canal cadastrado</option></select><button id="generate-monetization-ideas" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">üí∞ Gerar Ideias</button><div id="output" class="mt-6"></div></div>` },
        "settings": { 
            title: "Configura√ß√µes", 
            desc: "Gerencie suas chaves de API.", 
            content: `<div class="bg-white p-6 rounded-xl shadow-sm border space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold">Chaves de API</h3>
                            <div class="space-y-4 mt-2">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Gemini API Key (Principal)</label>
                                    <input type="password" id="gemini-key" class="mt-1 block w-full px-3 py-2 border rounded-md">
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-indigo-600 hover:underline">Obter chave do Google AI Studio</a>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Gemini API Key (Reserva 1)</label>
                                    <input type="password" id="gemini-key-backup1" class="mt-1 block w-full px-3 py-2 border rounded-md">
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-slate-700">Gemini API Key (Reserva 2)</label>
                                    <input type="password" id="gemini-key-backup2" class="mt-1 block w-full px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">OpenRouter API Key (Opcional)</label>
                                    <input type="password" id="openrouter-key" class="mt-1 block w-full px-3 py-2 border rounded-md">
                                    <a href="https://openrouter.ai/keys" target="_blank" class="text-xs text-indigo-600 hover:underline">Obter chave da OpenRouter</a>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Google API Key (YouTube Data)</label>
                                    <input type="password" id="google-api-key" class="mt-1 block w-full px-3 py-2 border rounded-md">
                                    <p class="text-xs text-slate-500 mt-1">Usada para buscar dados de canais e v√≠deos do YouTube.</p>
                                    <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-xs text-indigo-600 hover:underline">Obter chave do Google Cloud (com YouTube Data API v3 ativada)</a>
                                </div>
                            </div>
                        </div>
                        <button id="save-settings" class="w-full bg-indigo-800 text-white font-bold py-3 px-4 rounded-lg mt-6">Salvar Configura√ß√µes</button>
                        <div id="settings-feedback" class="mt-4 min-h-[20px]"></div>
                      </div>` 
        },
    };
    
    // --- Handlers (L√≥gica das Ferramentas) ---
    const handlers = {
        'generate-niches': async (output, append = false) => {
            try {
                const keyword = document.getElementById('niche-keyword').value || 't√≥picos em alta';
                const country = document.getElementById('niche-country').value;
                const prompt = `Como um especialista em YouTube, gere EXATAMENTE 3 nichos promissores para o YouTube sobre '${keyword}' para o pa√≠s ${country}. Foque em oportunidades com baixa concorr√™ncia e que sejam adequadas para monetiza√ß√£o. Para cada nicho, forne√ßa uma sugest√£o estrat√©gica que seja uma "virada de chave" e uma estimativa de RPM em d√≥lares americanos.`;
                const schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            niche_name: { type: "STRING" },
                            description: { type: "STRING" },
                            unexplored_subniches: { type: "ARRAY", items: { type: "STRING" } },
                            rpm_estimate_value: { type: "NUMBER", description: "Estimativa de RPM em d√≥lares, ex: 5.50" },
                            scores: {
                                type: "OBJECT",
                                properties: {
                                    Potencial: { type: "NUMBER", description: "Pontua√ß√£o de potencial (70-95, >90 √© raro)." },
                                    Concorr√™ncia: { type: "NUMBER", description: "Pontua√ß√£o de concorr√™ncia (10-60)." },
                                    "Volume de Busca": { type: "NUMBER", description: "Pontua√ß√£o de volume de busca (60-95)." }
                                }
                            },
                            suggestion: { type: "STRING", description: "A 'virada de chave' para o sucesso no nicho." }
                        }
                    }
                };
                const result = await callGenerativeAPI(prompt, schema);
                const html = result.map(item => `<div class="bg-slate-100 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4"><div class="flex-1"><h3 class="font-semibold text-lg mb-2">${item.niche_name} ${createCopyButton(item.niche_name)}</h3><p class="text-sm text-slate-700">${item.description}</p><p class="mt-2 font-semibold text-sm">RPM Estimado: $${(item.rpm_estimate_value || 0).toFixed(2)}</p><p class="mt-2 font-semibold text-sm">Subnichos Inexplorados: ${item.unexplored_subniches.join(', ')}</p></div>${renderScoreCard('An√°lise de Nicho', item.scores.Potencial, { 'Potencial': item.scores.Potencial, 'Concorr√™ncia (menor √© melhor)': 100 - item.scores.Concorr√™ncia, 'Busca': item.scores['Volume de Busca'] }, item.suggestion)}</div>`).join('');
                if (append) output.insertAdjacentHTML('beforeend', html); else output.innerHTML = html;
                document.getElementById('generate-more-niches').style.display = 'block';
            } catch(error) {
                output.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`;
            }
        },
        'find-subniches': async (output, append = false) => {
            try {
                let mainNiche = document.getElementById('main-niche').value.trim();
                const country = document.getElementById('subniche-country').value;
                if (!mainNiche) { mainNiche = "qualquer nicho com alta demanda e baixa concorr√™ncia" }
                
                const prompt = `Para o nicho principal de "${mainNiche}", no pa√≠s ${country}, gere EXATAMENTE 3 subnichos inexplorados e criativos para o YouTube. Para cada um, forne√ßa: uma descri√ß√£o, ideias de v√≠deo, uma sugest√£o "virada de chave", indique se √© uma ideia in√©dita, e pontua√ß√µes de 0 a 100 para "Potencial", "Concorr√™ncia" (onde menor √© melhor), e "Originalidade".`;
                const schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            subniche_name: { type: "STRING" },
                            description: { type: "STRING" },
                            video_ideas: { type: "ARRAY", items: { type: "STRING" } },
                            is_novel: { type: "BOOLEAN" },
                            scores: {
                                type: "OBJECT",
                                properties: {
                                    Potencial: { type: "NUMBER" },
                                    Concorr√™ncia: { type: "NUMBER" },
                                    "Originalidade": { type: "NUMBER" }
                                }
                            },
                            suggestion: { type: "STRING" }
                        }
                    }
                };
                const result = await callGenerativeAPI(prompt, schema);
                const html = result.map(item => {
                    const mainScore = item.scores?.Potencial || 0;
                    const subScores = {
                        'Potencial': item.scores?.Potencial || 0,
                        'Concorr√™ncia (menor √© melhor)': 100 - (item.scores?.Concorr√™ncia || 50),
                        'Originalidade': item.scores?.Originalidade || 0
                    };
                    return `<div class="bg-slate-100 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4"><div class="flex-1"><h3 class="font-semibold text-lg mb-2">${item.subniche_name} ${createCopyButton(item.subniche_name)}</h3><p class="text-sm text-slate-700">${item.description || ''}</p><p class="mt-2 font-semibold text-sm">Ideias de V√≠deo: ${(item.video_ideas || []).join('; ')}</p></div>${renderScoreCard('An√°lise do Subnicho', mainScore, subScores, item.suggestion, item.is_novel)}</div>`;
                }).join('');

                if (append) output.insertAdjacentHTML('beforeend', html); else output.innerHTML = html;
                document.getElementById('generate-more-subniches').style.display = 'block';
            } catch (error) {
                console.error("Erro no Explorador de Subnichos:", error);
                output.innerHTML = `<p class="text-red-500">Ocorreu um erro ao buscar os subnichos. A IA pode estar sobrecarregada ou a chave de API √© inv√°lida. Detalhe: ${error.message}</p>`;
            }
        },
        'analyze-niche': async (output) => {
            const niche = document.getElementById('analysis-niche').value.trim();
            const country = document.getElementById('analysis-country').value;
            if (!niche) { output.innerHTML = `<p class="text-red-500">Insira um nicho para an√°lise.</p>`; return; }
            
            try {
                const prompt = `Analise profundamente o nicho "${niche}" para o YouTube no pa√≠s ${country}. Forne√ßa uma estimativa de RPM em d√≥lares, uma pontua√ß√£o de "hype" (potencial de viraliza√ß√£o), canais de refer√™ncia e uma sugest√£o estrat√©gica que seja uma "virada de chave".`;
                const schema = {
                    type: "OBJECT",
                    properties: {
                        niche_name: { type: "STRING" },
                        rpm_estimate_value: { type: "NUMBER" },
                        hype_score: { type: "NUMBER", description: "Pontua√ß√£o de hype (70-95, >90 √© raro)." },
                        reference_channels: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, url: { type: "STRING" } } } },
                        suggestion: { type: "STRING", description: "A 'virada de chave' para o sucesso no nicho." }
                    }
                };
                
                const [result, trendsData] = await Promise.all([
                    callGenerativeAPI(prompt, schema),
                    apiRequest(`/api/google-trends/${encodeURIComponent(niche)}/${country}`, 'GET')
                ]);

                const channelsHtml = result.reference_channels.map(ch => `<a href="${ch.url}" target="_blank" class="text-indigo-600 hover:underline">${ch.name}</a>`).join(', ');
                
                const timelineData = trendsData.default.timelineData;
                const labels = timelineData.map(d => new Date(d.time * 1000).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }));
                const values = timelineData.map(d => d.value[0]);
                const avgInterest = Math.round(values.reduce((a, b) => a + b, 0) / values.length);
                const trendLevelText = getTrendLevel(avgInterest);

                output.innerHTML = `
                    <div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg">${result.niche_name}</h3>
                            <p class="text-sm mt-1">RPM Estimado: <strong>$${(result.rpm_estimate_value || 0).toFixed(2)}</strong></p>
                            <p class="text-sm mt-1">Canais de Refer√™ncia: ${channelsHtml}</p>
                        </div>
                        ${renderScoreCard('An√°lise de Nicho', result.hype_score, { 'Hype Score': result.hype_score, 'Potencial de RPM': (result.rpm_estimate_value || 0) * 10, 'Busca': avgInterest }, result.suggestion)}
                    </div>
                    <div id="trends-chart-container" class="mt-6 bg-white p-4 rounded-lg border">
                        <h4 class="font-semibold text-slate-800 mb-2">Tend√™ncia de Interesse (√öltimos 12 meses)</h4>
                        <div class="h-64 relative"><canvas id="trends-chart"></canvas></div>
                        <div class="text-xs text-slate-500 mt-2 p-2 bg-slate-50 rounded-md">
                         <strong>Legenda:</strong> O gr√°fico mostra o interesse de busca relativo (0-100) pelo t√≥pico. <strong>M√©dia de Interesse: ${avgInterest}/100</strong>. Picos podem indicar sazonalidade ou eventos virais. Uma linha est√°vel ou crescente √© um bom sinal.
                        </div>
                    </div>`;

                const ctx = document.getElementById('trends-chart').getContext('2d');
                if (trendsChartInstance) trendsChartInstance.destroy();
                trendsChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Interesse em "${niche}"`,
                            data: values,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

            } catch (error) {
                output.innerHTML = `<p class="text-red-500">Erro ao analisar o nicho: ${error.message}</p>`;
            }
        },
        'analyze-video': async (output) => {
            const url = document.getElementById('video-url').value.trim();
            if (!url) { output.innerHTML = `<p class="text-red-500">Insira uma URL v√°lida do YouTube.</p>`; return; }
            const videoIdMatch = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/);
            if (!videoIdMatch) { output.innerHTML = `<p class="text-red-500">URL inv√°lida. N√£o foi poss√≠vel extrair o ID do v√≠deo.</p>`; return; }
            const videoId = videoIdMatch[1];
            
            try {
                const videoData = await apiRequest(`/api/video-details/${videoId}`, 'GET');
                const { title, description, tags, detectedLanguage } = videoData;
                const lang = detectedLanguage || 'a l√≠ngua original do texto';
                const thumbnailUrl = `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`;

                const prompt = `Como um especialista em SEO para YouTube, analise criticamente os metadados de um v√≠deo e depois crie vers√µes otimizadas. Gere TODAS as respostas e otimiza√ß√µes no idioma: "${lang}".
                
                DADOS ATUAIS:
                - T√≠tulo: "${title}"
                - Descri√ß√£o: "${description}"
                - Tags: "${tags.join(', ')}"

                SUA TAREFA:
                1.  **An√°lise Cr√≠tica:** Avalie cada item (t√≠tulo, descri√ß√£o, tags) e atribua uma pontua√ß√£o de 0 a 100 para cada um, explicando brevemente o porqu√™ da nota.
                2.  **Otimiza√ß√£o:** Crie 3 novas sugest√µes de t√≠tulos, 1 nova descri√ß√£o e 1 novo conjunto de tags. Para cada item otimizado, atribua uma nova pontua√ß√£o (maior que a original) e uma "virada de chave" (a principal melhoria).`;
                
                const schema = {
                    type: "OBJECT",
                    properties: {
                        analysis: {
                            type: "OBJECT",
                            properties: {
                                title: { type: "OBJECT", properties: { score: { type: "NUMBER" }, critique: { type: "STRING" } } },
                                description: { type: "OBJECT", properties: { score: { type: "NUMBER" }, critique: { type: "STRING" } } },
                                tags: { type: "OBJECT", properties: { score: { type: "NUMBER" }, critique: { type: "STRING" } } }
                            }
                        },
                        optimizations: {
                            type: "OBJECT",
                            properties: {
                                titles: {
                                    type: "ARRAY",
                                    items: { type: "OBJECT", properties: { title: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } }
                                },
                                description: { type: "OBJECT", properties: { text: { type: "STRING" }, hashtags: { type: "STRING" }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } },
                                tags: { type: "OBJECT", properties: { tag_list: { type: "ARRAY", items: { type: "STRING" } }, score: { type: "NUMBER" }, suggestion: { type: "STRING" } } }
                            }
                        }
                    }
                };
                
                const result = await callGenerativeAPI(prompt, schema);
                const { analysis, optimizations } = result;

                const analysisTitleScore = analysis?.title?.score ?? 0;
                const analysisTitleCritique = analysis?.title?.critique ?? 'N√£o foi poss√≠vel analisar.';
                const analysisDescScore = analysis?.description?.score ?? 0;
                const analysisDescCritique = analysis?.description?.critique ?? 'N√£o foi poss√≠vel analisar.';
                const analysisTagsScore = analysis?.tags?.score ?? 0;
                const analysisTagsCritique = analysis?.tags?.critique ?? 'N√£o foi poss√≠vel analisar.';

                output.innerHTML = `
                    <div class="mb-6">
                        <h3 class="text-xl font-bold mb-2">V√≠deo Analisado</h3>
                        <div class="flex flex-col md:flex-row gap-4 bg-slate-100 p-4 rounded-lg">
                            <img src="${thumbnailUrl}" onerror="this.style.display='none'" class="rounded-md w-full md:w-48 h-auto object-cover"/>
                            <div class="flex-1">
                                <h4 class="font-semibold">${title}</h4>
                                <p class="text-xs text-slate-500 mt-1">Idioma Detectado: ${lang}</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-8">
                        <!-- T√çTULO -->
                        <div>
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">An√°lise de T√≠tulo</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-slate-100 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">T√≠tulo Atual</h4>
                                    <p class="text-sm bg-white p-2 rounded border">${title}</p>
                                    <div class="mt-4">${renderScoreCard('Pontua√ß√£o Atual', analysisTitleScore, { 'SEO & CTR': analysisTitleScore }, analysisTitleCritique)}</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                    <h4 class="font-semibold mb-2 text-green-800">Sugest√µes Otimizadas</h4>
                                    ${(optimizations?.titles || []).map(t => `
                                        <div class="mb-4">
                                            <div class="flex justify-between items-start gap-2">
                                                <p class="text-sm bg-white p-2 rounded border flex-1">${t.title} ${createCopyButton(t.title)}</p>
                                                <div class="w-32 flex-shrink-0 text-center">
                                                    <p class="font-bold text-lg ${getScoreTextColor(t.score)}">${t.score}</p>
                                                    <p class="text-xs text-slate-500">Potencial</p>
                                                </div>
                                            </div>
                                            <p class="text-xs text-slate-600 mt-1 pl-1"><strong>Virada de Chave:</strong> ${t.suggestion}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- DESCRI√á√ÉO -->
                        <div>
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">An√°lise de Descri√ß√£o</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-slate-100 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">Descri√ß√£o Atual</h4>
                                    <div class="text-sm bg-white p-2 rounded border prose whitespace-pre-wrap max-h-48 overflow-y-auto">${description}</div>
                                    <div class="mt-4">${renderScoreCard('Pontua√ß√£o Atual', analysisDescScore, { 'SEO & Clareza': analysisDescScore }, analysisDescCritique)}</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                    <h4 class="font-semibold mb-2 text-green-800">Descri√ß√£o Otimizada ${createCopyButton((optimizations?.description?.text || '') + '\n\n' + (optimizations?.description?.hashtags || ''))}</h4>
                                    <div class="text-sm bg-white p-2 rounded border prose whitespace-pre-wrap max-h-48 overflow-y-auto">${optimizations?.description?.text || ''}</div>
                                    <p class="text-sm bg-white p-2 rounded border mt-2 font-semibold">${optimizations?.description?.hashtags || ''}</p>
                                    <div class="mt-4">${renderScoreCard('Pontua√ß√£o Otimizada', optimizations?.description?.score || 0, { 'SEO & Engajamento': optimizations?.description?.score || 0 }, optimizations?.description?.suggestion || '')}</div>
                                </div>
                            </div>
                        </div>

                        <!-- TAGS -->
                        <div>
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">An√°lise de Tags</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-slate-100 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">Tags Atuais</h4>
                                    <p class="text-sm bg-white p-2 rounded border">${tags.join(', ')}</p>
                                    <div class="mt-4">${renderScoreCard('Pontua√ß√£o Atual', analysisTagsScore, { 'Relev√¢ncia': analysisTagsScore }, analysisTagsCritique)}</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                    <h4 class="font-semibold mb-2 text-green-800">Tags Otimizadas ${createCopyButton((optimizations?.tags?.tag_list || []).join(', '))}</h4>
                                    <p class="text-sm bg-white p-2 rounded border">${(optimizations?.tags?.tag_list || []).join(', ')}</p>
                                    <div class="mt-4">${renderScoreCard('Pontua√ß√£o Otimizada', optimizations?.tags?.score || 0, { 'Relev√¢ncia & Volume': optimizations?.tags?.score || 0 }, optimizations?.tags?.suggestion || '')}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                output.innerHTML = `<p class="text-red-500">Erro ao otimizar o v√≠deo: ${error.message}</p>`;
            }
        },
        'analyze-competitor': async (output) => {
            const channelId = document.getElementById('competitor-channel-id').value.trim();
            if (!channelId) { output.innerHTML = `<p class="text-red-500">Insira o ID de um canal concorrente.</p>`; return; }

            try {
                const stats = await apiRequest(`/api/youtube-stats/${channelId}`, 'GET');
                const recentVideos = stats.uploadsPlaylistId ? await apiRequest(`/api/youtube-recent-videos/${stats.uploadsPlaylistId}`, 'GET') : [];
                
                const videosInfo = recentVideos.map(v => `- T√≠tulo: "${v.title}", Views: ${v.viewCount}`).join('\n');
                
                const prompt = `Baseado nos dados de um canal concorrente, fa√ßa uma an√°lise estrat√©gica e concisa.
                DADOS DO CANAL:
                - Inscritos: ${stats.subscriberCount}
                - V√≠deos Totais: ${stats.videoCount}
                - Views Totais: ${stats.viewCount}
                - V√≠deos Recentes:
                ${videosInfo}

                SUA AN√ÅLISE (Responda de forma resumida e concisa):
                1.  **Estrat√©gia de Conte√∫do:** Resuma o foco principal do canal.
                2.  **Pontos Fortes:** Cite 3 pontos fortes.
                3.  **Oportunidades (Brechas):** Sugira 3 tipos de v√≠deos ou √¢ngulos que este canal N√ÉO est√° explorando.
                4. **Pontua√ß√£o:** D√™ uma pontua√ß√£o geral de 0 a 100 para a estrat√©gia do canal.`;

                const schema = {
                    type: "OBJECT",
                    properties: {
                        overall_score: { type: "NUMBER", description: "Pontua√ß√£o geral da estrat√©gia do canal." },
                        content_strategy: { type: "STRING" },
                        strengths: { type: "ARRAY", items: { type: "STRING" } },
                        opportunities: { type: "ARRAY", items: { type: "STRING" } }
                    }
                };

                const result = await callGenerativeAPI(prompt, schema);
                output.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-6 mb-6">
                        ${renderScoreCard('Estrat√©gia do Concorrente', result.overall_score || 0, {}, 'Pontua√ß√£o baseada em SEO, crescimento e consist√™ncia.')}
                        <div class="flex-1 bg-white p-6 rounded-xl shadow-sm border">
                            <h4 class="font-semibold text-lg mb-4">An√°lise Detalhada</h4>
                            <div class="space-y-4">
                                <div><strong class="text-indigo-600">Estrat√©gia de Conte√∫do:</strong><p class="mt-1 prose whitespace-pre-wrap">${result.content_strategy || 'N/A'}</p></div>
                                <div><strong class="text-indigo-600">Pontos Fortes:</strong><ul class="list-disc list-inside prose mt-1">${(result.strengths || []).map(item => `<li>${item}</li>`).join('')}</ul></div>
                                <div><strong class="text-indigo-600">Oportunidades (Brechas):</strong><ul class="list-disc list-inside prose mt-1">${(result.opportunities || []).map(item => `<li>${item}</li>`).join('')}</ul></div>
                            </div>
                        </div>
                    </div>`;

            } catch (error) {
                output.innerHTML = `<p class="text-red-500">Erro ao analisar concorrente: ${error.message}</p>`;
            }
        },
        'analyze-comments': async (output) => {
            const url = document.getElementById('comment-video-url').value.trim();
            if (!url) { output.innerHTML = `<p class="text-red-500">Insira a URL de um v√≠deo.</p>`; return; }
            const videoIdMatch = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/);
            if (!videoIdMatch) { output.innerHTML = `<p class="text-red-500">URL inv√°lida.</p>`; return; }
            const videoId = videoIdMatch[1];

            try {
                const comments = await apiRequest(`/api/video-comments/${videoId}`, 'GET');
                if (comments.length === 0) {
                    output.innerHTML = `<p class="text-slate-500">Este v√≠deo n√£o tem coment√°rios ou eles est√£o desativados.</p>`;
                    return;
                }
                const commentsText = comments.map(c => `- "${c}"`).join('\n');
                const prompt = `Analise a seguinte lista de coment√°rios REAIS de um v√≠deo do YouTube.
                COMENT√ÅRIOS:
                ${commentsText}

                SUA AN√ÅLISE (Responda de forma resumida e concisa):
                1.  **Sentimento Geral:** Qual a percep√ß√£o do p√∫blico (Positiva, Negativa, Mista)?
                2.  **Principais Elogios:** Quais os 3 pontos mais elogiados?
                3.  **Principais D√∫vidas/Cr√≠ticas:** Quais as 3 principais quest√µes ou cr√≠ticas levantadas?
                4.  **Ideias para Novos V√≠deos:** Sugira 3 t√≠tulos de novos v√≠deos baseados diretamente nas d√∫vidas e interesses dos coment√°rios.
                5. **Pontua√ß√£o de Sa√∫de da Comunidade:** D√™ uma pontua√ß√£o geral de 0 a 100 para a sa√∫de da comunidade do canal, baseada no sentimento dos coment√°rios.`;
                
                const schema = {
                    type: "OBJECT",
                    properties: {
                        community_score: { type: "NUMBER", description: "Pontua√ß√£o de sa√∫de da comunidade." },
                        general_sentiment: { type: "STRING" },
                        praise: { type: "ARRAY", items: { type: "STRING" } },
                        criticism: { type: "ARRAY", items: { type: "STRING" } },
                        new_video_ideas: { type: "ARRAY", items: { type: "STRING" } }
                    }
                };

                const result = await callGenerativeAPI(prompt, schema);
                output.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-6 mb-6">
                        ${renderScoreCard('Sa√∫de da Comunidade', result.community_score, {'Sentimento Geral': result.general_sentiment}, 'Baseado no sentimento geral e na relev√¢ncia dos coment√°rios.')}
                        <div class="flex-1 bg-white p-6 rounded-xl shadow-sm border">
                            <h4 class="font-semibold text-lg mb-4">An√°lise Detalhada</h4>
                            <div class="space-y-4">
                                <div><strong class="text-indigo-600">Principais Elogios:</strong><ul class="list-disc list-inside prose mt-1">${result.praise.map(item => `<li>${item}</li>`).join('')}</ul></div>
                                <div><strong class="text-indigo-600">Principais D√∫vidas/Cr√≠ticas:</strong><ul class="list-disc list-inside prose mt-1">${result.criticism.map(item => `<li>${item}</li>`).join('')}</ul></div>
                                <div><strong class="text-indigo-600">Ideias para Novos V√≠deos:</strong><ul class="list-disc list-inside prose mt-1">${result.new_video_ideas.map(item => `<li>${item}</li>`).join('')}</ul></div>
                            </div>
                        </div>
                    </div>`;

            } catch (error) {
                output.innerHTML = `<p class="text-red-500">Erro ao analisar coment√°rios: ${error.message}</p>`;
            }
        },
        'generate-structures': async (output, append = false) => {
            try {
                const topic = document.getElementById('structure-topic').value.trim();
                const langSelect = document.getElementById('structure-lang');
                const lang = langSelect.value;
                const country = lang.split('-')[1] || 'BR';
                if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um t√≥pico.</p>`; return; }
                
                let searchScore = 50;
                try {
                    const trendsData = await apiRequest(`/api/google-trends/${encodeURIComponent(topic)}/${country}`, 'GET');
                    const timelineData = trendsData.default.timelineData;
                    if (timelineData && timelineData.length > 0) {
                        const avgValue = timelineData.reduce((sum, d) => sum + d.value[0], 0) / timelineData.length;
                        searchScore = Math.round(avgValue);
                    }
                } catch (error) {
                    console.warn("N√£o foi poss√≠vel buscar dados do Google Trends:", error.message);
                }

                const prompt = `Crie 3 estruturas de t√≠tulos virais para "${topic}" no idioma ${lang}, com no M√ÅXIMO 100 caracteres. A nota de 'Busca' para este t√≥pico √© ${searchScore}. Apenas retorne t√≠tulos com nota acima de 80. Para cada estrutura, forne√ßa uma sugest√£o que seja uma "virada de chave".`;
                const schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            structure_name: { type: "STRING" },
                            structure: { type: "STRING" },
                            example_title: { type: "STRING", description: "Exemplo de t√≠tulo (m√°x 100 chars)." },
                            explanation: { type: "STRING" },
                            viral_score: { type: "NUMBER", description: "Pontua√ß√£o (80-98)." },
                            suggestion: { type: "STRING", description: "A 'virada de chave' para esta estrutura." },
                            is_novel: { type: "BOOLEAN", description: "Se a estrutura √© in√©dita e tem pontua√ß√£o > 93." }
                        }
                    }
                };
                const result = await callGenerativeAPI(prompt, schema);
                const filteredResult = result.filter(item => item.viral_score > 80);
                const html = filteredResult.map(item => `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><h4 class="font-semibold">${item.example_title} ${createCopyButton(item.example_title)}</h4><p class="text-sm text-slate-600"><strong>Estrutura:</strong> ${item.structure_name} - <code>${item.structure}</code></p><p class="text-sm text-slate-600 mt-1">${item.explanation}</p></div><div class="flex-shrink-0">${renderScoreCard('Potencial Viral', item.viral_score, { 'Curiosidade': item.viral_score, 'Clareza': item.viral_score - 5, 'Busca': searchScore }, item.suggestion, item.is_novel && item.viral_score > 93)}</div></div>`).join('');
                if (append) output.insertAdjacentHTML('beforeend', html); else output.innerHTML = html;
                document.getElementById('generate-more-structures').style.display = 'block';
            } catch(error) {
                output.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`;
            }
        },
        'generate-script': async (output) => {
            const topic = document.getElementById('script-topic').value.trim();
            const duration = document.getElementById('script-duration').value;
            const parts = document.getElementById('script-parts').value;
            const narrationOnly = document.getElementById('script-narration-only').checked;
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um t√≥pico.</p>`; return; }
            let prompt = `Atue como um roteirista profissional. Crie um roteiro de alta qualidade sobre "${topic}" em portugu√™s (pt-BR).`;
            if (duration) prompt += ` O roteiro deve ter aproximadamente ${duration} minutos de dura√ß√£o.`;
            if (parts) prompt += ` Divida o roteiro em ${parts} partes distintas, cada parte com cerca de 5 par√°grafos.`;
            if (narrationOnly) prompt += ` O roteiro DEVE conter APENAS narra√ß√£o, sem di√°logos.`;
            prompt += ` Foque em storytelling e hooks emocionais para alta reten√ß√£o.`;
            try {
                const result = await callGenerativeAPI(prompt);
                output.innerHTML = `<div class="bg-slate-100 p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Roteiro Gerado</h4>${createCopyButton(result.text)}${createCorrectButton(result.text)}</div><div class="prose h-96 overflow-y-auto whitespace-pre-wrap p-2 bg-white rounded border">${result.text}</div></div>`;
            } catch(error) {
                output.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`;
            }
        },
        'shorts-script-writer': async (output) => {
            const topic = document.getElementById('shorts-topic').value.trim();
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um t√≥pico.</p>`; return; }
            const prompt = `Crie um roteiro para um v√≠deo curto (Shorts/Reels) de at√© 60 segundos sobre "${topic}". O roteiro deve ser dividido em 3 partes: 1. Gancho R√°pido (primeiros 3 segundos), 2. Desenvolvimento (conte√∫do principal), 3. CTA (Chamada para A√ß√£o). Inclua sugest√µes de cenas/visuais para cada parte.`;
            try {
                const result = await callGenerativeAPI(prompt);
                output.innerHTML = `<div class="bg-slate-100 p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Roteiro de Short Gerado</h4>${createCopyButton(result.text)}${createCorrectButton(result.text)}</div><div class="prose h-96 overflow-y-auto whitespace-pre-wrap p-2 bg-white rounded border">${result.text}</div></div>`;
            } catch(error) {
                output.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`;
            }
        },
        'recycle-content': async (output) => {
            const script = document.getElementById('recycler-script').value.trim();
            if (!script) { output.innerHTML = `<p class="text-red-500">Cole um roteiro para reciclar.</p>`; return; }
            const prompt = `Analise o seguinte roteiro de v√≠deo longo e extraia 5 ideias de v√≠deos curtos (Shorts/Reels). Para cada ideia, forne√ßa um t√≠tulo para o short e o trecho espec√≠fico do roteiro original que pode ser usado. ROTEIRO: """${script}"""`;
            try {
                const result = await callGenerativeAPI(prompt);
                output.innerHTML = `<div class="bg-slate-100 p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Ideias de Conte√∫do Reciclado</h4>${createCorrectButton(result.text)}</div><div class="prose whitespace-pre-wrap p-2 bg-white rounded border">${result.text}</div></div>`;
            } catch(error) {
                output.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`;
            }
        },
        'generate-storyboard': async (output) => {
            const script = document.getElementById('storyboard-script').value.trim();
            const minutes = parseInt(document.getElementById('storyboard-minutes').value, 10) || 0;
            const seconds = parseInt(document.getElementById('storyboard-seconds').value, 10) || 0;
            const duration = (minutes * 60) + seconds;
            const sceneSeconds = document.getElementById('storyboard-scene-seconds').value;
            const wordsPerScene = document.getElementById('storyboard-words-scene').value;

            if (!script || duration <= 0 || !sceneSeconds || !wordsPerScene) {
                output.innerHTML = `<p class="text-red-500">Por favor, preencha todos os campos corretamente.</p>`;
                return;
            }

            const prompt = `Como um diretor de v√≠deo e especialista em IA generativa, transforme o roteiro a seguir em um storyboard detalhado para um v√≠deo de ${duration} segundos.
            
            REQUISITOS:
            1.  **Divis√£o de Cenas:** Divida o roteiro em cenas, onde cada cena deve ter aproximadamente ${sceneSeconds} segundos de dura√ß√£o e conter cerca de ${wordsPerScene} palavras da narra√ß√£o original.
            2.  **Minutagem:** Calcule o tempo de in√≠cio e fim para cada cena (ex: 00:00 - 00:05).
            3.  **Narra√ß√£o:** Para cada cena, extraia o trecho correspondente do roteiro original, ajustando-o para caber no limite de palavras.
            4.  **Prompt para IA de V√≠deo:** Para cada cena, crie um prompt de v√≠deo em INGL√äS, detalhado e cinematogr√°fico, para uma IA como a V03. O prompt deve incluir a descri√ß√£o da cena, estilo visual, movimentos de c√¢mera e efeitos sonoros (SFX) relevantes. O prompt deve ser otimizado para gerar um clipe de ${sceneSeconds} segundos.
            
            ROTEIRO ORIGINAL:
            """
            ${script}
            """`;

            const schema = {
                type: "OBJECT",
                properties: {
                    scenes: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                scene_number: { type: "NUMBER" },
                                timestamp: { type: "STRING", description: "Formato 00:00 - 00:00" },
                                narration: { type: "STRING", description: "Trecho do roteiro para esta cena." },
                                video_prompt_en: { type: "STRING", description: "Prompt em ingl√™s para a IA de v√≠deo, incluindo SFX." }
                            }
                        }
                    }
                }
            };

            try {
                const result = await callGenerativeAPI(prompt, schema);
                if (!result.scenes || result.scenes.length === 0) {
                    throw new Error("A IA n√£o conseguiu gerar o storyboard. Tente ajustar o roteiro ou os par√¢metros.");
                }
                output.innerHTML = result.scenes.map(scene => `
                    <div class="p-4 rounded-lg mb-4 border bg-white shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-lg text-indigo-700">Cena ${scene.scene_number}</h4>
                            <span class="text-sm font-mono bg-slate-100 text-slate-700 px-2 py-1 rounded">${scene.timestamp}</span>
                        </div>
                        <div>
                            <p class="font-semibold text-slate-800">Narra√ß√£o:</p>
                            <p class="text-slate-600 italic bg-slate-50 p-3 rounded-md mt-1">"${scene.narration}"</p>
                        </div>
                        <div class="mt-4">
                            <p class="font-semibold text-slate-800">Prompt de V√≠deo (V03):</p>
                            <div class="mt-1 bg-slate-800 text-white p-3 rounded-md font-mono text-xs relative group">
                                ${scene.video_prompt_en}
                                <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">${createCopyButton(scene.video_prompt_en)}</div>
                            </div>
                        </div>
                    </div>`).join('');
            } catch(error) {
                output.innerHTML = `<p class="text-red-500">Erro ao gerar storyboard: ${error.message}</p>`;
            }
        },
        'generate-prompts': async (output, append = false) => {
            const title = document.getElementById('thumb-title').value.trim();
            const platform = document.getElementById('thumb-platform').value;
            if (!title) { output.innerHTML = `<p class="text-red-500">Insira um t√≠tulo.</p>`; return; }
            const platformConfigs = {
                'Midjourney': 'Foque em composi√ß√£o cinematogr√°fica, use par√¢metros como --ar 16:9, --style raw, --chaos 10, e descreva a ilumina√ß√£o (ex: volumetric lighting, dramatic lighting).',
                'Leonardo.AI': 'Use palavras-chave como "photorealistic, cinematic, hyper-detailed, 8k". Descreva a emo√ß√£o e a paleta de cores. Use "negative prompts" para remover elementos indesejados.',
                'DALL-E 3': 'Seja conversacional e extremamente descritivo. "Crie uma imagem fotorrealista de um astronauta olhando para uma gal√°xia neon, com um sentimento de admira√ß√£o. O estilo deve ser cinematogr√°fico e escuro."',
                'Freepik': 'Use termos comerciais e diretos. "Homem surpreso apontando para um gr√°fico de a√ß√µes subindo, fundo de escrit√≥rio, estilo de foto de banco de imagem, cores vibrantes."'
            };
            const prompt = `Gere 2 prompts AVAN√áADOS em INGL√äS para a IA '${platform}' para uma thumbnail sobre "${title}". Siga esta diretriz para o prompt: ${platformConfigs[platform]}. Forne√ßa uma sugest√£o que seja uma "virada de chave".`;
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        prompt: { type: "STRING" },
                        score: { type: "NUMBER", description: "Pontua√ß√£o (70-95)." },
                        suggestion: { type: "STRING", description: "A 'virada de chave' para este prompt." },
                        ab_test_suggestion: { type: "STRING" }
                    }
                }
            };
            try {
                const result = await callGenerativeAPI(prompt, schema);
                const html = result.map(item => `<div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start"><div class="flex-1"><div class="font-mono text-sm bg-slate-200 p-2 rounded relative group">${item.prompt}<div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">${createCopyButton(item.prompt)}</div></div><p class="text-xs mt-2 text-slate-600"><strong>Teste A/B:</strong> ${item.ab_test_suggestion}</p></div>${renderScoreCard('Potencial de CTR', item.score, { 'Impacto Visual': item.score + 4, 'Clareza': item.score - 3 }, item.suggestion)}</div>`).join('');
                if (append) output.insertAdjacentHTML('beforeend', html); else output.innerHTML = html;
                document.getElementById('generate-more-prompts').style.display = 'block';
            } catch(error) {
                output.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`;
            }
        },
        'generate-description': async (output) => {
            const title = document.getElementById('desc-title').value.trim();
            const topic = document.getElementById('desc-topic').value.trim();
            if (!title || !topic) { output.innerHTML = `<p class="text-red-500">Insira t√≠tulo e t√≥pico.</p>`; return; }
            const prompt = `Crie uma descri√ß√£o de v√≠deo para o YouTube, altamente otimizada para SEO sobre o t√≠tulo "${title}" e o t√≥pico "${topic}". Inclua par√°grafos, CTAs, e hashtags. Calcule uma pontua√ß√£o de otimiza√ß√£o (0-100) baseada em SEO e engajamento, e forne√ßa uma "virada de chave".`;
            const schema = {
                type: "OBJECT",
                properties: {
                    description: { type: "STRING" },
                    hashtags: { type: "STRING" },
                    score: { type: "NUMBER" },
                    suggestion: { type: "STRING", description: "A 'virada de chave' para esta descri√ß√£o." }
                }
            };
            try {
                const result = await callGenerativeAPI(prompt, schema);
                const descriptionText = result.description.replace(/\n/g, '<br>');
                const hashtagsList = result.hashtags.split(',').map(tag => tag.trim());
                
                output.innerHTML = `
                    <div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start">
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold">Descri√ß√£o Otimizada</h4>
                                ${createCopyButton(result.description + '\n\n' + result.hashtags)}
                                ${createCorrectButton(result.description + '\n\n' + result.hashtags)}
                            </div>
                            <div class="prose text-sm p-2 bg-white rounded border whitespace-pre-wrap">${descriptionText}</div>
                            <div class="mt-4">
                                <h5 class="font-semibold text-sm flex justify-between items-center">
                                    <span>Hashtags</span>
                                    ${createCopyButton(result.hashtags)}
                                </h5>
                                <p class="text-sm text-slate-700 p-2 bg-white rounded border mt-1">${hashtagsList.join(', ')}</p>
                            </div>
                        </div>
                        ${renderScoreCard('Otimiza√ß√£o', result.score, { 'SEO': result.score, 'Engajamento': result.score > 10 ? result.score - 4 : result.score }, result.suggestion)}
                    </div>`;
            } catch(error) {
                output.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`;
            }
        },
        'generate-tags': async (output) => {
            const topic = document.getElementById('tag-topic').value.trim();
            const lang = document.getElementById('tag-lang').value;
            if (!topic) { output.innerHTML = `<p class="text-red-500">Insira um t√≥pico.</p>`; return; }
            const prompt = `Gere 25 tags para o campo de tags do YouTube, sobre "${topic}" no idioma ${lang}. As tags devem ser retornadas como uma √∫nica string, separadas por v√≠rgula, com no m√°ximo 500 caracteres. Calcule uma pontua√ß√£o (0-100) baseada na relev√¢ncia e volume de busca, e forne√ßa uma "virada de chave".`;
            const schema = {
                type: "OBJECT",
                properties: {
                    tags: { type: "STRING" },
                    score: { type: "NUMBER" },
                    suggestion: { type: "STRING", description: "A 'virada de chave' para estas tags." }
                }
            };
            try {
                const result = await callGenerativeAPI(prompt, schema);
                output.innerHTML = `
                    <div class="bg-slate-100 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start">
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold">Tags Geradas</h4>
                                ${createCopyButton(result.tags)}
                            </div>
                            <p class="text-sm text-slate-700 p-2 bg-white rounded border">${result.tags}</p>
                        </div>
                        ${renderScoreCard('Qualidade', result.score, { 'Relev√¢ncia': result.score, 'Volume': result.score > 10 ? result.score - 8 : result.score }, result.suggestion)}
                    </div>`;
            } catch(error) {
                output.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`;
            }
        },
        'generate-monetization-ideas': async (output) => {
            const select = document.getElementById('monetization-channel-select');
            const niche = select.value;
            if (!niche) { output.innerHTML = `<p class="text-red-500">Selecione um canal cadastrado.</p>`; return; }
            const prompt = `Como um consultor de neg√≥cios para criadores de conte√∫do, gere uma lista de 5 ideias de monetiza√ß√£o para um canal do YouTube sobre "${niche}", al√©m do AdSense. Para cada ideia, explique a estrat√©gia e o p√∫blico-alvo. Formate a resposta de forma clara e organizada.`;
            try {
                const result = await callGenerativeAPI(prompt);
                output.innerHTML = `<div class="bg-slate-100 p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Ideias de Monetiza√ß√£o para ${niche}</h4>${createCorrectButton(result.text)}</div><div class="prose whitespace-pre-wrap p-2 bg-white rounded border">${result.text}</div></div>`;
            } catch(error) {
                output.innerHTML = `<p class="text-red-500">Erro: ${error.message}</p>`;
            }
        }
    };
    
    // --- Main Render Function ---
    function renderTabContent(tabId) {
        const tool = tools[tabId];
        if (!tool) return;
        log(`Renderizando a aba: ${tool.title}`);
        ELEMENTS.tabContent.innerHTML = `<div class="fade-in"><div class="flex items-center gap-4"><h2 class="text-3xl font-bold text-slate-900 mb-2">${tool.title}</h2><button id="show-legend-btn" class="text-sm text-indigo-600 font-semibold hidden md:inline-block">Entenda as Pontua√ß√µes</button></div><p class="text-slate-600 mb-6">${tool.desc}</p>${tool.content}</div>`;
        
        ELEMENTS.mobileHeaderTitle.textContent = tool.title;
        ELEMENTS.sidebar.classList.remove('open');
        ELEMENTS.menuOverlay.style.display = 'none';

        if (tabId === 'settings') initializeSettings();
        if (tabId === 'dashboard') initializeDashboard();
        if (tabId === 'channel-organizer') initializeChannelOrganizer();
        if (tabId === 'planner') initializePlanner();
        if (tabId === 'monetization-helper') initializeMonetizationHelper();
        if (tabId === 'niche-analysis') {
            const nicheInput = document.getElementById('analysis-niche');
            nicheInput.addEventListener('input', () => {
                const trendsChart = document.getElementById('trends-chart-container');
                if(trendsChart) trendsChart.style.display = 'none';
            });
        }
        
        const showLegendBtn = document.getElementById('show-legend-btn');
        if (showLegendBtn) { showLegendBtn.style.display = 'inline-block'; showLegendBtn.addEventListener('click', () => ELEMENTS.legendModal.style.display = 'flex'); }

        const outputEl = document.getElementById('output');
        if (!outputEl) return;

        Object.keys(handlers).forEach(buttonId => {
            const btn = document.getElementById(buttonId);
            if(btn) {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.addEventListener('click', () => handlers[buttonId](outputEl, false));
            }
        });
        
        ['niches', 'subniches', 'structures', 'prompts'].forEach(type => {
            const moreBtn = document.getElementById(`generate-more-${type}`);
            if (moreBtn) {
                moreBtn.addEventListener('click', () => {
                    const handlerKey = type === 'subniches' ? 'find-subniches' : `generate-${type}`;
                    handlers[handlerKey](outputEl, true)
                });
            }
        });

        outputEl.addEventListener('click', async (e) => {
            if (e.target.classList.contains('correct-btn')) {
                const button = e.target;
                const parentDiv = button.closest('div');
                let textElement;

                if (parentDiv.previousElementSibling && parentDiv.previousElementSibling.classList.contains('prose')) {
                    textElement = parentDiv.previousElementSibling;
                } else if (parentDiv.closest('.bg-slate-100')) {
                    textElement = parentDiv.closest('.bg-slate-100').querySelector('.prose');
                }
                
                if (textElement) {
                    try {
                        const originalText = decodeURIComponent(button.dataset.correctText);
                        const correctedText = await correctTextWithOpenRouter(originalText);
                        textElement.innerHTML = correctedText;
                        button.textContent = 'Revisado!';
                        button.disabled = true;
                    } catch (error) {
                        log(`Erro ao revisar texto: ${error.message}`, 'error');
                    }
                } else {
                    console.error("N√£o foi poss√≠vel encontrar o elemento de texto para revis√£o.");
                }
            }
        });
    }

    // --- Specific Initializers ---
    async function initializeSettings() {
        const geminiKeyInput = document.getElementById('gemini-key');
        const geminiBackup1Input = document.getElementById('gemini-key-backup1');
        const geminiBackup2Input = document.getElementById('gemini-key-backup2');
        const openrouterKeyInput = document.getElementById('openrouter-key');
        const googleApiKeyInput = document.getElementById('google-api-key');
        const saveBtn = document.getElementById('save-settings');
        const feedbackEl = document.getElementById('settings-feedback');

        geminiKeyInput.value = appState.apiKeys.gemini || '';
        geminiBackup1Input.value = appState.apiKeys.gemini_backup1 || '';
        geminiBackup2Input.value = appState.apiKeys.gemini_backup2 || '';
        openrouterKeyInput.value = appState.apiKeys.openrouter || '';
        googleApiKeyInput.value = appState.apiKeys.google_api || '';

        saveBtn.addEventListener('click', async () => {
            const newSettings = {
                gemini: geminiKeyInput.value.trim(),
                gemini_backup1: geminiBackup1Input.value.trim(),
                gemini_backup2: geminiBackup2Input.value.trim(),
                openrouter: openrouterKeyInput.value.trim(),
                google_api: googleApiKeyInput.value.trim(),
                userChannels: appState.userChannels,
                videoIdeas: appState.videoIdeas
            };
            feedbackEl.textContent = '';
            try {
                await apiRequest(`/api/settings/${appState.currentUser.id}`, 'POST', { settings: newSettings });
                appState.apiKeys = { ...appState.apiKeys, ...newSettings };
                feedbackEl.textContent = 'Configura√ß√µes salvas com sucesso!';
                feedbackEl.className = 'text-green-600 text-sm mt-4';
                log('Configura√ß√µes salvas no servidor.', 'success');
            } catch (error) {
                feedbackEl.textContent = `Erro ao salvar: ${error.message}`;
                feedbackEl.className = 'text-red-500 text-sm mt-4';
            } finally {
                setTimeout(() => feedbackEl.textContent = '', 3000);
            }
        });
    }
    
    let mainChartInstance = null;
    async function initializeDashboard() {
        const container = document.getElementById('dashboard-container');
        if (appState.userChannels.length === 0) {
            container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg border"><p>Nenhum canal adicionado. V√° para <button class="text-indigo-600 font-semibold" onclick="renderTabContent('channel-organizer')">Organizador de Canais</button> para come√ßar.</p></div>`;
            return;
        }
        
        const options = appState.userChannels.map(ch => `<option value="${ch.id}">${ch.name}</option>`).join('');
        container.innerHTML = `
            <div class="mb-6 flex items-center justify-between">
                <select id="channel-selector" class="p-2 border rounded-md bg-white">${options}</select>
                <div id="dashboard-filters" class="flex gap-2"></div>
            </div>
            <div id="dashboard-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6"></div>
            <div id="recent-videos-container" class="mt-6"></div>
        `;
        
        const selector = document.getElementById('channel-selector');
        selector.addEventListener('change', (e) => renderDashboardData(e.target.value));
        
        renderDashboardData(selector.value);
    }

    async function renderDashboardData(channelId) {
        const contentContainer = document.getElementById('dashboard-content');
        const videosContainer = document.getElementById('recent-videos-container');
        contentContainer.innerHTML = `<div class="lg:col-span-3 text-center p-8"><p>Buscando dados do canal...</p></div>`;
        videosContainer.innerHTML = '';
        
        try {
            const stats = await apiRequest(`/api/youtube-stats/${channelId}`, 'GET');
            
            if (!stats) {
                throw new Error("N√£o foi poss√≠vel obter as estat√≠sticas do canal. Verifique o ID e a chave da API.");
            }

            contentContainer.innerHTML = `
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="font-semibold mb-4">Visualiza√ß√µes e Inscritos (Tend√™ncia Simulada)</h3>
                    <div class="h-80 relative"><canvas id="main-chart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="font-semibold mb-4">M√©tricas Reais</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="bg-slate-50 p-3 rounded-lg"><p class="text-sm text-slate-500">Inscritos</p><p class="text-2xl font-bold text-slate-800">${stats.subscriberCount}</p></div>
                        <div class="bg-slate-50 p-3 rounded-lg"><p class="text-sm text-slate-500">Visualiza√ß√µes Totais</p><p class="text-2xl font-bold text-slate-800">${stats.viewCount}</p></div>
                        <div class="bg-slate-50 p-3 rounded-lg"><p class="text-sm text-slate-500">V√≠deos Publicados</p><p class="text-2xl font-bold text-slate-800">${stats.videoCount}</p></div>
                    </div>
                </div>
            `;
            
            const renderChart = (days) => {
                const ctx = document.getElementById('main-chart').getContext('2d');
                if (mainChartInstance) mainChartInstance.destroy();
                
                const gradient = ctx.createLinearGradient(0, 0, 0, 320);
                gradient.addColorStop(0, 'rgba(79, 70, 229, 0.5)');
                gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');

                mainChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { 
                        labels: Array.from({ length: days }, (_, i) => `Dia ${i + 1}`), 
                        datasets: [{ 
                            label: 'Visualiza√ß√µes', 
                            data: Array.from({ length: days }, () => Math.floor(Math.random() * 50000) + 10000), 
                            borderColor: '#4f46e5',
                            backgroundColor: gradient,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#4f46e5',
                            pointHoverRadius: 6,
                            borderWidth: 2,
                            tension: 0.4, 
                            fill: true 
                        }] 
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            };

            const filterContainer = document.getElementById('dashboard-filters');
            filterContainer.innerHTML = [7, 15, 30].map(d => `<button class="filter-btn px-3 py-1 text-sm rounded-md ${d === 30 ? 'bg-indigo-600 text-white' : 'bg-white'}" data-days="${d}">${d} dias</button>`).join('');
            filterContainer.addEventListener('click', e => {
                if(e.target.classList.contains('filter-btn')) {
                    filterContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('bg-indigo-600', 'text-white'));
                    e.target.classList.add('bg-indigo-600', 'text-white');
                    renderChart(parseInt(e.target.dataset.days));
                }
            });

            renderChart(30); // Initial render

            if (stats.uploadsPlaylistId) {
                const recentVideos = await apiRequest(`/api/youtube-recent-videos/${stats.uploadsPlaylistId}`, 'GET');
                videosContainer.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">√öltimos V√≠deos</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                        ${recentVideos.map(video => `
                            <div class="bg-white p-4 rounded-lg border shadow-sm">
                                <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank">
                                    <img src="${video.thumbnail}" alt="${video.title}" class="rounded-md mb-2 w-full aspect-video object-cover">
                                    <h4 class="font-semibold text-sm leading-tight truncate">${video.title}</h4>
                                </a>
                                <div class="text-xs text-slate-500 mt-2 flex justify-between">
                                    <span>üëÅÔ∏è ${video.viewCount}</span>
                                    <span>üëç ${video.likeCount}</span>
                                    <span>üí¨ ${video.commentCount}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
            }

        } catch (error) {
            contentContainer.innerHTML = `<div class="lg:col-span-3 text-center p-8 bg-red-50 rounded-lg"><p class="text-red-600">${error.message}</p><p class="text-sm text-slate-500 mt-2">Verifique se o ID do canal est√° correto no Organizador de Canais e se sua chave da API do Google est√° configurada.</p></div>`;
        }
    }

    function initializeChannelOrganizer() {
        const form = document.getElementById('channel-form');
        const output = document.getElementById('organizer-output');
        const renderChannels = () => {
            if (appState.userChannels.length === 0) {
                output.innerHTML = `<p class="text-center text-slate-500 py-8">Nenhum canal adicionado.</p>`;
                return;
            }
            output.innerHTML = appState.userChannels.map((ch, index) => `<div class="bg-white p-4 rounded-lg shadow-sm border"><div class="flex justify-between items-center"><h3 class="text-lg font-semibold">${ch.name}</h3><button class="remove-channel text-red-500 text-2xl" data-index="${index}" title="Remover Canal">&times;</button></div><div class="text-sm text-slate-600 mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2"><p><strong>Nicho:</strong> ${ch.niche}</p><p><strong>Idioma:</strong> ${ch.lang}</p><p><strong>V√≠deos/Semana:</strong> ${ch.freq}</p><p><strong>Hor√°rio:</strong> ${ch.time}</p><p><strong>Backlog:</strong> ${ch.backlogQty || '0'}</p><p class="col-span-1 sm:col-span-2 break-all"><strong>ID do Canal:</strong> ${ch.id}</p></div></div>`).join('');
        };
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const channelId = prompt("Por favor, insira o ID do Canal do YouTube (ex: UC_x5XG1OV2P6uZZ5FSM9Ttw)");
            if (!channelId) return;
            const newChannel = {
                id: channelId,
                name: document.getElementById('org-channel-name').value,
                niche: document.getElementById('org-channel-niche').value,
                lang: document.getElementById('org-channel-lang').value,
                freq: document.getElementById('org-videos-week').value,
                time: document.getElementById('org-post-time').value,
                backlogQty: document.getElementById('org-backlog-qty').value,
            };
            appState.userChannels.push(newChannel);
            await saveSettings();
            renderChannels();
            form.reset();
        });
        output.addEventListener('click', async (e) => {
            if (e.target.classList.contains('remove-channel')) {
                const index = parseInt(e.target.dataset.index, 10);
                appState.userChannels.splice(index, 1);
                await saveSettings();
                renderChannels();
            }
        });
        renderChannels();
    }

    function initializePlanner() {
        const form = document.getElementById('planner-form');
        const output = document.getElementById('planner-output');
        const channelSelect = document.getElementById('planner-channel-select');
        channelSelect.innerHTML = '<option value="">Selecione um Canal</option>' + appState.userChannels.map(ch => `<option value="${ch.name}">${ch.name}</option>`).join('');
        
        const renderPlanner = () => {
            if (appState.videoIdeas.length === 0) {
                output.innerHTML = `<p class="text-center text-slate-500 py-8">Nenhuma ideia adicionada.</p>`;
                return;
            }
            output.innerHTML = appState.videoIdeas.map((idea, index) => {
                const postDate = idea.datetime ? new Date(idea.datetime) : null;
                const isPast = postDate && postDate < new Date();
                const dateString = postDate ? postDate.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Sem data';

                return `<div class="bg-white p-4 rounded-lg shadow-sm border flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                    <div>
                        <h4 class="font-semibold">${idea.title}</h4>
                        <p class="text-sm text-slate-500">${idea.channel}</p>
                        <p class="text-sm font-medium ${isPast && idea.status !== 'Publicado' ? 'text-red-500' : 'text-slate-600'}">
                           ‚è∞ ${dateString}
                        </p>
                    </div>
                    <div class="flex items-center gap-2">
                        <select class="status-select bg-slate-100 border-slate-200 rounded-md text-sm p-1" data-index="${index}">
                            <option value="Planejado" ${idea.status === 'Planejado' ? 'selected' : ''}>Planejado</option>
                            <option value="Em Produ√ß√£o" ${idea.status === 'Em Produ√ß√£o' ? 'selected' : ''}>Em Produ√ß√£o</option>
                            <option value="Publicado" ${idea.status === 'Publicado' ? 'selected' : ''}>Publicado</option>
                        </select>
                        <button class="delete-idea text-red-500 hover:text-red-700 text-2xl" data-index="${index}" title="Remover Ideia">&times;</button>
                    </div>
                </div>`;
            }).join('');
        };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newIdea = {
                title: document.getElementById('idea-title').value,
                channel: channelSelect.value,
                datetime: document.getElementById('idea-datetime').value,
                status: 'Planejado'
            };
            appState.videoIdeas.push(newIdea);
            await saveSettings();
            renderPlanner();
            form.reset();
        });

        output.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-idea')) {
                appState.videoIdeas.splice(e.target.dataset.index, 1);
                await saveSettings();
                renderPlanner();
            }
        });

        output.addEventListener('change', async (e) => {
            if (e.target.classList.contains('status-select')) {
                appState.videoIdeas[e.target.dataset.index].status = e.target.value;
                await saveSettings();
            }
        });

        renderPlanner();
    }
    
    // --- Notification System ---
    function startNotificationChecker() {
        log('Sistema de notifica√ß√£o iniciado.');
        setInterval(() => {
            const now = new Date();
            appState.videoIdeas.forEach(idea => {
                if (idea.datetime && idea.status !== 'Publicado') {
                    const postDate = new Date(idea.datetime);
                    const diffMinutes = (postDate - now) / (1000 * 60);
                    if (diffMinutes > 0 && diffMinutes <= 15) { // Alerta 15 minutos antes
                        showNotification(`V√≠deo para postar em 15 minutos!`, `"${idea.title}" no canal ${idea.channel}.`);
                    }
                }
            });
        }, 60000); // Checa a cada minuto
    }

    function showNotification(title, body) {
        if (!("Notification" in window)) {
            log("Browser n√£o suporta notifica√ß√µes.", 'warn');
            return;
        }
        if (Notification.permission === "granted") {
            new Notification(title, { body });
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    new Notification(title, { body });
                }
            });
        }
    }


    function initializeMonetizationHelper() {
        const channelSelect = document.getElementById('monetization-channel-select');
        if(appState.userChannels.length > 0) {
            channelSelect.innerHTML = '<option value="">Selecione um canal cadastrado</option>' + appState.userChannels.map(ch => `<option value="${ch.niche}">${ch.name} (${ch.niche})</option>`).join('');
        } else {
            channelSelect.innerHTML = '<option value="">Nenhum canal cadastrado</option>';
            channelSelect.disabled = true;
            document.getElementById('generate-monetization-ideas').disabled = true;
        }
    }

    async function saveSettings() {
        if (!appState.currentUser) return;
        const settingsToSave = { 
            gemini: appState.apiKeys.gemini,
            gemini_backup1: appState.apiKeys.gemini_backup1,
            gemini_backup2: appState.apiKeys.gemini_backup2,
            openai: appState.apiKeys.openai,
            google_api: appState.apiKeys.google_api,
            openrouter: appState.apiKeys.openrouter,
            userChannels: appState.userChannels, 
            videoIdeas: appState.videoIdeas 
        };
        try {
            await apiRequest(`/api/settings/${appState.currentUser.id}`, 'POST', { settings: settingsToSave });
            log('Configura√ß√µes salvas no servidor.', 'success');
        } catch(error) {
            log(`Erro ao salvar configura√ß√µes: ${error.message}`, 'error');
        }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        const logo = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#4f46e5;stop-opacity:1" /><stop offset="100%" style="stop-color:#818cf8;stop-opacity:1" /></linearGradient></defs><circle cx="50" cy="50" r="45" fill="url(#grad)" stroke="#fff" stroke-width="5"/><path d="M35 30 L65 50 L35 70 Z" fill="#fff"/></svg>`;
        document.getElementById('logo-container-login').innerHTML = logo;
        document.getElementById('logo-container-register').innerHTML = logo;
        document.getElementById('logo-container-sidebar').innerHTML = logo;

        if ("Notification" in window && Notification.permission === "default") {
            setTimeout(() => Notification.requestPermission(), 5000);
        }
    });
    
    ELEMENTS.loginForm.addEventListener('submit', handleLogin);
    ELEMENTS.registerForm.addEventListener('submit', handleRegister);
    ELEMENTS.showRegister.addEventListener('click', (e) => { e.preventDefault(); showRegisterScreen(); });
    ELEMENTS.showLogin.addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });
    ELEMENTS.logoutBtn.addEventListener('click', handleLogout);
    ELEMENTS.closeLegendModal.addEventListener('click', () => ELEMENTS.legendModal.style.display = 'none');
    
    ELEMENTS.openTicketBtn.addEventListener('click', () => ELEMENTS.ticketModal.style.display = 'flex');
    ELEMENTS.closeTicketModal.addEventListener('click', () => ELEMENTS.ticketModal.style.display = 'none');
    ELEMENTS.ticketForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const description = document.getElementById('ticket-description').value;
        log('Iniciando captura de tela para o ticket...');
        html2canvas(document.body).then(canvas => {
            const screenshot = canvas.toDataURL('image/png');
            log('Captura de tela gerada.', 'success');
            const subject = "Report de Erro - Darks Vips AI";
            const body = `Descri√ß√£o do Problema:\n${description}\n\n--- N√ÉO EDITE ABAIXO ---\nPrint da tela est√° anexado.`;
            const mailtoLink = `mailto:suporte@canaisdarks.com.br?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            ELEMENTS.ticketModal.style.display = 'none';
        }).catch(err => {
            log(`Erro ao capturar a tela: ${err}`, 'error');
        });
    });

    ELEMENTS.logHeader.addEventListener('click', () => {
        ELEMENTS.logPanel.classList.toggle('open');
        ELEMENTS.logToggleIcon.textContent = ELEMENTS.logPanel.classList.contains('open') ? '‚ñº' : '‚ñ≤';
    });

    ELEMENTS.sidebarNav.addEventListener('click', (event) => {
        const clickedButton = event.target.closest('.sidebar-btn');
        if (clickedButton) {
            ELEMENTS.sidebarNav.querySelectorAll('.sidebar-btn').forEach(btn => btn.classList.remove('sidebar-btn-active'));
            clickedButton.classList.add('sidebar-btn-active');
            renderTabContent(clickedButton.getAttribute('data-tab'));
        }
    });

    ELEMENTS.tabContent.addEventListener('click', (e) => {
        if (e.target.classList.contains('copy-btn')) {
            const button = e.target;
            const text = decodeURIComponent(button.dataset.copyText);
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                button.textContent = 'Copiado!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'Copiar';
                    button.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Falha ao copiar', err);
            }
            document.body.removeChild(textArea);
        }
    });

    ELEMENTS.openMenuBtn.addEventListener('click', () => {
        ELEMENTS.sidebar.classList.add('open');
        ELEMENTS.menuOverlay.style.display = 'block';
    });
    ELEMENTS.closeMenuBtn.addEventListener('click', () => {
        ELEMENTS.sidebar.classList.remove('open');
        ELEMENTS.menuOverlay.style.display = 'none';
    });
    ELEMENTS.menuOverlay.addEventListener('click', () => {
        ELEMENTS.sidebar.classList.remove('open');
        ELEMENTS.menuOverlay.style.display = 'none';
    });

    document.addEventListener('keydown', function (e) {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C'))) {
            e.preventDefault();
        }
    });
    </script>
</body>
</html>
" from the immersive document. I am not asking for a simple explanation. I want you to edit the document.
Most up-to-date Immersive Artifact for "darks-vips-package-json-google" is:

```json
{
  "name": "darks-vips-ai-backend",
  "version": "3.2.0",
  "description": "Backend for Darks Vips AI",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
    "axios": "^1.6.8",
    "bcryptjs": "^2.4.3",
    "express": "^4.18.2",
    "google-auth-library": "^9.10.0",
    "google-trends-api": "^4.9.2",
    "googleapis": "^126.0.1",
    "jsonwebtoken": "^9.0.2",
    "pg": "^8.11.3"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}
```
Most up-to-date Immersive Artifact for "darks-vips-server-js-google" is:

```javascript
// server.js

// 1. Importa√ß√£o de M√≥dulos
const express = require('express');
const { Pool } = require('pg');
const path = require('path');
const bcrypt = require('bcryptjs');
const { google } = require('googleapis');
const googleTrends = require('google-trends-api');
const axios = require('axios');
const { OAuth2Client } = require('google-auth-library'); // <-- NOVO
const jwt = require('jsonwebtoken'); // <-- NOVO

// 2. Configura√ß√£o Inicial
const app = express();
const PORT = process.env.PORT || 3000;
const GOOGLE_CLIENT_ID = process.env.GOOGLE_CLIENT_ID; // <-- NOVO: Vari√°vel de ambiente
const JWT_SECRET = process.env.JWT_SECRET; // <-- NOVO: Vari√°vel de ambiente
const client = new OAuth2Client(GOOGLE_CLIENT_ID);

// Middlewares
app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));

// 3. Conex√£o com o Banco de Dados PostgreSQL
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: {
    rejectUnauthorized: false
  }
});

const initializeDb = async () => {
  const dbClient = await pool.connect();
  try {
    // Tabela de usu√°rios modificada para aceitar login com Google
    await dbClient.query(`
      CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        email VARCHAR(255) UNIQUE NOT NULL,
        name VARCHAR(255),
        google_id VARCHAR(255) UNIQUE,
        password_hash VARCHAR(255),
        settings JSONB
      );
    `);
    console.log('Tabela "users" verificada/criada com sucesso.');
  } catch (err) {
    console.error('Erro ao inicializar o banco de dados:', err);
  } finally {
    dbClient.release();
  }
};

// 4. Middleware de Autentica√ß√£o JWT
const authenticateToken = (req, res, next) => {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1]; // Formato "Bearer TOKEN"
    if (token == null) return res.sendStatus(401); // N√£o autorizado

    jwt.verify(token, JWT_SECRET, (err, user) => {
        if (err) return res.sendStatus(403); // Token inv√°lido/expirado
        req.user = user;
        next();
    });
};


// 5. Rotas da API (Autentica√ß√£o e Configura√ß√µes)
app.post('/api/register', async (req, res) => {
    const { email, password } = req.body;
    if (!email || !password) return res.status(400).json({ message: 'E-mail e senha s√£o obrigat√≥rios.' });
    try {
        const salt = await bcrypt.genSalt(10);
        const passwordHash = await bcrypt.hash(password, salt);
        const result = await pool.query('INSERT INTO users (email, password_hash, settings) VALUES ($1, $2, $3) RETURNING id, email', [email, passwordHash, {}]);
        const user = result.rows[0];
        
        // Gera o token JWT
        const accessToken = jwt.sign({ id: user.id, email: user.email }, JWT_SECRET, { expiresIn: '7d' });
        res.status(201).json({ user, accessToken });

    } catch (err) {
        if (err.code === '23505') return res.status(409).json({ message: 'Este e-mail j√° est√° em uso.' });
        console.error(err);
        res.status(500).json({ message: 'Erro interno do servidor.' });
    }
});

app.post('/api/login', async (req, res) => {
    const { email, password } = req.body;
    if (!email || !password) return res.status(400).json({ message: 'E-mail e senha s√£o obrigat√≥rios.' });
    try {
        const result = await pool.query('SELECT * FROM users WHERE email = $1', [email]);
        const user = result.rows[0];
        if (user && user.password_hash && await bcrypt.compare(password, user.password_hash)) {
            const accessToken = jwt.sign({ id: user.id, email: user.email }, JWT_SECRET, { expiresIn: '7d' });
            res.json({ user: {id: user.id, email: user.email}, accessToken });
        } else {
            res.status(401).json({ message: 'Credenciais inv√°lidas.' });
        }
    } catch (err) {
        console.error(err);
        res.status(500).json({ message: 'Erro interno do servidor.' });
    }
});

// [NOVA ROTA] Login com Google
app.post('/api/google-login', async (req, res) => {
    const { credential } = req.body;
    try {
        const ticket = await client.verifyIdToken({
            idToken: credential,
            audience: GOOGLE_CLIENT_ID,
        });
        const payload = ticket.getPayload();
        const { sub: google_id, email, name } = payload;

        let result = await pool.query('SELECT * FROM users WHERE google_id = $1', [google_id]);
        let user = result.rows[0];

        if (!user) {
            // Se n√£o encontrou por google_id, tenta por e-mail (para vincular contas)
            result = await pool.query('SELECT * FROM users WHERE email = $1', [email]);
            user = result.rows[0];

            if (user) {
                // Vincula a conta existente
                await pool.query('UPDATE users SET google_id = $1, name = $2 WHERE email = $3', [google_id, name, email]);
            } else {
                // Cria um novo usu√°rio
                result = await pool.query(
                    'INSERT INTO users (email, name, google_id, settings) VALUES ($1, $2, $3, $4) RETURNING *',
                    [email, name, google_id, {}]
                );
                user = result.rows[0];
            }
        }
        
        const accessToken = jwt.sign({ id: user.id, email: user.email }, JWT_SECRET, { expiresIn: '7d' });
        res.json({ user: {id: user.id, email: user.email, name: user.name}, accessToken });

    } catch (error) {
        console.error("Erro no login com Google:", error);
        res.status(500).json({ message: "Falha na autentica√ß√£o com o Google." });
    }
});


app.get('/api/settings/:userId', authenticateToken, async (req, res) => {
    // Verifica se o usu√°rio autenticado √© o mesmo da requisi√ß√£o
    if (req.user.id.toString() !== req.params.userId) return res.sendStatus(403);
    
    const { userId } = req.params;
    try {
        const result = await pool.query('SELECT settings FROM users WHERE id = $1', [userId]);
        if (result.rows.length > 0) {
            res.json(result.rows[0].settings || {});
        } else {
            res.status(404).json({ message: 'Usu√°rio n√£o encontrado.' });
        }
    } catch (err) {
        console.error(err);
        res.status(500).json({ message: 'Erro interno do servidor.' });
    }
});

app.post('/api/settings/:userId', authenticateToken, async (req, res) => {
    if (req.user.id.toString() !== req.params.userId) return res.sendStatus(403);

    const { userId } = req.params;
    const { settings } = req.body;
    try {
        const result = await pool.query('UPDATE users SET settings = $1 WHERE id = $2 RETURNING id', [settings, userId]);
        if (result.rowCount > 0) {
            res.json({ message: 'Configura√ß√µes salvas com sucesso!' });
        } else {
            res.status(404).json({ message: 'Usu√°rio n√£o encontrado.' });
        }
    } catch (err) {
        console.error(err);
        res.status(500).json({ message: 'Erro interno do servidor.' });
    }
});

// 6. Rotas da API (YouTube Data, Google Trends & OpenRouter) - AGORA PROTEGIDAS
const getGoogleApiKey = async (userId) => {
    const result = await pool.query('SELECT settings FROM users WHERE id = $1', [userId]);
    if (result.rows.length > 0 && result.rows[0].settings) {
        return result.rows[0].settings.google_api;
    }
    return null;
};

app.get('/api/video-details/:videoId', authenticateToken, async (req, res) => {
    const { videoId } = req.params;
    const userId = req.user.id; // Pega o ID do usu√°rio autenticado pelo token

    try {
        const apiKey = await getGoogleApiKey(userId);
        if (!apiKey) return res.status(400).json({ message: "Chave da API do Google n√£o configurada." });

        const youtube = google.youtube({ version: 'v3', auth: apiKey });
        const response = await youtube.videos.list({ part: 'snippet,statistics', id: videoId });

        if (response.data.items.length === 0) {
            return res.status(404).json({ message: 'V√≠deo n√£o encontrado.' });
        }
        const video = response.data.items[0];
        res.json({
            title: video.snippet.title,
            description: video.snippet.description,
            tags: video.snippet.tags || [],
            detectedLanguage: video.snippet.defaultAudioLanguage || video.snippet.defaultLanguage || 'pt'
        });
    } catch (error) {
        console.error("Erro na API do YouTube:", error.message);
        res.status(500).json({ message: "Erro ao buscar dados do v√≠deo." });
    }
});

// ... (Restante das suas rotas, como /api/youtube-stats, etc. devem ter `authenticateToken` como middleware)
// Exemplo: app.get('/api/youtube-stats/:channelId', authenticateToken, async (req, res) => { ... });
// Adicione `authenticateToken` a todas as rotas que precisam de um usu√°rio logado.

// 7. Rota Gen√©rica (Catch-all) para servir o index.html
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// 8. Inicializa√ß√£o do Servidor
app.listen(PORT, () => {
  console.log(`Servidor rodando na porta ${PORT}`);
  initializeDb();
});